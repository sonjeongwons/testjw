ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ â€“ FunctionMetricService í´ë˜ìŠ¤
ì•ˆë…•í•˜ì„¸ìš” íŒ€ì› ì—¬ëŸ¬ë¶„! ğŸ˜Š
ì½”ë“œ ì‘ì„±í•˜ì‹œëŠë¼ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤. ì „ì²´ì ìœ¼ë¡œ ê¸°ëŠ¥ì´ ì˜ êµ¬í˜„ë˜ì–´ ìˆê³ , Prometheusì™€ í†µì‹ í•˜ë©° ë§¤íŠ¸ë¦­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” êµ¬ì¡°ê°€ ëª…í™•í•©ë‹ˆë‹¤. ë‹¤ë§Œ, ì½”ë“œë¥¼ ì¡°ê¸ˆ ë” ê°„ê²°í•˜ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ë¦¬íŒ©í† ë§ ì•„ì´ë””ì–´ë¥¼ ê³µìœ ë“œë¦¬ë ¤ê³  í•©ë‹ˆë‹¤. ì´ ì•„ì´ë””ì–´ë“¤ì€ ê°€ë…ì„±ì„ ë†’ì´ê³ , ì¤‘ë³µì„ ì¤„ì´ë©°, ì¥ê¸°ì ì¸ í™•ì¥ì„±ì„ ê³ ë ¤í•œ ê²ƒë“¤ì´ë‹ˆ ì°¸ê³  ë¶€íƒë“œë ¤ìš”!

1. ì¤‘ë³µëœ Prometheus ì¿¼ë¦¬ ìƒì„± ë©”ì„œë“œ ë¦¬íŒ©í† ë§
ë¬¸ì œì :
generateQueryForRequestCount, generateQueryForRequestLatency ë“± ê°œë³„ ë©”ì„œë“œë“¤ì´ ìœ ì‚¬í•œ íŒ¨í„´ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ ì¤‘ë³µ ì½”ë“œê°€ ë§ìŠµë‹ˆë‹¤.
ë§¤íŠ¸ë¦­ ìœ í˜•ë³„ë¡œ ìƒˆë¡œìš´ ì¿¼ë¦¬ê°€ í•„ìš”í•  ë•Œ ë©”ì„œë“œ ì¶”ê°€ê°€ ë°˜ë³µë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
ê°œì„  ì•„ì´ë””ì–´:
ì¿¼ë¦¬ ìƒì„± ë¡œì§ì„ í•˜ë‚˜ì˜ ê³µí†µ ë©”ì„œë“œë¡œ í†µí•©í•˜ì—¬ ì¤‘ë³µ ì œê±°.
ë§¤íŠ¸ë¦­ ìœ í˜•, ì„œë¹„ìŠ¤ ì´ë¦„, ì‹œê°„ ë²”ìœ„ ë“± í•„ìš”í•œ ê°’ì„ ë™ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë„ë¡ ê°œì„ .
java
ì½”ë“œ ë³µì‚¬
public String generatePrometheusQuery(String metricType, String functionName, String timeRange, String queryTiming) {
    switch (metricType) {
        case "requestCount":
            return String.format("query=sum(rate(activator_request_count{service_name=\"%s\"}[%sm]))*60*%s&time=%s", functionName, timeRange, timeRange, queryTiming);
        case "requestLatency":
            return String.format("query=(sum(rate(activator_request_latencies_sum{service_name=\"%s\",response_code=\"200\"}[%sm])) / sum(rate(activator_request_latencies_count{service_name=\"%s\",response_code=\"200\"}[%sm])))/1000&time=%s",
                functionName, timeRange, functionName, timeRange, queryTiming);
        case "functionMemory":
            return String.format("query=avg(avg_over_time(container_memory_working_set_bytes{pod=~\"%s-.*\", container=\"user-container\"}[%sm]))/1024&time=%s", functionName, timeRange, queryTiming);
        default:
            throw new IllegalArgumentException("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë§¤íŠ¸ë¦­ ìœ í˜•: " + metricType);
    }
}
ë³€ê²½ ì´ìœ :
ì¤‘ë³µëœ ì¿¼ë¦¬ ìƒì„± ë©”ì„œë“œ ì œê±°ë¡œ ì½”ë“œê°€ ê°„ê²°í•´ì§‘ë‹ˆë‹¤.
ìƒˆë¡œìš´ ë§¤íŠ¸ë¦­ ìœ í˜•ì´ ì¶”ê°€ë  ë•Œë„ ì½”ë“œ ìˆ˜ì •ì´ ìµœì†Œí™”ë©ë‹ˆë‹¤.
2. HTTP ìš”ì²­ ì²˜ë¦¬ ë¡œì§ ë¶„ë¦¬
ë¬¸ì œì :
getPrometheusMetric ë©”ì„œë“œê°€ HTTP ìš”ì²­ê³¼ ì‘ë‹µ ì²˜ë¦¬ ë¡œì§ì„ ëª¨ë‘ í¬í•¨í•˜ê³  ìˆì–´ ê°€ë…ì„±ì´ ë–¨ì–´ì§€ê³  í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.
HTTP ìš”ì²­ ë¡œì§ì´ ë‹¤ë¥¸ ê³³ì—ì„œë„ ì¬ì‚¬ìš©ë  ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ, ì´ë¥¼ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
ê°œì„  ì•„ì´ë””ì–´:
HTTP ìš”ì²­ ì²˜ë¦¬ë¥¼ ì „ë‹´í•˜ëŠ” ìœ í‹¸ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ì½”ë“œë¥¼ ëª¨ë“ˆí™”.
java
ì½”ë“œ ë³µì‚¬
public class HttpClientUtil {
    public static String sendPostRequest(String url, String query, int timeout) throws IOException {
        HttpURLConnection connection = (HttpURLConnection) new URL(url).openConnection();
        connection.setConnectTimeout(timeout);
        connection.setReadTimeout(timeout);
        connection.setRequestMethod("POST");
        connection.setDoOutput(true);

        try (DataOutputStream outputStream = new DataOutputStream(connection.getOutputStream())) {
            outputStream.writeBytes(query);
        }

        if (connection.getResponseCode() == HttpURLConnection.HTTP_OK) {
            try (BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = bufferedReader.readLine()) != null) {
                    response.append(line);
                }
                return response.toString();
            }
        } else {
            throw new IOException("HTTP ìš”ì²­ ì‹¤íŒ¨: " + connection.getResponseCode());
        }
    }
}
ë³€ê²½ ì´ìœ :
HTTP ìš”ì²­ ì²˜ë¦¬ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë¶„ë¦¬í•´ ê°€ë…ì„± í–¥ìƒ.
ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œë„ HTTP ìš”ì²­ì„ ì‰½ê²Œ ì¬ì‚¬ìš© ê°€ëŠ¥.
3. ë§¤íŠ¸ë¦­ ì²˜ë¦¬ ë¡œì§ ë‹¨ìˆœí™”
ë¬¸ì œì :
getEachMetric ë©”ì„œë“œì—ì„œ ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ ë¡œì§ì´ ë°˜ë³µë˜ê³  ìˆì–´ ì½”ë“œê°€ ì¥í™©í•©ë‹ˆë‹¤.
ìƒˆë¡œìš´ ë§¤íŠ¸ë¦­ì´ ì¶”ê°€ë  ê²½ìš° ìˆ˜ì •í•  ë¶€ë¶„ì´ ë§ì•„ì§ˆ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.
ê°œì„  ì•„ì´ë””ì–´:
ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ ë¡œì§ì„ ê³µí†µ ë©”ì„œë“œë¡œ ì¶”ì¶œí•˜ì—¬ ì¬ì‚¬ìš©ì„±ì„ ë†’ì…ë‹ˆë‹¤.
java
ì½”ë“œ ë³µì‚¬
private void processMetric(String metricType, URL url, String functionName, String queryTiming, String timeRange, Gson gson, List<FunctionMetricElementsListDTO> metricList) throws IOException {
    String query = generatePrometheusQuery(metricType, functionName, timeRange, queryTiming);
    String response = HttpClientUtil.sendPostRequest(url.toString(), query, timeOutValue);
    metricList.add(gson.fromJson(response, FunctionMetricElementsListDTO.class));
}

private void getEachMetric(URL url, String functionName, String queryTiming, Gson g, List<FunctionMetricElementsListDTO> requestCountList, List<FunctionMetricElementsListDTO> requestLatencyList, List<FunctionMetricElementsListDTO> functionMemoryList, List<FunctionMetricElementsListDTO> actualPodsList, List<FunctionMetricElementsListDTO> successCountList, List<FunctionMetricElementsListDTO> failCountList, String timeRange) throws IOException {
    processMetric("requestCount", url, functionName, queryTiming, timeRange, g, requestCountList);
    processMetric("requestLatency", url, functionName, queryTiming, timeRange, g, requestLatencyList);
    processMetric("functionMemory", url, functionName, queryTiming, timeRange, g, functionMemoryList);
    processMetric("actualPods", url, functionName, queryTiming, timeRange, g, actualPodsList);
    processMetric("successCount", url, functionName, queryTiming, timeRange, g, successCountList);
    processMetric("failCount", url, functionName, queryTiming, timeRange, g, failCountList);
}
ë³€ê²½ ì´ìœ :
ì¤‘ë³µ ë¡œì§ ì œê±°ë¡œ ì½”ë“œê°€ ê°„ê²°í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
ìƒˆë¡œìš´ ë§¤íŠ¸ë¦­ ì¶”ê°€ ì‹œ ìˆ˜ì •í•´ì•¼ í•  ì½”ë“œ ì–‘ì´ ì¤„ì–´ë“­ë‹ˆë‹¤.
4. ì˜ëª»ëœ ë§¤íŠ¸ë¦­ ê°’ ì²˜ë¦¬ ë¡œì§ ê°œì„ 
ë¬¸ì œì :
RequestLatencyMetricInvalidValueHandling ë©”ì„œë“œì˜ ì¡°ê±´ë¬¸ì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆì–´ ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë µìŠµë‹ˆë‹¤.
ê°œì„  ì•„ì´ë””ì–´:
ì˜ëª»ëœ ê°’ì„ ê´€ë¦¬í•˜ëŠ” ìƒìˆ˜ë‚˜ ë¦¬ìŠ¤íŠ¸ë¡œ ë¶„ë¦¬í•˜ì—¬ ê°€ë…ì„±ì„ ê°œì„ .
java
ì½”ë“œ ë³µì‚¬
private static final List<String> INVALID_VALUES = Arrays.asList("NaN", "Inf", "-Inf", "+Inf");

private void handleInvalidMetricValues(FunctionMetricElementsListDTO element) {
    if (!element.getData().getResult().isEmpty()) {
        String metricValue = element.getData().getResult().get(0).getValue().get(1);
        if (INVALID_VALUES.contains(metricValue)) {
            element.getData().getResult().get(0).getValue().set(1, "0");
        }
    }
}
ë³€ê²½ ì´ìœ :
ì¡°ê±´ë¬¸ì´ ê°„ê²°í•´ì§€ê³ , ì˜ëª»ëœ ê°’ ëª©ë¡ ê´€ë¦¬ê°€ ì‰¬ì›Œì§‘ë‹ˆë‹¤.
í–¥í›„ ìƒˆë¡œìš´ ì˜ëª»ëœ ê°’ì´ ì¶”ê°€ë˜ë”ë¼ë„ ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•©ë‹ˆë‹¤.
5. ì¡°ê±´ë¬¸ ë‹¨ìˆœí™”
ë¬¸ì œì :
getMetricList ë©”ì„œë“œì—ì„œ ì‹œê°„ ì¡°ê±´ì— ë”°ë¼ ì¤‘ì²©ëœ ì¡°ê±´ë¬¸ì´ ë§ì•„ ê°€ë…ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.
ê°œì„  ì•„ì´ë””ì–´:
ê³µí†µ ë¡œì§ì„ ì¶”ì¶œí•˜ê³ , ì‹œê°„ ë²”ìœ„ ì²˜ë¦¬ ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤.
java
ì½”ë“œ ë³µì‚¬
private void processTimeRange(String time, Calendar cal, String timeUnit, int iterations, URL url, String functionName, Gson g, List<FunctionMetricElementsListDTO> requestCountList, List<FunctionMetricElementsListDTO> requestLatencyList, List<FunctionMetricElementsListDTO> functionMemoryList, List<FunctionMetricElementsListDTO> actualPodsList, List<FunctionMetricElementsListDTO> successCountList, List<FunctionMetricElementsListDTO> failCountList) throws IOException {
    for (int i = 0; i < iterations; i++) {
        String queryTiming = String.valueOf(new Date(cal.getTimeInMillis()).getTime() / 1000L);
        getEachMetric(url, functionName, queryTiming, g, requestCountList, requestLatencyList, functionMemoryList, actualPodsList, successCountList, failCountList, timeUnit);
        cal.add(Calendar.MINUTE, -Integer.parseInt(timeUnit));
    }
}
ì´í‰
ì‘ì„±í•´ì£¼ì‹  ì½”ë“œëŠ” Prometheusì™€ì˜ í†µì‹  ë° ë§¤íŠ¸ë¦­ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ëŠ” êµ¬ì¡°ë¡œ ì˜ ì§œì—¬ ìˆìŠµë‹ˆë‹¤. ìœ„ ê°œì„ ì‚¬í•­ì„ ë°˜ì˜í•˜ë©´ ì½”ë“œì˜ ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, í™•ì¥ì„±ì´ í¬ê²Œ í–¥ìƒë  ê²ƒìœ¼ë¡œ ê¸°ëŒ€ë©ë‹ˆë‹¤. íŠ¹íˆ, ì¤‘ë³µ ì œê±°ì™€ ê³µí†µí™”ëŠ” ì¥ê¸°ì ì¸ ì½”ë“œ í’ˆì§ˆ ìœ ì§€ì— í° ë„ì›€ì´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ê³ ìƒ ë§ìœ¼ì…¨ê³ , í•¨ê»˜ ë” ì¢‹ì€ ì½”ë“œë¡œ ê°œì„ í•´ ë‚˜ê°€ìš”! ğŸ’ªğŸ˜Š
