// FileDto.java
package com.example.demo.dto;

import lombok.*;
import javax.validation.constraints.NotBlank;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class FileDto {

    @NotBlank(message = "파일명을 입력해주세요")
    private String fileName;

    @NotBlank(message = "파일 데이터를 입력해주세요")
    private String fileData;

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Builder
    public static class Request {

        @NotBlank(message = "파일명을 입력해주세요")
        private String fileName;

        @NotBlank(message = "파일 데이터를 입력해주세요")
        private String fileData;
    }

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Builder
    public static class Response {

        private String fileName;

        private int returnCode;

        private String message;
    }
}

// V3ScannerController.java
package com.example.demo.controller;

import com.example.demo.dto.FileDto;
import com.example.demo.service.V3ScannerService;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@Slf4j
@Tag(name = "파일 검사 API", description = "파일 검사 API를 통해 파일의 악성 여부를 확인합니다.")
@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/scanner")
public class V3ScannerController {

    private final V3ScannerService v3ScannerService;

    @PostMapping("/scan")
    @Operation(summary = "파일 검사", description = "파일의 악성 여부를 검사합니다.")
    public ResponseEntity<FileDto.Response> scanFile(
            @RequestHeader("X-CVC-API-KEY") String apiKey,
            @Valid @RequestBody FileDto.Request fileDtoRequest) {
        log.info("File scan requested. Filename: {}, API Key: {}", fileDtoRequest.getFileName(), apiKey);
        if (!v3ScannerService.validateApiKey(apiKey)) {
            log.warn("Unauthorized access attempt with API Key: {}", apiKey);
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                    FileDto.Response.builder()
                            .fileName(fileDtoRequest.getFileName())
                            .returnCode(HttpStatus.UNAUTHORIZED.value())
                            .message("Unauthorized: Invalid API Key")
                            .build()
            );
        }
        FileDto.Response response = v3ScannerService.scanFile(fileDtoRequest);
        return ResponseEntity.status(HttpStatus.OK).body(response);
    }

    @GetMapping("/status")
    @Operation(summary = "API 상태 확인", description = "API의 상태를 확인합니다.")
    public ResponseEntity<String> getStatus() {
        log.info("API status requested.");
        return ResponseEntity.ok("API is running.");
    }
}

// V3ScannerService.java
package com.example.demo.service;

import com.example.demo.dto.FileDto;
import com.ahnlab.v3engine.V3Const;
import com.ahnlab.v3engine.V3Scanner;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.FileOutputStream;
import java.util.Base64;

@Service
public class V3ScannerService {

    @Value("${api.key}")
    private String validApiKey;

    public boolean validateApiKey(String apiKey) {
        return validApiKey.equals(apiKey);
    }

    public FileDto.Response scanFile(FileDto.Request fileDtoRequest) {
        try {
            // Decode Base64 file data and save temporarily
            byte[] fileData = Base64.getDecoder().decode(fileDtoRequest.getFileData());
            File tempFile = File.createTempFile("scan_", fileDtoRequest.getFileName());
            try (FileOutputStream fos = new FileOutputStream(tempFile)) {
                fos.write(fileData);
            }

            // Perform scan
            int ret = V3Scanner.scanFile(tempFile.getAbsolutePath());
            String message = getMessageForReturnCode(ret);

            // Delete temporary file
            tempFile.delete();

            return FileDto.Response.builder()
                    .fileName(fileDtoRequest.getFileName())
                    .returnCode(ret)
                    .message(message)
                    .build();
        } catch (Exception e) {
            return FileDto.Response.builder()
                    .fileName(fileDtoRequest.getFileName())
                    .returnCode(-1)
                    .message("File processing failed: " + e.getMessage())
                    .build();
        }
    }

    private String getMessageForReturnCode(int ret) {
        switch (ret) {
            case V3Const.RET_AUTH_FAILED:
                return "인증 실패";
            case V3Const.RET_CLIENT_TIMEOUT:
                return "검사 요청 클라이언트 TIMEOUT";
            case V3Const.RET_NETWORK_ERROR:
                return "네트워크 장애";
            case V3Const.RET_CLIENT_FAIL:
                return "검사 요청 클라이언트 오류";
            case V3Const.RET_CANNOT_SCAN:
                return "검사 실패";
            case V3Const.RET_NO_MALWARE:
                return "악성코드 없음";
            case V3Const.RET_MALWARE_FOUND:
                return "악성코드 발견";
            case V3Const.RET_CLEAN_MODIFY_SUCCESS:
                return "수정 치료 성공";
            case V3Const.RET_CLEAN_MODIFY_FAIL:
                return "수정 치료 실패(삭제 권고)";
            case V3Const.RET_CLEAN_DEL_SUCCESS:
                return "삭제 치료 성공";
            case V3Const.RET_CLEAN_DEL_FAIL:
                return "삭제 치료 실패(삭제 권고)";
            case V3Const.RET_CLEAN_DEL_FAIL_BYCONF:
                return "삭제 치료 실패(검사 서버 옵션)";
            default:
                return "알 수 없음";
        }
    }
}
