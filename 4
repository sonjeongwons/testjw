âœ… API Gateway, SQSë„ ì‚­ì œ ë°©ì§€ íƒœê·¸ ì ìš© ê°€ëŠ¥ ì—¬ë¶€

âœ… API Gateway, SQS ëª¨ë‘ íƒœê·¸(Tag) ê¸°ë°˜ìœ¼ë¡œ ì‚­ì œ ë°©ì§€ê°€ ê°€ëŠ¥í•´!
âœ… resourcegroupstaggingapië¥¼ ì‚¬ìš©í•˜ë©´ API Gatewayì™€ SQSì˜ íƒœê·¸ë¥¼ ì‰½ê²Œ ì¡°íšŒí•  ìˆ˜ ìˆì–´.
âœ… ì‚­ì œ ë°©ì§€ íƒœê·¸ (NoDelete=True)ê°€ ì„¤ì •ëœ ê²½ìš° ì‚­ì œí•˜ì§€ ì•Šë„ë¡ ì½”ë“œ ìˆ˜ì • ê°€ëŠ¥


---

ğŸš€ API Gateway, SQS ì‚­ì œ ë°©ì§€ íƒœê·¸ ì ìš© ì½”ë“œ ì¶”ê°€

ğŸ“Œ ìµœì í™”ëœ ì „ì²´ ì½”ë“œ

import boto3

# ì‚­ì œ ë°©ì§€ íƒœê·¸ ì„¤ì • (ì˜ˆ: "NoDelete=True"ê°€ ì„¤ì •ëœ ë¦¬ì†ŒìŠ¤ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ)
PROTECTED_TAG_KEY = "NoDelete"
PROTECTED_TAG_VALUE = "True"

# CleanupLambda ì •ë³´
CLEANUP_LAMBDA_NAME = "CleanupLambda"
CLEANUP_LAMBDA_REGION = "ap-northeast-2"  # ì„œìš¸ ë¦¬ì „

# ëª¨ë“  ë¦¬ì „ ì¡°íšŒ
regions = [region['RegionName'] for region in boto3.client('ec2').describe_regions()['Regions']]

def has_protected_tag(resource_arn, session):
    """ íŠ¹ì • ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œ ë°©ì§€ íƒœê·¸ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸ """
    tag_client = session.client('resourcegroupstaggingapi')
    try:
        response = tag_client.get_resources(ResourceARNList=[resource_arn])
        for tag_mapping in response.get('ResourceTagMappingList', []):
            for tag in tag_mapping.get('Tags', []):
                if tag['Key'] == PROTECTED_TAG_KEY and tag['Value'].lower() == PROTECTED_TAG_VALUE.lower():
                    return True
    except Exception as e:
        print(f"íƒœê·¸ ì¡°íšŒ ì‹¤íŒ¨: {resource_arn}, {str(e)}")
    return False

def delete_or_stop_ec2_instances(region, session):
    """ EC2 ì‚­ì œ ë˜ëŠ” ì „ì› ë„ê¸° (íƒœê·¸ í™•ì¸ í›„ ì²˜ë¦¬) """
    ec2 = session.client('ec2')
    instances = ec2.describe_instances(Filters=[{'Name': 'instance-state-name', 'Values': ['running', 'stopped']}])
    
    instance_ids_to_terminate = []
    instance_ids_to_stop = []

    for r in instances["Reservations"]:
        for i in r["Instances"]:
            instance_id = i["InstanceId"]
            instance_arn = f"arn:aws:ec2:{region}:{i['OwnerId']}:instance/{instance_id}"
            
            if has_protected_tag(instance_arn, session):
                if i["State"]["Name"] == "running":  # ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° ì „ì› ë„ê¸°
                    instance_ids_to_stop.append(instance_id)
                print(f"[{region}] EC2 ì¸ìŠ¤í„´ìŠ¤ ì „ì› ë„ê¸°: {instance_id}")
            else:
                instance_ids_to_terminate.append(instance_id)

    if instance_ids_to_stop:
        ec2.stop_instances(InstanceIds=instance_ids_to_stop)
        print(f"[{region}] EC2 ì¸ìŠ¤í„´ìŠ¤ ì „ì› ë„ê¸° ì™„ë£Œ: {instance_ids_to_stop}")

    if instance_ids_to_terminate:
        ec2.terminate_instances(InstanceIds=instance_ids_to_terminate)
        print(f"[{region}] EC2 ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì™„ë£Œ: {instance_ids_to_terminate}")

def delete_api_gateways(region, session):
    """ API Gateway ì‚­ì œ (ì‚­ì œ ë°©ì§€ íƒœê·¸ í™•ì¸) """
    apigw = session.client('apigateway')
    apis = apigw.get_rest_apis().get("items", [])
    for api in apis:
        api_arn = f"arn:aws:apigateway:{region}::/restapis/{api['id']}"
        
        if has_protected_tag(api_arn, session):
            print(f"[{region}] API Gateway ì‚­ì œ ì œì™¸ (ë³´í˜¸ë¨): {api['name']}")
            continue
        
        try:
            apigw.delete_rest_api(restApiId=api["id"])
            print(f"[{region}] API Gateway ì‚­ì œ ì™„ë£Œ: {api['name']}")
        except Exception as e:
            print(f"[{region}] API Gateway ì‚­ì œ ì‹¤íŒ¨: {api['name']}, {str(e)}")

def delete_sqs_queues(region, session):
    """ SQS í ì‚­ì œ (ì‚­ì œ ë°©ì§€ íƒœê·¸ í™•ì¸) """
    sqs = session.client('sqs')
    queues = sqs.list_queues().get("QueueUrls", [])
    
    for queue_url in queues:
        queue_arn = f"arn:aws:sqs:{region}:{queue_url.split('/')[-2]}:{queue_url.split('/')[-1]}"
        
        if has_protected_tag(queue_arn, session):
            print(f"[{region}] SQS í ì‚­ì œ ì œì™¸ (ë³´í˜¸ë¨): {queue_url}")
            continue
        
        try:
            sqs.delete_queue(QueueUrl=queue_url)
            print(f"[{region}] SQS í ì‚­ì œ ì™„ë£Œ: {queue_url}")
        except Exception as e:
            print(f"[{region}] SQS í ì‚­ì œ ì‹¤íŒ¨: {queue_url}, {str(e)}")

def delete_resources(region):
    session = boto3.session.Session(region_name=region)

    delete_or_stop_ec2_instances(region, session)  # EC2 ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ë˜ëŠ” ì „ì› ë„ê¸°
    delete_api_gateways(region, session)  # API Gateway ì‚­ì œ
    delete_sqs_queues(region, session)  # SQS ì‚­ì œ

    print(f"[{region}] ëª¨ë“  ê³¼ê¸ˆ ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì™„ë£Œ")

# ëª¨ë“  ë¦¬ì „ì— ëŒ€í•´ ì‹¤í–‰
for region in regions:
    delete_resources(region)


---

ğŸš€ ê°œì„ ëœ ì 

âœ… API Gatewayì— ì‚­ì œ ë°©ì§€ íƒœê·¸(NoDelete=True) ì ìš© ê°€ëŠ¥
âœ… SQSì—ë„ ì‚­ì œ ë°©ì§€ íƒœê·¸(NoDelete=True) ì ìš© ê°€ëŠ¥
âœ… EC2 ì‚­ì œ ë°©ì§€ íƒœê·¸ê°€ ìˆëŠ” ê²½ìš°, ì‚­ì œ ëŒ€ì‹  ì „ì› ë”
âœ… Lambda ì‹¤í–‰ ì‹œ, ì‚­ì œëœ ë¦¬ì†ŒìŠ¤ì™€ ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ë¥¼ CloudWatch ë¡œê·¸ë¡œ í™•ì¸ ê°€ëŠ¥


---

ğŸš€ ê¸°ëŒ€ íš¨ê³¼

âœ… ë¹„ìš© ì ˆê°í•˜ë©´ì„œë„ ë³´í˜¸í•´ì•¼ í•  ì¤‘ìš”í•œ ë¦¬ì†ŒìŠ¤ëŠ” ìœ ì§€ ê°€ëŠ¥
âœ… EC2ê°€ ì‚­ì œë˜ì§€ ì•Šë”ë¼ë„ ë¶ˆí•„ìš”í•œ ê³¼ê¸ˆ ë°©ì§€ë¥¼ ìœ„í•´ ìë™ìœ¼ë¡œ ì „ì› êº¼ì§
âœ… API Gateway ë° SQSë„ íƒœê·¸ ê¸°ë°˜ ì‚­ì œ ë°©ì§€ ì ìš© ê°€ëŠ¥
âœ… Lambda ì‹¤í–‰ ì‹œ, ì‚­ì œëœ ë¦¬ì†ŒìŠ¤ì™€ ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ë¥¼ CloudWatch ë¡œê·¸ë¡œ í™•ì¸ ê°€ëŠ¥

ì´ì œ ì‹¤í–‰í•´ë³´ê³  ê²°ê³¼ ì•Œë ¤ì¤˜! ğŸš€ğŸ˜

