@Transactional
public FunctionDTO.Response registerFunction(FunctionDTO.Register reqDto) throws IOException, ParseException {
    validateFunctionRequest(reqDto);

    if (isFunctionExists(reqDto.getFunctionKey(), reqDto.getDisplayName(), reqDto.getProjectId())) {
        throw new FunctionAlreadyExistsException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‘ì…˜ í‚¤ ë˜ëŠ” í‘ì…˜ëª…ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }

    reqDto.setName(generateFunctionName());
    reqDto.setFunctionStatus(TypeEnums.FunctionStatus.NOT_READY);

    if (!reqDto.getRuntime().startsWith("Java")) {
        reqDto.setContent(generateBaseCode(reqDto));
    }

    Function function = functionRepository.save(Function.register(reqDto));
    initializeFunction(function, reqDto);

    return function.toDto();
}

private void validateFunctionRequest(FunctionDTO.Register reqDto) {
    if (StringUtils.isAnyEmpty(reqDto.getFunctionKey(), reqDto.getProjectId(), reqDto.getUserId(), reqDto.getEndPointType(), reqDto.getRuntime())) {
        throw new InvalidFunctionRequestException("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

@Transactional
public FunctionDTO.Response registerFunctionCode(FunctionDTO.Register reqDto, String functionKey) throws IOException, ParseException {
    Function function = getFunctionByKey(functionKey);
    function.updateContent(reqDto.getContent());

    if (shouldDeployFunction(function)) {
        deployFunction(function);
    }

    return function.toDto();
}

@Transactional(readOnly = true)
public FunctionDTO.Response searchFunction(String functionKey) {
    Function function = getFunctionByKey(functionKey);
    FunctionDTO.Response output = AppUtil.getMapper().map(function, FunctionDTO.Response.class);
    output.setEndPointUrls(UrlUtil.generateUrl(function.getName(), function.getRegion(), "none"));

    Trigger trigger = triggerRepository.findByFunction(function).orElse(null);
    output.setTriggerType(trigger != null ? trigger.getTriggerType() : "unknown");
    output.setTriggerConnectedYn(trigger != null ? trigger.getTriggerConnectedYn() : "N");

    return output;
}

private Function getFunctionByKey(String functionKey) {
    return functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new FunctionNotFoundException("í‘ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. FunctionKey: " + functionKey));
}

private boolean shouldDeployFunction(Function function) {
    return function.isReady();
}

private void deployFunction(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
    knativeService.callIstioAndKnative(function);
}

@Transactional
public void deleteFunction(String functionKey) {
    Function function = getFunctionByKey(functionKey);
    if (function.isReady() || function.isDeploying()) {
        kn.services().inNamespace(function.getName()).withName(function.getName()).delete();
        istioCallService.deleteIstioPolicy(function.getName());
    }

    deleteRelatedResources(function);
    function.modifyDelYn();
    functionRepository.save(function);
}

private void deleteRelatedResources(Function function) {
    allowIpRepository.deleteAll(allowIpRepository.findByFunction(function));
    functionEnvironmentRepository.deleteAll(functionEnvironmentRepository.findByFunction(function));
    keyManagerRepository.findByFunctionAndDelYn(function, "N").ifPresent(keyManagerRepository::delete);
    sourceFileRepository.findByFunction(function).ifPresent(sourceFileRepository::delete);
}

@Transactional
public void updateEnvironment(List<FunctionEnvironmentDTO.Register> reqDto, String functionKey) {
    Function function = getFunctionByKey(functionKey);
    reqDto.forEach(dto -> saveEnvironment(dto, function));
}

private void saveEnvironment(FunctionEnvironmentDTO.Register dto, Function function) {
    dto.setFunctionSeq(function.getFunctionSeq());
    functionEnvironmentRepository.save(FunctionEnvironment.register(dto));
}




ğŸ”¹ PR 2: ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„  ë° ì„œë¹„ìŠ¤ ê³„ì¸µ ì •ë¦¬ - í™•ì¥ëœ ì¢…í•© ìš”ì•½
PR 2ì—ì„œëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ì¼ê´€ì„± ê°•í™”, ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°, ì„œë¹„ìŠ¤ ê³„ì¸µ ì •ë¦¬ë¥¼ í†µí•´ ì½”ë“œì˜ í’ˆì§ˆì„ ë”ìš± í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤.
ì¶”ê°€ì ìœ¼ë¡œ ë‹¤ì–‘í•œ ë©”ì†Œë“œì—ì„œë„ í´ë¦° ì½”ë“œ ì›ì¹™ ë° ë¦¬íŒ©í† ë§ ê¸°ë²•ì„ ì ìš©í•˜ì—¬ ë”ìš± ì™„ë²½í•œ ê°œì„ ì´ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤.

ğŸ“Œ PR 2ì˜ ì£¼ìš” ê°œì„  ì‚¬í•­
1ï¸âƒ£ ì¼ê´€ëœ ì˜ˆì™¸ ì²˜ë¦¬ ì ìš©
ğŸ”¹ ë¬¸ì œì 
ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” RuntimeExceptionì„ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ ì˜ˆì™¸ì˜ ì˜ë¯¸ê°€ ë¶ˆëª…í™•.
"í‘ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." ë“±ì˜ ì˜ˆì™¸ ë©”ì‹œì§€ê°€ ì¼ê´€ë˜ì§€ ì•Šê±°ë‚˜ ì¶©ë¶„í•œ ì •ë³´ê°€ ë¶€ì¡±.
null ì²´í¬ë¥¼ ì§ì ‘ ìˆ˜í–‰í•˜ì—¬ ì˜ˆì™¸ ë°œìƒì„ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í–ˆìŒ.
âœ… ê°œì„  ì‚¬í•­
ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤(FunctionNotFoundException, FunctionAlreadyExistsException, InvalidFunctionRequestException) ì¶”ê°€í•˜ì—¬ ë” ëª…í™•í•œ ì˜ë¯¸ ì „ë‹¬.
Optional.orElseThrow() í™œìš©í•˜ì—¬ ë¶ˆí•„ìš”í•œ null ì²´í¬ ì œê±° ë° ì˜ˆì™¸ ë°œìƒì„ ìë™í™”.
FunctionNotFoundException ë°œìƒ ì‹œ í•¨ìˆ˜ í‚¤ í¬í•¨í•˜ì—¬ ë” ë§ì€ ì •ë³´ ì œê³µ.
ğŸ“Œ ê°œì„ ëœ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private Function getFunctionByKey(String functionKey) {
    return functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new FunctionNotFoundException("í‘ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. FunctionKey: " + functionKey));
}
ì´ì œ í•¨ìˆ˜ ì¡°íšŒ ì‹œ null ì²´í¬ ì—†ì´ getFunctionByKey(functionKey)ë¥¼ í˜¸ì¶œí•˜ë©´ ìë™ìœ¼ë¡œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê³ , ì˜ë¯¸ ìˆëŠ” ë©”ì‹œì§€ê°€ í¬í•¨ë¨.

2ï¸âƒ£ ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ê°€ë…ì„± í–¥ìƒ
ğŸ”¹ ë¬¸ì œì 
registerFunctionCode, searchFunction, deleteFunction ë“±ì—ì„œ ê°™ì€ ë¡œì§ì„ ì—¬ëŸ¬ ë²ˆ ìˆ˜í–‰.
validateFunctionRequestì—ì„œ ê° í•„ë“œë¥¼ isEmpty()ë¡œ ê²€ì‚¬í•˜ëŠ” ì½”ë“œê°€ ë°˜ë³µë¨.
âœ… ê°œì„  ì‚¬í•­
getFunctionByKey ë©”ì†Œë“œ ì¶”ê°€ â†’ ì¤‘ë³µëœ findByFunctionKey ë¡œì§ ì œê±°.
StringUtils.isAnyEmpty() í™œìš© â†’ ìœ íš¨ì„± ê²€ì‚¬ ì½”ë“œë¥¼ ê°„ê²°í•˜ê²Œ ë³€ê²½.
deleteRelatedResources ë©”ì†Œë“œ ì¶”ê°€í•˜ì—¬ deleteFunction ë‚´ë¶€ì—ì„œ ì¤‘ë³µëœ ì‚­ì œ ë¡œì§ì„ ë¶„ë¦¬.
ğŸ“Œ ê°œì„ ëœ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private void validateFunctionRequest(FunctionDTO.Register reqDto) {
    if (StringUtils.isAnyEmpty(reqDto.getFunctionKey(), reqDto.getProjectId(), reqDto.getUserId(), reqDto.getEndPointType(), reqDto.getRuntime())) {
        throw new InvalidFunctionRequestException("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}
ì´ì œ ìœ íš¨ì„± ê²€ì‚¬ ì½”ë“œê°€ í•œ ì¤„ë¡œ ê°„ê²°í•˜ê²Œ ì •ë¦¬ë˜ì—ˆìœ¼ë©°, í™•ì¥ì„± ë° ê°€ë…ì„±ì´ í–¥ìƒë¨.

3ï¸âƒ£ í•¨ìˆ˜ ì‚­ì œ(deleteFunction) ë¡œì§ ê°œì„ 
ğŸ”¹ ë¬¸ì œì 
í•¨ìˆ˜ ì‚­ì œ ì‹œ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ ì‚­ì œ ë¡œì§ì´ deleteFunction ë‚´ë¶€ì—ì„œ ì§ì ‘ ì‹¤í–‰ë˜ì–´ ì½”ë“œê°€ ê¸¸ì–´ì§.
ì‚­ì œí•´ì•¼ í•˜ëŠ” ë¦¬ì†ŒìŠ¤ ëª©ë¡ì´ ëŠ˜ì–´ë‚˜ë©´ ì½”ë“œ ë³€ê²½ì´ í•„ìš”í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ì´ ë–¨ì–´ì§.
âœ… ê°œì„  ì‚¬í•­
deleteRelatedResources ë©”ì†Œë“œë¥¼ ì¶”ê°€í•˜ì—¬ í•¨ìˆ˜ ì‚­ì œ ë¡œì§ì„ ëª¨ë“ˆí™”.
deleteFunctionì—ì„œ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•  ë•Œ repositoryì˜ deleteAll ë©”ì†Œë“œ ì‚¬ìš©í•˜ì—¬ ì¼ê´„ ì‚­ì œ ê°€ëŠ¥í•˜ë„ë¡ ê°œì„ .
ğŸ“Œ ê°œì„ ëœ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public void deleteFunction(String functionKey) {
    Function function = getFunctionByKey(functionKey);
    if (function.isReady() || function.isDeploying()) {
        kn.services().inNamespace(function.getName()).withName(function.getName()).delete();
        istioCallService.deleteIstioPolicy(function.getName());
    }

    deleteRelatedResources(function);
    function.modifyDelYn();
    functionRepository.save(function);
}

private void deleteRelatedResources(Function function) {
    allowIpRepository.deleteAll(allowIpRepository.findByFunction(function));
    functionEnvironmentRepository.deleteAll(functionEnvironmentRepository.findByFunction(function));
    keyManagerRepository.findByFunctionAndDelYn(function, "N").ifPresent(keyManagerRepository::delete);
    sourceFileRepository.findByFunction(function).ifPresent(sourceFileRepository::delete);
}
ì´ì œ í•¨ìˆ˜ ì‚­ì œ ì‹œ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ì¼ê´„ ì‚­ì œí•  ìˆ˜ ìˆìœ¼ë©°, ì½”ë“œê°€ ë” ê°€ë…ì„± ë†’ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ì›Œì§.

4ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (updateEnvironment) ë¡œì§ ê°œì„ 
ğŸ”¹ ë¬¸ì œì 
í™˜ê²½ ë³€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•  ë•Œ ë£¨í”„ ë‚´ë¶€ì—ì„œ ì§ì ‘ save() í˜¸ì¶œí•˜ì—¬ Batch Insert ë¹„íš¨ìœ¨ ë°œìƒ.
ì¤‘ë³µëœ getFunctionByKey(functionKey) ë¡œì§ì´ ë°˜ë³µë¨.
âœ… ê°œì„  ì‚¬í•­
updateEnvironmentì—ì„œ forEachë¥¼ í™œìš©í•˜ì—¬ saveEnvironment í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½.
í•¨ìˆ˜ ì •ë³´ ì¡°íšŒ ë¡œì§ì„ getFunctionByKey(functionKey)ë¡œ í†µí•©í•˜ì—¬ ì¤‘ë³µ ì œê±°.
ğŸ“Œ ê°œì„ ëœ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public void updateEnvironment(List<FunctionEnvironmentDTO.Register> reqDto, String functionKey) {
    Function function = getFunctionByKey(functionKey);
    reqDto.forEach(dto -> saveEnvironment(dto, function));
}

private void saveEnvironment(FunctionEnvironmentDTO.Register dto, Function function) {
    dto.setFunctionSeq(function.getFunctionSeq());
    functionEnvironmentRepository.save(FunctionEnvironment.register(dto));
}
ì´ì œ í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œ save() í˜¸ì¶œì´ ì¼ê´„ì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ë©°, ì„±ëŠ¥ ìµœì í™” íš¨ê³¼ë¥¼ ê¸°ëŒ€í•  ìˆ˜ ìˆìŒ.

5ï¸âƒ£ ë°°í¬ ìƒíƒœ ë³€ê²½ ë¡œì§ ê°œì„ 
ğŸ”¹ ë¬¸ì œì 
registerFunctionCodeì—ì„œ í•¨ìˆ˜ ìƒíƒœê°€ DEPLOYINGìœ¼ë¡œ ë°”ë€Œì–´ì•¼ í•  ê²½ìš°, ì§ì ‘ setFunctionStatusë¥¼ í˜¸ì¶œí•¨.
ìƒíƒœ ë³€ê²½ ë° ì €ì¥ ë¡œì§ì´ ì¤‘ë³µë¨.
âœ… ê°œì„  ì‚¬í•­
shouldDeployFunction ë©”ì†Œë“œ ì¶”ê°€ â†’ ë°°í¬ í•„ìš” ì—¬ë¶€ë¥¼ ëª…í™•í•˜ê²Œ íŒë‹¨.
deployFunction ë©”ì†Œë“œ ì¶”ê°€ â†’ ì¤‘ë³µëœ ìƒíƒœ ë³€ê²½ ë¡œì§ ì œê±°.
ğŸ“Œ ê°œì„ ëœ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private boolean shouldDeployFunction(Function function) {
    return function.isReady();
}

private void deployFunction(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
    knativeService.callIstioAndKnative(function);
}
ì´ì œ registerFunctionCodeì—ì„œëŠ” shouldDeployFunctionì„ í˜¸ì¶œí•˜ì—¬ ë°°í¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , í•„ìš”í•  ê²½ìš° deployFunctionì„ í˜¸ì¶œí•˜ì—¬ ì¤‘ë³µëœ ìƒíƒœ ë³€ê²½ ë¡œì§ì„ ì¤„ì„.

ğŸ”¹ PR 2 - ìµœì¢… ê°œì„  íš¨ê³¼
âœ… ì»¤ìŠ¤í…€ ì˜ˆì™¸ ì ìš© â†’ ì˜ˆì™¸ ì²˜ë¦¬ì˜ ì¼ê´€ì„±ê³¼ ì˜ë¯¸ ì „ë‹¬ë ¥ í–¥ìƒ
âœ… ì¤‘ë³µ ì½”ë“œ ì œê±° â†’ getFunctionByKey, deployFunction, deleteRelatedResources ë©”ì†Œë“œ í™œìš©í•˜ì—¬ ì¬ì‚¬ìš©ì„± ì¦ê°€
âœ… ìœ íš¨ì„± ê²€ì‚¬ ê°œì„  â†’ StringUtils.isAnyEmpty() í™œìš©í•˜ì—¬ ì½”ë“œ ê°„ê²°í™”
âœ… ë°°í¬ ë¡œì§ ê°œì„  â†’ shouldDeployFunction, deployFunction ë¶„ë¦¬ë¡œ ê°€ë…ì„± í–¥ìƒ
âœ… í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ìµœì í™” â†’ saveEnvironment ë¶„ë¦¬ ë° ë°°ì¹˜ ìµœì í™”
âœ… ì‚­ì œ ë¡œì§ ê°œì„  â†’ deleteRelatedResources í™œìš©í•˜ì—¬ í•¨ìˆ˜ ì‚­ì œ ì‹œ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

