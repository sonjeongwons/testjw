ì½”ë“œë¥¼ í´ë¦° ì½”ë“œ ë° ë¦¬íŒ©í† ë§ ê´€ì ì—ì„œ ê°œì„ í•˜ë©´ì„œ ë‹¤ìŒ ì‚¬í•­ì„ ì¤‘ì ì ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

ì¤‘ë³µ ì½”ë“œ ì œê±°: ìœ ì‚¬í•œ ë¡œì§ì´ ë°˜ë³µë˜ëŠ” ë¶€ë¶„ì„ ë³„ë„ ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„±ì„ ë†’ì„.
ë©”ì„œë“œ í¬ê¸° ë‹¨ì¶•: ì§€ë‚˜ì¹˜ê²Œ ê¸´ ë©”ì„œë“œë¥¼ ì—¬ëŸ¬ ê°œì˜ ì‘ì€ ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ê°€ë…ì„±ì„ ê°œì„ .
ëª…í™•í•œ ë„¤ì´ë°: ë©”ì„œë“œì™€ ë³€ìˆ˜ì˜ ì—­í• ì´ ì§ê´€ì ìœ¼ë¡œ ì´í•´ë  ìˆ˜ ìˆë„ë¡ ëª…ëª… ë³€ê²½.
ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ : ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ì¶œë ¥(printStackTrace) ì œê±° ë° ë¡œê¹…ì„ í™œìš©í•œ ì˜ˆì™¸ ë©”ì‹œì§€ ê°œì„ .
ì˜ì¡´ì„± ì£¼ì…: new DefaultKubernetesClient() ê°™ì€ ì§ì ‘ ê°ì²´ ìƒì„±ì„ ì œê±°í•˜ê³  DI(Dependency Injection)ë¥¼ í™œìš©.
ë¶ˆí•„ìš”í•œ ë¡œê¹… ë° ì½˜ì†” ì¶œë ¥ ì œê±°: System.out.println()ì„ log.info()ë¡œ ë³€ê²½í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€.
ğŸ”¹ ë¦¬íŒ©í† ë§ ë³€ê²½ ì‚¬í•­
1ï¸âƒ£ switchLogging ë©”ì„œë“œ ê°œì„ 
ë¬¸ì œì 
functionRepository.findByFunctionKey(functionKey).orElseThrow(...) íŒ¨í„´ì´ ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µë¨.
ë¶ˆí•„ìš”í•œ ë³€ìˆ˜(isChanged) ì‚¬ìš©.
functionRepository.save(function);ê°€ ì¤‘ë³µ í˜¸ì¶œë¨.
knativeService.callFunction(function.getFunctionKey()); í˜¸ì¶œì´ ì¤‘ë³µë  ê°€ëŠ¥ì„±ì´ ìˆìŒ.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public CloudLoggingDTO.Response switchLogging(CloudLoggingDTO.Modify cloudLoggingDtos, String functionKey) throws IOException {
    Function function = getFunctionByKey(functionKey);
    
    if (!cloudLoggingDtos.getLogEnableYn().equals(function.getLogEnableYn())) {
        function.updateLogEnableYn(cloudLoggingDtos.getLogEnableYn());

        if (function.isReady()) {
            deployFunction(function);
        }
    }

    return new CloudLoggingDTO.Response(function.getLogEnableYn());
}

private Function getFunctionByKey(String functionKey) {
    return functionRepository.findByFunctionKey(functionKey)
        .orElseThrow(() -> new ResourceNotFoundException("ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ì•ŠìŠµë‹ˆë‹¤."));
}

private void deployFunction(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
    knativeService.callFunction(function.getFunctionKey());
}
ê°œì„  ì´ìœ 
ì¤‘ë³µëœ findByFunctionKey ë¡œì§ì„ getFunctionByKey ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„±ì„ ë†’ì„.
ì˜ë¯¸ ì—†ëŠ” isChanged ë³€ìˆ˜ ì œê±°.
ë°°í¬ ë¡œì§ì„ ë³„ë„ ë©”ì„œë“œ(deployFunction)ë¡œ ë¶„ë¦¬í•˜ì—¬ ì½”ë“œ ê°€ë…ì„± ê°œì„ .
2ï¸âƒ£ checkFunctionNameDuplicate ë©”ì„œë“œ ê°œì„ 
ë¬¸ì œì 
log.info("isExist = " + isExist); ê°€ ë¶ˆí•„ìš”í•œ String Concatenationì„ ë°œìƒì‹œí‚´.
if-else êµ¬ë¬¸ì„ ì œê±°í•˜ì—¬ ë” ê°„ê²°í•˜ê²Œ ì‘ì„± ê°€ëŠ¥.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
public FunctionDTO.DuplicateResponse checkFunctionNameDuplicate(FunctionDTO.Search reqDto) {
    boolean isExist = functionRepository.existsByDisplayNameAndProjectIdAndDelYn(
        reqDto.getDisplayName(), reqDto.getProjectId(), "N"
    );

    log.info("Function name duplicate check: {}", isExist);
    return FunctionDTO.DuplicateResponse.builder()
        .duplicateYn(isExist ? "Y" : "N")
        .build();
}
ê°œì„  ì´ìœ 
ë¡œê¹…ì„ log.info("isExist = " + isExist) â†’ log.info("Function name duplicate check: {}", isExist) ë¡œ ë³€ê²½í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¬¸ìì—´ ì—°ì‚° ì œê±°.
if-else ì—†ì´ ì‚¼í•­ ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ê°„ê²°í•˜ê²Œ í‘œí˜„.
3ï¸âƒ£ deleteUserNamespace ë©”ì„œë“œ ê°œì„ 
ë¬¸ì œì 
new DefaultKubernetesClient()ë¥¼ ì§ì ‘ í˜¸ì¶œ â†’ DI(ì˜ì¡´ì„± ì£¼ì…)ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ë°”ëŒì§.
printStackTrace() ì‚¬ìš© â†’ ë¡œê¹…ì„ í™œìš©í•˜ë„ë¡ ë³€ê²½.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Autowired
private KubernetesClient kubernetesClient;

public void deleteUserNamespace(Function function) {
    try {
        kubernetesClient.namespaces().withName(function.getName()).delete();
        log.info("Namespace '{}' deleted successfully.", function.getName());
    } catch (KubernetesClientException e) {
        log.error("Failed to delete namespace '{}': {}", function.getName(), e.getMessage());
    }
}
ê°œì„  ì´ìœ 
ì˜ì¡´ì„± ì£¼ì…ì„ í™œìš©í•˜ì—¬ KubernetesClientë¥¼ ì§ì ‘ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ë³€ê²½.
printStackTrace() ì œê±°í•˜ê³  log.error() í™œìš©í•˜ì—¬ ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ë¡œê¹….
4ï¸âƒ£ getPresignedUrl ë©”ì„œë“œ ê°œì„ 
ë¬¸ì œì 
S3Presignerê°€ ë§¤ë²ˆ ìƒì„±ë¨ â†’ ì„±ëŠ¥ ì €í•˜ ë°œìƒ ê°€ëŠ¥.
presignedGetObjectRequest.url().toString(); ë¶€ë¶„ì´ ì¤‘ë³µë¨.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private final S3Presigner presigner;

@Autowired
public FunctionService(S3Presigner presigner) {
    this.presigner = presigner;
}

@Transactional
public String getPresignedUrl(DownloadDTO reqDto) throws IOException {
    GetObjectRequest getObjectRequest = GetObjectRequest.builder()
            .bucket(reqDto.getBucketName())
            .key(reqDto.getObjectKey())
            .build();

    PresignedGetObjectRequest presignedRequest = presigner.presignGetObject(
            GetObjectPresignRequest.builder()
                    .signatureDuration(Duration.ofMinutes(1))
                    .getObjectRequest(getObjectRequest)
                    .build()
    );

    String url = presignedRequest.url().toString();
    log.info("Generated presigned URL: {}", url);
    return url;
}
ê°œì„  ì´ìœ 
S3Presignerë¥¼ ì˜ì¡´ì„± ì£¼ì…(DI) ë°©ì‹ìœ¼ë¡œ ê´€ë¦¬í•˜ì—¬ ë°˜ë³µ ìƒì„±ì„ ë°©ì§€ â†’ ì„±ëŠ¥ ê°œì„ .
presignedGetObjectRequest.url().toString();ì„ ì¤‘ë³µ í˜¸ì¶œí•˜ì§€ ì•Šë„ë¡ String url ë³€ìˆ˜ì— ì €ì¥.
5ï¸âƒ£ migrationFunction ë©”ì„œë“œ ê°œì„ 
ë¬¸ì œì 
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬í•˜ëŠ” ë¡œì§ì´ ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¬ ê°€ëŠ¥ì„±ì´ ìˆìŒ.
try-catch ë¸”ë¡ì—ì„œ ë„ˆë¬´ ë§ì€ ë¡œì§ì´ ì²˜ë¦¬ë¨ â†’ ì‘ì€ ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ë°”ëŒì§.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
public void migrationFunction() {
    List<Function> functions = functionRepository.findByFunctionStatusAndDelYn(TypeEnums.FunctionStatus.READY, "N");
    for (Function function : functions) {
        redeployFunctionIfNeeded(function);
    }
}

private void redeployFunctionIfNeeded(Function function) {
    if (function.isReady()) {
        function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
        functionRepository.save(function);
    }

    if (namespaceExists(function.getName())) return;

    try {
        triggerService.createUserNamespace(function);
        triggerService.createUserPVC(function);
        triggerService.createUserEnvoyFilter(function);
        knativeService.callIstioAndKnative(function);
    } catch (Exception e) {
        log.error("Migration failed for function '{}': {}", function.getName(), e.getMessage());
    }

    setupTriggerIfCron(function);
}

private boolean namespaceExists(String namespace) {
    return kubernetesClient.namespaces().withName(namespace).get() != null;
}

private void setupTriggerIfCron(Function function) {
    triggerRepository.findByFunction(function)
            .filter(trigger -> "cron".equals(trigger.getTriggerType()))
            .flatMap(triggerCronRepository::findByTrigger)
            .ifPresent(triggerCron -> triggerService.makePingSource(function.getName(), triggerCron.getTimezone(), triggerCron.getSchedule()));
}
ê°œì„  ì´ìœ 
namespaceExists ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì—¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë¶€ë¶„ì„ ë”°ë¡œ ë¶„ë¦¬.
ë°°í¬ ê´€ë ¨ ë¡œì§ì„ redeployFunctionIfNeeded ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ê°€ë…ì„± ê°œì„ .
setupTriggerIfCron ë©”ì„œë“œë¥¼ ë¶„ë¦¬í•˜ì—¬ íŠ¸ë¦¬ê±° ì„¤ì •ì„ í•œëˆˆì— íŒŒì•… ê°€ëŠ¥.
ğŸ”¹ ì •ë¦¬
ì¤‘ë³µëœ ì½”ë“œ ì œê±° (e.g., findByFunctionKey ë¡œì§ ë¶„ë¦¬).
ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ì¶œë ¥ ì œê±° (printStackTrace() â†’ log.error()).
ì˜ì¡´ì„± ì£¼ì…(DI) í™œìš© (KubernetesClient, S3Presigner).
ë©”ì„œë“œ í¬ê¸°ë¥¼ ì¤„ì´ê³  ì—­í• ì„ ëª…í™•íˆ ë¶„ë¦¬ (namespaceExists, setupTriggerIfCron ì¶”ê°€).
ë¡œê¹… ê°œì„  (log.info("Message: {}", variable) í˜•íƒœë¡œ ë³€ê²½).
