# 1. 베이스 이미지 선택 (OpenJDK 17 사용 예시)
FROM eclipse-temurin:17-jdk as builder

# 2. OpenTelemetry Java Agent 다운로드
ENV OTEL_AGENT_VERSION=1.33.0
RUN curl -L -o /opentelemetry-javaagent.jar \
    https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v${OTEL_AGENT_VERSION}/opentelemetry-javaagent.jar

# 3. 실제 앱을 실행할 이미지 (작게 유지)
FROM eclipse-temurin:17-jdk

# 4. 작업 디렉토리 설정
WORKDIR /app

# 5. OpenTelemetry Agent 복사
COPY --from=builder /opentelemetry-javaagent.jar /app/opentelemetry-javaagent.jar

# 6. 애플리케이션 JAR 복사
COPY build/libs/my-spring-app.jar /app/my-spring-app.jar

# 7. 환경변수 설정
ENV JAVA_TOOL_OPTIONS="-javaagent:/app/opentelemetry-javaagent.jar"
ENV OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
ENV OTEL_METRICS_EXPORTER=otlp
ENV OTEL_SERVICE_NAME=my-spring-app
# 트레이스, 로그도 추가 수집하려면 다음도 설정 가능:
# ENV OTEL_TRACES_EXPORTER=otlp
# ENV OTEL_LOGS_EXPORTER=otlp

# 8. 컨테이너 포트 오픈
EXPOSE 8080

# 9. 앱 실행
CMD ["java", "-jar", "/app/my-spring-app.jar"]