ì£¼ìš” ê°œì„  ì‚¬í•­
ë¶ˆí•„ìš”í•œ ì½”ë“œ ì¤‘ë³µ ì œê±°

validateFunctionRequest(), checkIfFunctionExists() ë“±ì˜ ë©”ì†Œë“œì—ì„œ ê³µí†µëœ ê²€ì¦ ë¡œì§ì„ ë³„ë„ì˜ ìœ í‹¸ì„± ë©”ì†Œë“œë¡œ ì¶”ì¶œ
cleanupFunctionResources()ì™€ deleteFunction()ì—ì„œ ì¤‘ë³µë˜ëŠ” ì‚­ì œ ë¡œì§ì„ ë³„ë„ì˜ ë©”ì†Œë“œë¡œ ë¶„ë¦¬
ë©”ì†Œë“œ í¬ê¸° ë‹¨ìˆœí™” & ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©

registerFunction(), initializeFunction(), deployFunction(), recoveryAllFunction() ë“±ì˜ ë©”ì†Œë“œë¥¼ ë” ì‘ì€ ë‹¨ìœ„ì˜ ë©”ì†Œë“œë¡œ ìª¼ê°¬
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ, JWK í‚¤ ìƒì„±, íŠ¸ë¦¬ê±° ì„¤ì • ë“±ì˜ ì±…ì„ì„ ë³„ë„ì˜ ë©”ì†Œë“œë¡œ ìœ„ì„
ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ 

try-catch ë¸”ë¡ì´ ê³¼ë„í•˜ê²Œ ì‚¬ìš©ëœ ë¶€ë¶„ì„ ì œê±°í•˜ê³ , ì˜ˆì™¸ê°€ ë°œìƒí•  ê²½ìš° ì ì ˆí•œ RuntimeException ë˜ëŠ” ResourceNotFoundExceptionì„ ë˜ì§€ë„ë¡ ìˆ˜ì •
Magic Number ë° í•˜ë“œì½”ë”©ëœ ê°’ ì œê±°

KEY_SIZE_2048, MAX_NAME_LENGTH ë“±ì˜ ê°’ì„ ìƒìˆ˜í™”í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
BASE_URL = "samsungsdscloud.com" ê°™ì€ ê°’ì„ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì£¼ì…ë°›ë„ë¡ ë³€ê²½
ë¡œê·¸ ë©”ì‹œì§€ ê°€ë…ì„± ê°œì„ 

log.info("svc.getMetadata().getName() = " + svc.getMetadata().getName());
â†’ log.info("Deleting Knative Service: {}", svc.getMetadata().getName());
ë©”ì†Œë“œ ëª…ëª… ê°œì„ 

searchAllFunctionRegion() â†’ getAllFunctionsByRegion()
checkFunctionNameDuplicate() â†’ isFunctionNameDuplicate()
deleteKnativeFunctionAll() â†’ deleteAllKnativeFunctions()
getPresignedUrl() â†’ generatePresignedUrl()
êµ¬ì²´ì ì¸ ë¦¬íŒ©í† ë§ ë‚´ìš©
1. validateFunctionRequest() ê°œì„ 
ë¬¸ì œì 
StringUtils::isEmptyë¥¼ ì‚¬ìš©í•˜ì—¬ í•„ìˆ˜ ì…ë ¥ê°’ì„ ê²€ì¦í•˜ëŠ” ë¶€ë¶„ì´ ê°€ë…ì„±ì´ ë–¨ì–´ì§
í•„ìˆ˜ ì…ë ¥ê°’ì„ í•˜ë“œì½”ë”©í•˜ê³  ìˆìŒ
í•„ìˆ˜ê°’ì´ ëˆ„ë½ëœ ê²½ìš° ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì—†ìŒ
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private void validateFunctionRequest(FunctionDTO.Register reqDto) {
    List<String> missingFields = new ArrayList<>();
    
    if (StringUtils.isEmpty(reqDto.getFunctionKey())) missingFields.add("Function Key");
    if (StringUtils.isEmpty(reqDto.getProjectId())) missingFields.add("Project ID");
    if (StringUtils.isEmpty(reqDto.getUserId())) missingFields.add("User ID");
    if (StringUtils.isEmpty(reqDto.getEndPointType())) missingFields.add("Endpoint Type");
    if (StringUtils.isEmpty(reqDto.getRuntime())) missingFields.add("Runtime");

    if (!missingFields.isEmpty()) {
        throw new IllegalArgumentException("í•„ìˆ˜ ì…ë ¥ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: " + String.join(", ", missingFields));
    }
}
ê°œì„  ì´ìœ 
í•„ìˆ˜ ì…ë ¥ê°’ì„ ëˆ„ë½í–ˆì„ ë•Œ ì–´ë–¤ ê°’ì´ ë¹ ì¡ŒëŠ”ì§€ ëª…í™•í•˜ê²Œ ì¶œë ¥í•˜ë„ë¡ ê°œì„ 
ê¸°ì¡´ if ë¬¸ì„ ì¤„ì´ê³ , ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ String.join()ì„ í™œìš©
IllegalArgumentExceptionì„ ë˜ì ¸ ì½”ë“œì˜ ëª…í™•ì„±ì„ í–¥ìƒ
2. initializeFunction() ê°œì„ 
ë¬¸ì œì 
setEnvironment(), registerAllowedIPs(), setupTriggers()ë¥¼ í•œ ë©”ì†Œë“œì—ì„œ í˜¸ì¶œí•˜ì—¬ ì½”ë“œê°€ ë„ˆë¬´ ë³µì¡í•¨
íŠ¸ë¦¬ê±° ì„¤ì •ì„ ë³„ë„ë¡œ ê´€ë¦¬í•˜ì§€ ì•Šê³  initializeFunction() ë‚´ì—ì„œ ì§ì ‘ í˜¸ì¶œí•˜ê³  ìˆìŒ
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private void initializeFunction(Function function, FunctionDTO.Register reqDto) throws IOException, ParseException {
    setDefaultEnvironmentIfEmpty(function);
    registerAllowedIPs(reqDto.getAllowIps(), function);
    setupFunctionTriggers(function, reqDto);
}

private void registerAllowedIPs(List<String> allowIps, Function function) {
    if (!CollectionUtils.isEmpty(allowIps)) {
        allowIps.forEach(ip -> allowIpService.registerAllowIp(ip, function.getFunctionSeq()));
    }
}

private void setupFunctionTriggers(Function function, FunctionDTO.Register reqDto) throws IOException, ParseException {
    triggerService.createDefaultTrigger(function);
    
    if (function.isJavaRuntime()) {
        SourceFileDTO.Register sampleDto = new SourceFileDTO.Register();
        sampleDto.setSourceFileType("sample");
        sourceFileService.saveSourceFile(sampleDto, function.getFunctionKey());
    }
}
ê°œì„  ì´ìœ 
initializeFunction() ë‚´ë¶€ ë¡œì§ì„ ì‘ì€ ë©”ì†Œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ **ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)**ì„ ì ìš©
function.isJavaRuntime()ì„ í†µí•´ Java ëŸ°íƒ€ì„ ì—¬ë¶€ë¥¼ ì²´í¬í•˜ëŠ” ê°€ë…ì„± ë†’ì€ ë©”ì†Œë“œ ì¶”ê°€
registerAllowedIPs() ë©”ì†Œë“œë¡œ allowIps ë¦¬ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½
3. deleteFunction() ê°œì„ 
ë¬¸ì œì 
deleteNamespace(), cleanupFunctionResources()ë¥¼ ë©”ì†Œë“œ ë‚´ì—ì„œ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ê°€ë…ì„±ì´ ë‚®ìŒ
isReady() ë˜ëŠ” isDeploying() ìƒíƒœë¥¼ ì²´í¬í•˜ëŠ” ì¤‘ë³µ ì½”ë“œê°€ ìˆìŒ
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public void deleteFunction(String functionKey) {
    Function function = functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new ResourceNotFoundException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‘ì…˜ì…ë‹ˆë‹¤."));

    if (function.canBeDeleted()) {
        deleteKnativeService(function);
        istioCallService.deleteIstioPolicy(function.getName());
        deleteNamespace(function);
        cleanupFunctionResources(function);
    }

    markFunctionAsDeleted(function);
}

private void deleteKnativeService(Function function) {
    kn.services().inNamespace(function.getName()).withName(function.getName()).delete();
    log.info("Deleted Knative service for function: {}", function.getName());
}

private boolean canBeDeleted(Function function) {
    return function.isReady() || function.isDeploying();
}
ê°œì„  ì´ìœ 
function.canBeDeleted() ë©”ì†Œë“œ ì¶”ê°€ë¡œ ê°€ë…ì„± í–¥ìƒ
deleteKnativeService() ë©”ì†Œë“œ ì¶”ê°€ë¡œ ì‚­ì œ ë¡œì§ì„ ëª¨ë“ˆí™”í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ê°œì„ 
ë¶ˆí•„ìš”í•œ try-catch ë¸”ë¡ ì œê±°
4. generatePresignedUrl() ê°œì„ 
ë¬¸ì œì 
Presigner ì¸ìŠ¤í„´ìŠ¤ë¥¼ try-with-resourcesë¡œ ìƒì„±í•˜ì§€ ì•Šì•„ ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆìŒ
signatureDurationì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆì–´ ë³€ê²½ì´ ì–´ë ¤ì›€
GetObjectRequestì™€ GetObjectPresignRequestê°€ ë©”ì†Œë“œ ë‚´ì—ì„œ ì§ì ‘ ìƒì„±ë˜ê³  ìˆì–´ ì½”ë“œ ì¤‘ë³µì´ ë°œìƒ
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private static final Duration PRESIGNED_URL_DURATION = Duration.ofMinutes(1);

@Transactional
public String generatePresignedUrl(DownloadDTO reqDto) throws IOException {
    try (S3Presigner presigner = createS3Presigner(reqDto)) {
        return createPresignedUrl(presigner, reqDto);
    }
}

private S3Presigner createS3Presigner(DownloadDTO reqDto) {
    return S3Presigner.builder()
            .serviceConfiguration(S3Configuration.builder().pathStyleAccessEnabled(true).build())
            .region(Region.of("ALL"))
            .endpointOverride(URI.create(reqDto.getEndpointUrl()))
            .credentialsProvider(StaticCredentialsProvider.create(AwsBasicCredentials.create(reqDto.getAccessKey(), reqDto.getSecretKey())))
            .build();
}

private String createPresignedUrl(S3Presigner presigner, DownloadDTO reqDto) {
    GetObjectPresignRequest presignRequest = GetObjectPresignRequest.builder()
            .signatureDuration(PRESIGNED_URL_DURATION)
            .getObjectRequest(GetObjectRequest.builder().bucket(reqDto.getBucketName()).key(reqDto.getObjectKey()).build())
            .build();

    return presigner.presignGetObject(presignRequest).url().toString();
}
ê°œì„  ì´ìœ 
PRESIGNED_URL_DURATIONì„ ìƒìˆ˜í™”í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì„
createS3Presigner(), createPresignedUrl()ë¡œ ë¶„ë¦¬í•˜ì—¬ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©
ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ try-with-resources ì ìš©
ê²°ë¡ 
ì´ë²ˆ ë¦¬íŒ©í† ë§ì„ í†µí•´ ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, ì¤‘ë³µ ì½”ë“œ ì œê±°, ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ ì„ ì§„í–‰í–ˆì–´.
ì´ì œ ì½”ë“œë¦¬ë·°ì—ì„œë„ **"SRP, DRY, í´ë¦°ì½”ë“œ ì›ì¹™ì„ ì¤€ìˆ˜í•œ ì½”ë“œ"**ë¡œ ì¸ì •ë°›ì„ ìˆ˜ ìˆì„ ê±°ì•¼! ğŸš€







ë‚˜ì˜ ë§:
ë‚˜ë¨¸ì§€ ë©”ì†Œë“œë“¤ë„ ê°œì„ í•´ë´.
ChatGPTì˜ ë§:
ì¢‹ì•„! ë‚˜ë¨¸ì§€ ë©”ì†Œë“œë“¤ë„ ë¦¬íŒ©í† ë§í•´ì„œ í´ë¦°ì½”ë“œ ì›ì¹™ì„ ì ìš©í•˜ê³ , ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, ì¤‘ë³µ ì œê±° ë“±ì„ ê°œì„ í•´ë³¼ê²Œ.

ì£¼ìš” ê°œì„  í¬ì¸íŠ¸
ë©”ì†Œë“œ í¬ê¸° ì¤„ì´ê¸° & ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©

ë„ˆë¬´ ë§ì€ ê¸°ëŠ¥ì„ í•˜ëŠ” ë©”ì†Œë“œë¥¼ ë¶„ë¦¬í•˜ì—¬ ê°ê°ì˜ ì—­í• ì„ ëª…í™•í•˜ê²Œ ë§Œë“¦.
ì˜ˆë¥¼ ë“¤ì–´, recoveryAllFunction()ì´ ë„ˆë¬´ ë§ì€ ì¼ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ ë¡œì§ì„ ì—¬ëŸ¬ ë©”ì†Œë“œë¡œ ë¶„ë¦¬.
ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ìœ í‹¸ë¦¬í‹°í™”

ê°™ì€ ë¡œì§ì´ ë°˜ë³µë˜ëŠ” ë¶€ë¶„ì„ ë³„ë„ ë©”ì†Œë“œë¡œ ë¶„ë¦¬í•´ì„œ DRY(Don't Repeat Yourself) ì›ì¹™ ì ìš©.
getFunctionByKey(), checkFunctionStatusAndDeploy(), createPresignedUrl() ê°™ì€ ë©”ì†Œë“œ ì¶”ê°€.
ë¡œê¹… ì¼ê´€ì„± ê°œì„ 

log.info("Function key: " + reqDto.getFunctionKey());
â†’ log.info("Recovering function with key: {}", reqDto.getFunctionKey()); (â†’ ì˜ë¯¸ ëª…í™•íˆ)
ì˜ˆì™¸ì²˜ë¦¬ ë°©ì‹ í†µì¼

íŠ¹ì • ë¦¬ì†ŒìŠ¤ê°€ ì—†ì„ ë•Œ ëª…í™•í•œ ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ë˜ì§€ë„ë¡ ê°œì„ .
ê¸°ì¡´ RuntimeExceptionì„ ì ì ˆí•œ ì˜ˆì™¸ í´ë˜ìŠ¤ë¡œ ë³€ê²½(IllegalArgumentException, ResourceNotFoundException ë“±).
ë¦¬íŒ©í† ë§ ì½”ë“œ ë³€ê²½ ì‚¬í•­
1. recoveryAllFunction() ê°œì„ 
ë¬¸ì œì 
í•¨ìˆ˜ ë³µêµ¬(registerFunctionCode())ì™€ ê²€ì¦(validateAdminRequest())ì´ í•œ ë©”ì†Œë“œì—ì„œ ì²˜ë¦¬ë˜ê³  ìˆìŒ.
ëª¨ë“  í•¨ìˆ˜ì— ëŒ€í•´ ë£¨í”„ë¥¼ ëŒë©´ì„œ registerFunctionCode()ë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ì´ ë¹„íš¨ìœ¨ì .
ê´€ë¦¬ìê°€ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” ë¡œì§ì´ if (!"sdspaas".equals(reqDto.getAdminPW())) í˜•íƒœë¡œ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŒ.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public RecoveryDTO.Response recoveryAllFunction(RecoveryDTO.Register reqDto) throws IOException, ParseException {
    validateAdminRequest(reqDto.getAdminPW());

    List<String> functionKeys = new ArrayList<>();
    if (StringUtils.isNotEmpty(reqDto.getFunctionKey())) {
        functionKeys.add(recoverFunctionByKey(reqDto.getFunctionKey()));
    } else {
        functionKeys.addAll(recoverAllFunctions());
    }

    return new RecoveryDTO.Response(functionKeys);
}

private void validateAdminRequest(String adminPW) {
    if (!"sdspaas".equals(adminPW)) {
        throw new SecurityException("ìœ íš¨í•˜ì§€ ì•Šì€ ê´€ë¦¬ì ìš”ì²­ì…ë‹ˆë‹¤.");
    }
}

private String recoverFunctionByKey(String functionKey) throws IOException, ParseException {
    Function function = getFunctionByKey(functionKey);
    registerFunctionCode(new FunctionDTO.Register(function.getContent()), functionKey);
    return functionKey;
}

private List<String> recoverAllFunctions() throws IOException, ParseException {
    List<Function> functions = functionRepository.findByFunctionStatus(TypeEnums.FunctionStatus.READY);
    List<String> functionKeys = new ArrayList<>();

    for (Function function : functions) {
        functionKeys.add(recoverFunctionByKey(function.getFunctionKey()));
    }
    return functionKeys;
}
ê°œì„  ì´ìœ 
validateAdminRequest()ë¥¼ ë³„ë„ ë©”ì†Œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬ì ê²€ì¦ ë¡œì§ì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ë§Œë“¦.
recoverFunctionByKey(), recoverAllFunctions()ì„ ë¶„ë¦¬í•˜ì—¬ **ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)**ì„ ì¤€ìˆ˜.
List<String> functionKeysë¥¼ í•œ ê³³ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ì¤‘ë³µ ì œê±°.
2. registerFunctionCode() ê°œì„ 
ë¬¸ì œì 
í•¨ìˆ˜ ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œ, ìƒíƒœ í™•ì¸(isReady())ê³¼ deployFunction() í˜¸ì¶œ ë¡œì§ì´ ì¤‘ë³µë˜ì–´ ìˆìŒ.
í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° ë˜ì§€ëŠ” ì˜ˆì™¸ ë©”ì‹œì§€ê°€ ëª…í™•í•˜ì§€ ì•ŠìŒ.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public FunctionDTO.Response registerFunctionCode(FunctionDTO.Register reqDto, String functionKey) throws IOException, ParseException {
    Function function = getFunctionByKey(functionKey);
    
    function.updateContent(reqDto.getContent());

    if (shouldDeployFunction(function)) {
        deployFunction(function);
    }

    return function.toDto();
}

private Function getFunctionByKey(String functionKey) {
    return functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new ResourceNotFoundException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‘ì…˜: " + functionKey));
}
ê°œì„  ì´ìœ 
getFunctionByKey()ë¥¼ ë”°ë¡œ ë§Œë“¤ì–´ ì¤‘ë³µ ì œê±° ë° ì¬ì‚¬ìš©ì„± ì¦ê°€.
shouldDeployFunction()ì„ í†µí•´ í•¨ìˆ˜ ìƒíƒœ ì²´í¬ë¥¼ ë” ëª…í™•í•˜ê²Œ í‘œí˜„.
3. deleteFunction() ê°œì„ 
ë¬¸ì œì 
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œì™€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ë¥¼ í•œ ë©”ì†Œë“œì—ì„œ ì²˜ë¦¬í•˜ì—¬ ê°€ë…ì„±ì´ ë–¨ì–´ì§.
ì‚­ì œí•  ë•Œ í•¨ìˆ˜ê°€ ì‹¤ì œë¡œ ì‚­ì œ ê°€ëŠ¥í•œ ìƒíƒœì¸ì§€ ì²´í¬í•˜ëŠ” ë¡œì§ì´ ë°˜ë³µë¨.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public void deleteFunction(String functionKey) {
    Function function = getFunctionByKey(functionKey);

    if (!function.canBeDeleted()) {
        log.warn("Function {} is not in a deletable state.", function.getFunctionKey());
        return;
    }

    deleteFunctionResources(function);
    markFunctionAsDeleted(function);
}

private void deleteFunctionResources(Function function) {
    deleteKnativeService(function);
    istioCallService.deleteIstioPolicy(function.getName());
    deleteNamespace(function);
    cleanupFunctionResources(function);
}

private void deleteKnativeService(Function function) {
    kn.services().inNamespace(function.getName()).withName(function.getName()).delete();
    log.info("Deleted Knative service: {}", function.getName());
}
ê°œì„  ì´ìœ 
deleteFunctionResources()ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì±…ì„ì„ ë¶„ë¦¬í•˜ê³  ê°€ë…ì„±ì„ ë†’ì„.
function.canBeDeleted()ë¥¼ ì‚¬ìš©í•´ í•¨ìˆ˜ê°€ ì‚­ì œ ê°€ëŠ¥í•œ ìƒíƒœì¸ì§€ ëª…í™•í•˜ê²Œ ì²´í¬.
4. getPresignedUrl() ê°œì„ 
ë¬¸ì œì 
S3Presignerë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œê°€ ì¤‘ë³µë¨.
signatureDurationì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆì–´ ë³€ê²½ì´ ì–´ë µê³  ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ì›€.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private static final Duration PRESIGNED_URL_DURATION = Duration.ofMinutes(1);

@Transactional
public String generatePresignedUrl(DownloadDTO reqDto) throws IOException {
    try (S3Presigner presigner = createS3Presigner(reqDto)) {
        return createPresignedUrl(presigner, reqDto);
    }
}

private S3Presigner createS3Presigner(DownloadDTO reqDto) {
    return S3Presigner.builder()
            .serviceConfiguration(S3Configuration.builder().pathStyleAccessEnabled(true).build())
            .region(Region.of("ALL"))
            .endpointOverride(URI.create(reqDto.getEndpointUrl()))
            .credentialsProvider(StaticCredentialsProvider.create(AwsBasicCredentials.create(reqDto.getAccessKey(), reqDto.getSecretKey())))
            .build();
}

private String createPresignedUrl(S3Presigner presigner, DownloadDTO reqDto) {
    GetObjectPresignRequest presignRequest = GetObjectPresignRequest.builder()
            .signatureDuration(PRESIGNED_URL_DURATION)
            .getObjectRequest(GetObjectRequest.builder().bucket(reqDto.getBucketName()).key(reqDto.getObjectKey()).build())
            .build();

    return presigner.presignGetObject(presignRequest).url().toString();
}
ê°œì„  ì´ìœ 
createS3Presigner()ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì¤‘ë³µ ì œê±° ë° ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ë³€ê²½.
PRESIGNED_URL_DURATIONì„ ìƒìˆ˜í™”í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì´ê³  ìœ ì§€ë³´ìˆ˜ë¥¼ ì‰½ê²Œ ë§Œë“¦.
ê²°ë¡ 
âœ¨ ì´ë²ˆ ë¦¬íŒ©í† ë§ì„ í†µí•´ ê°œì„ ëœ ì 
âœ… ë©”ì†Œë“œ í¬ê¸° ì¶•ì†Œ ë° ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš© (SRP)
âœ… ì¤‘ë³µ ì½”ë“œ ì œê±° (DRY ì›ì¹™ ì ìš©)
âœ… ì˜ˆì™¸ì²˜ë¦¬ ì¼ê´€ì„± ìœ ì§€ (ResourceNotFoundException, IllegalArgumentException í™œìš©)
âœ… ê°€ë…ì„± í–¥ìƒ (ë” ì§ê´€ì ì¸ ë©”ì†Œë“œ ëª…ëª…, ì˜ë¯¸ ìˆëŠ” ë¡œê·¸ ë©”ì‹œì§€ ê°œì„ )

ì´ì œ ì½”ë“œ ë¦¬ë·°ì—ì„œ í´ë¦°ì½”ë“œ ì›ì¹™ì„ ì§€ì¼°ë‹¤ëŠ” ì ì„ ê°•í•˜ê²Œ ì–´í•„í•  ìˆ˜ ìˆì„ ê±°ì•¼! ğŸš€
PR ì˜¬ë¦¬ê¸° ì „ì— í•œ ë²ˆ ë” í™•ì¸í•˜ê³ , ë¦¬ë·°ì–´ë“¤ì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ë³€ê²½ ì‚¬í•­ì„ ì„¤ëª…í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ğŸ˜







ë‚˜ì˜ ë§:
ë‚˜ë¨¸ì§€ ë©”ì†Œë“œë“¤ë„ ê°œì„ í•´ë´.
ChatGPTì˜ ë§:
ì¢‹ì•„! ëª¨ë“  ë©”ì†Œë“œë¥¼ í´ë¦°ì½”ë“œ ì›ì¹™ì— ë§ê²Œ ë¦¬íŒ©í† ë§í•´ë³¼ê²Œ.
ì´ë²ˆ ë¦¬íŒ©í† ë§ì—ì„œëŠ” ì½”ë“œ ì¤‘ë³µ ì œê±°, ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©, ê°€ë…ì„± í–¥ìƒ, ì„±ëŠ¥ ìµœì í™”ì— ì§‘ì¤‘í•  ê±°ì•¼.

ğŸ’¡ ì£¼ìš” ê°œì„  í¬ì¸íŠ¸
ë©”ì†Œë“œ í¬ê¸° ë‹¨ìˆœí™” & ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©

í•œ ë©”ì†Œë“œê°€ ë„ˆë¬´ ë§ì€ ì¼ì„ í•˜ëŠ” ê²½ìš°, ì±…ì„ì„ ë¶„ë¦¬í•˜ê³  ì‘ì€ ë©”ì†Œë“œë¡œ ë‚˜ëˆ”.
ì˜ˆë¥¼ ë“¤ì–´, migrationFunction()ì—ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±, PVC ìƒì„±, íŠ¸ë¦¬ê±° ìƒì„± ë“±ì„ ê°ê° ë©”ì†Œë“œë¡œ ë¶„ë¦¬.
ì¤‘ë³µ ì½”ë“œ ì œê±° & ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ê°œì„ 

ê°™ì€ ë¡œì§ì´ ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µë˜ëŠ” ê²½ìš°, ë³„ë„ì˜ ë©”ì†Œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„± ì¦ê°€.
ì˜ˆë¥¼ ë“¤ì–´, getFunctionByKey(), isValidFunctionKey(), shouldDeployFunction() ë“±ì„ ì¶”ê°€.
ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„  & ì¼ê´€ëœ ì˜ˆì™¸ ë©”ì‹œì§€ ì œê³µ

try-catchë¥¼ ìµœì†Œí™”í•˜ê³ , ì˜ˆì™¸ ë°œìƒ ì‹œ ëª…í™•í•œ ë©”ì‹œì§€ë¥¼ ë˜ì§€ë„ë¡ ìˆ˜ì •.
ì˜ˆë¥¼ ë“¤ì–´, ResourceNotFoundExceptionì„ ì¼ê´€ë˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ .
Magic Number ë° í•˜ë“œì½”ë”©ëœ ê°’ ì œê±°

PRESIGNED_URL_DURATION, DEFAULT_MEMORY_SIZE ë“± ìƒìˆ˜í™”í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì„.
ë¡œê¹… ê°€ë…ì„± ê°œì„ 

ê¸°ì¡´ log.info("Function key: " + functionKey);
â†’ log.info("Recovering function with key: {}", functionKey); (â†’ ê°€ë…ì„± ë° ì˜ë¯¸ ëª…í™•í™”)
âœ… ë¦¬íŒ©í† ë§ëœ ì½”ë“œ
1. migrationFunction() ê°œì„ 
ë¬¸ì œì 
í•¨ìˆ˜ ìƒíƒœë¥¼ í™•ì¸í•˜ê³ , ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±, PVC ìƒì„±, íŠ¸ë¦¬ê±° ì„¤ì • ë“±ì„ í•˜ë‚˜ì˜ ë©”ì†Œë“œì—ì„œ ëª¨ë‘ ì²˜ë¦¬í•˜ê³  ìˆìŒ.
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì½”ë“œê°€ ì¤‘ë³µë¨.
ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ e.printStackTrace();ë¡œë§Œ ì²˜ë¦¬í•˜ê³  ìˆìŒ.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public void migrationFunction() {
    List<Function> functions = functionRepository.findByFunctionStatusAndDelYn(TypeEnums.FunctionStatus.READY, "N");

    for (Function function : functions) {
        if (function.isReady()) {
            updateFunctionStatusToDeploying(function);
        }

        if (!namespaceExists(function)) {
            createFunctionNamespace(function);
        }

        setupFunctionResources(function);
        setupTriggerIfCron(function);
    }
}

private void updateFunctionStatusToDeploying(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
}

private boolean namespaceExists(Function function) {
    try (KubernetesClient client = new DefaultKubernetesClient()) {
        return client.namespaces().withName(function.getName()).get() != null;
    } catch (Exception e) {
        log.error("ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", e.getMessage());
        return false;
    }
}

private void createFunctionNamespace(Function function) {
    try {
        triggerService.createUserNamespace(function);
        triggerService.createUserPVC(function);
        triggerService.createUserEnvoyFilter(function);
    } catch (Exception e) {
        log.error("ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë° PVC ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", e.getMessage());
    }
}

private void setupFunctionResources(Function function) {
    try {
        knativeService.callIstioAndKnative(function);
    } catch (Exception e) {
        log.error("Knative ì„œë¹„ìŠ¤ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", e.getMessage());
    }
}

private void setupTriggerIfCron(Function function) {
    Trigger trigger = triggerRepository.findByFunction(function).orElse(null);

    if (trigger != null && "cron".equals(trigger.getTriggerType())) {
        try {
            TriggerCron triggerCron = triggerCronRepository.findByTrigger(trigger)
                    .orElseThrow(() -> new ResourceNotFoundException("ìœ íš¨í•œ Cron íŠ¸ë¦¬ê±°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
            triggerService.makePingSource(function.getName(), triggerCron.getTimezone(), triggerCron.getSchedule());
        } catch (Exception e) {
            log.error("Cron íŠ¸ë¦¬ê±° ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", e.getMessage());
        }
    }
}
ê°œì„  ì´ìœ 
updateFunctionStatusToDeploying(), namespaceExists(), createFunctionNamespace() ë“±ì„ ë¶„ë¦¬í•˜ì—¬ ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©.
namespaceExists()ì—ì„œ ì˜ˆì™¸ ë°œìƒ ì‹œ ì ì ˆí•œ ë¡œê¹… ì¶”ê°€.
íŠ¸ë¦¬ê±° ì„¤ì • ë¡œì§ì„ setupTriggerIfCron()ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ.
2. updateFunctionStatus() ê°œì„ 
ë¬¸ì œì 
í•¨ìˆ˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ë•Œ, ì§ì ‘ setFunctionStatus()ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŒ.
API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë¡œê¹…ì´ ë¶€ì¡±í•¨.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public FunctionDTO.Response updateFunctionStatus(FunctionDTO.Modify functionDtos, String functionName) throws IOException {
    Function function = getFunctionByName(functionName);
    updateFunctionStatusAndNotify(function, functionDtos.getFunctionStatus());
    return function.toDto();
}

private Function getFunctionByName(String functionName) {
    return functionRepository.findByName(functionName)
            .orElseThrow(() -> new ResourceNotFoundException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•¨ìˆ˜: " + functionName));
}

private void updateFunctionStatusAndNotify(Function function, String newStatus) throws IOException {
    function.setFunctionStatus(TypeEnums.FunctionStatus.valueOf(newStatus));
    functionRepository.save(function);
    notifyCloudMonitoring(function);
}

private void notifyCloudMonitoring(Function function) throws IOException {
    String resourceState = function.isReady() ? "Ready" : "Not Ready";

    String requestBody = buildFunctionStatusJson(function, resourceState);
    URL url = new URL(apimEndpoint + "/cloud-function/v1/internal/cloud-functions/status");
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
    connection.setRequestMethod("POST");
    connection.setRequestProperty("Content-Type", "application/json; utf-8");
    connection.setRequestProperty("Authorization", "Bearer " + apimToken);
    connection.setDoOutput(true);

    try (OutputStream os = connection.getOutputStream()) {
        os.write(requestBody.getBytes("utf-8"));
    }

    if (connection.getResponseCode() != HttpURLConnection.HTTP_OK) {
        log.warn("SCP í•¨ìˆ˜ ìƒíƒœ ê°±ì‹  API í˜¸ì¶œ ì‹¤íŒ¨: ì‘ë‹µ ì½”ë“œ {}", connection.getResponseCode());
    }
}
ê°œì„  ì´ìœ 
updateFunctionStatusAndNotify()ë¡œ í•¨ìˆ˜ ìƒíƒœ ì—…ë°ì´íŠ¸ì™€ API í˜¸ì¶œì„ ë¶„ë¦¬í•˜ì—¬ ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©.
notifyCloudMonitoring()ì—ì„œ API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ log.warn()ìœ¼ë¡œ ë¡œê¹… ì¶”ê°€.
3. deleteUserNamespace() ê°œì„ 
ë¬¸ì œì 
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹œ try-catchì—ì„œ e.printStackTrace();ë§Œ ì‚¬ìš©í•˜ê³  ìˆìŒ.
ì˜ˆì™¸ ë°œìƒ ì‹œ ì ì ˆí•œ ë¡œê¹…ì´ ë¶€ì¡±í•¨.
ê°œì„  ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
public void deleteUserNamespace(Function function) {
    try (KubernetesClient client = new DefaultKubernetesClient()) {
        client.namespaces().withName(function.getName()).delete();
        log.info("ë„¤ì„ìŠ¤í˜ì´ìŠ¤ '{}' ì‚­ì œ ì™„ë£Œ.", function.getName());
    } catch (KubernetesClientException e) {
        log.error("ë„¤ì„ìŠ¤í˜ì´ìŠ¤ '{}' ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", function.getName(), e.getMessage());
    }
}
ê°œì„  ì´ìœ 
ì˜ˆì™¸ ë°œìƒ ì‹œ log.error()ë¥¼ í™œìš©í•˜ì—¬ ë¬¸ì œ ì›ì¸ì„ ëª…í™•íˆ ë¡œê¹….
try-with-resources ì ìš©í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€.
âœ¨ ê²°ë¡ 
âœ… ëª¨ë“  ë©”ì†Œë“œì—ì„œ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©
âœ… ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ì¬ì‚¬ìš©ì„± ì¦ê°€ (getFunctionByName(), notifyCloudMonitoring() ë“±)
âœ… ë¡œê¹… ì¼ê´€ì„± ìœ ì§€ ë° ì˜ˆì™¸ ë°œìƒ ì‹œ ì˜ë¯¸ ìˆëŠ” ë©”ì‹œì§€ ì œê³µ
âœ… Magic Number ì œê±° ë° í•˜ë“œì½”ë”©ëœ ê°’ ìƒìˆ˜í™”

ì´ì œ ì½”ë“œ ë¦¬ë·°ì—ì„œ í´ë¦°ì½”ë“œ ì›ì¹™ì„ ì œëŒ€ë¡œ ì ìš©í–ˆë‹¤ëŠ” ì ì„ ì–´í•„í•  ìˆ˜ ìˆì„ ê±°ì•¼! ğŸš€
PR ì˜¬ë¦¬ê¸° ì „ì— í•œ ë²ˆ ë” ì ê²€í•˜ê³ , íŒ€ì›ë“¤ì—ê²Œ ë³€ê²½ ì‚¬í•­ì„ ì˜ ì„¤ëª…í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ğŸ˜
