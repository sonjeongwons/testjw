ì¢‹ì•„. ì œê³µí•´ì¤€ ë¡œê·¸ë¥¼ ë³´ë©´, CVC ì•…ì„±ì½”ë“œ ê²€ì‚¬ APIì˜ ì‘ë‹µ bodyëŠ” ë‹¤ìŒê³¼ ê°™ì€ JSON í˜•ì‹ì´ì•¼:

{
  "fileName": "download.jar-tmp",
  "returnCode": -1,
  "message": "Unsupported file type."
}

ì´ì œ ë„ˆì˜ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ scanCodeFile() ë©”ì†Œë“œë¥¼ ë¦¬íŒ©í† ë§í•˜ê³ , downloadFile() ë©”ì†Œë“œì— ë¶„ê¸° ë¡œì§ì„ ì¶”ê°€í•˜ì. êµ¬ì²´ì ìœ¼ë¡œ ë‹¤ìŒ 2ê°€ì§€ ì‘ì—…ì„ í•´ì¤„ê²Œ:


---

âœ… 1. scanCodeFile() ë¦¬íŒ©í† ë§: returnCode ê°’ì„ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •

ğŸ”§ ë³€ê²½ ì „

private void scanCodeFile(CodeDTO reqDto)

ğŸ”§ ë³€ê²½ í›„

private ScanResult scanCodeFile(CodeDTO reqDto)

// ê²°ê³¼ DTO í´ë˜ìŠ¤
@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
static class ScanResult {
    private int returnCode;
    private String message;
}

âœ… ìˆ˜ì •ëœ scanCodeFile() ì „ì²´ ì½”ë“œ

private ScanResult scanCodeFile(CodeDTO reqDto) {
    String endpoint = CVC_URL + "/api/v1/scanner/multipart-scan";

    try {
        // ê²€ì‚¬í•  íŒŒì¼ ê²½ë¡œ ì„¤ì •
        String path = reqDto.getPath() + "-tmp";
        File file = new File(path);
        if (!file.exists() || !file.isFile()) {
            throw new IllegalArgumentException("ìœ íš¨í•œ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: " + path);
        }

        MultipartBodyBuilder builder = new MultipartBodyBuilder();
        builder.part("file", new FileSystemResource(file)).filename(file.getName());

        LinkedMultiValueMap<String, HttpEntity<?>> multipartBody =
                (LinkedMultiValueMap<String, HttpEntity<?>>) builder.build();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        headers.set("X-Subject-Token", tokenScheduler.getAccessToken());

        ResponseEntity<String> response = httpCallService.callMultipartHttpReqeust(
                endpoint, "POST", multipartBody, headers, String.class, true
        );

        log.info("[scanCodeFile] ì•…ì„±ì½”ë“œ ê²€ì‚¬ ìš”ì²­ ì„±ê³µ: status={}, body={}",
                response.getStatusCode(), response.getBody());

        // JSON íŒŒì‹±
        ObjectMapper objectMapper = new ObjectMapper();
        JsonNode jsonNode = objectMapper.readTree(response.getBody());

        int returnCode = jsonNode.get("returnCode").asInt();
        String message = jsonNode.has("message") ? jsonNode.get("message").asText() : "";

        return ScanResult.builder()
                .returnCode(returnCode)
                .message(message)
                .build();

    } catch (Exception e) {
        log.error("[scanCodeFile] ì•…ì„±ì½”ë“œ ê²€ì‚¬ ìš”ì²­ ì‹¤íŒ¨: {}", e.getMessage(), e);
        return ScanResult.builder()
                .returnCode(-1)
                .message("íŒŒì¼ ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                .build();
    }
}


---

âœ… 2. downloadFile() ë¡œì§ì— ScanResult ë¶„ê¸° ì¶”ê°€

ğŸ“Œ ë³€ê²½ ìœ„ì¹˜

ê¸°ì¡´ì—ëŠ” scanCodeFile(reqDto);ë§Œ ìˆì—ˆì§€? ì´ì œ ë‹¤ìŒì²˜ëŸ¼ ScanResultë¥¼ ë°›ì•„ì„œ ë¶„ê¸° ì²˜ë¦¬í•˜ì.

âœ… ê°œì„ ëœ ë¡œì§ ì˜ˆì‹œ (ì¤‘ê°„ ë¶€ë¶„ë§Œ ë°œì·Œ)

// ìŠ¤ìº” ê²°ê³¼ ë°›ì•„ì˜¤ê¸°
ScanResult scanResult = scanCodeFile(reqDto);

int returnCode = scanResult.getReturnCode();
String message = scanResult.getMessage();

if (returnCode == 0) {
    // ì•…ì„±ì½”ë“œ ì—†ìŒ â†’ ì •ìƒì²˜ë¦¬
    Files.move(tmpFile, downloadFile, StandardCopyOption.REPLACE_EXISTING);
    respDto.setFileTransferStatus("COMPLETE");
} else if (returnCode == 1) {
    // ì•…ì„±ì½”ë“œ ê²€ì¶œë¨
    Files.deleteIfExists(tmpFile);
    respDto.setFileTransferStatus("ERROR_MALWARE");
} else {
    // ìŠ¤ìº” ì‹¤íŒ¨ or ê¸°íƒ€ ì—ëŸ¬
    Files.deleteIfExists(tmpFile);
    log.warn("ì•…ì„±ì½”ë“œ ê²€ì‚¬ ì‹¤íŒ¨: {}", message);
    respDto.setFileTransferStatus("ERROR_SCAN");
}


---

âœ… ìµœì¢… êµ¬ì¡° ìš”ì•½

returnCode	ì˜ë¯¸	ì²˜ë¦¬

0	ì•…ì„±ì½”ë“œ ì—†ìŒ	tmp íŒŒì¼ì„ ì›ë˜ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³ , "COMPLETE" ì„¤ì •
1	ì•…ì„±ì½”ë“œ ìˆìŒ	tmp íŒŒì¼ ì‚­ì œ, "ERROR_MALWARE" ì„¤ì •
-1	ìŠ¤ìº” ì‹¤íŒ¨	tmp íŒŒì¼ ì‚­ì œ + ë¡œê·¸ ì¶œë ¥ + "ERROR_SCAN" ì„¤ì •



---

ğŸ”„ ì „ì²´ íë¦„ ë³€í™” ìš”ì•½

// ê¸°ì¡´
scanCodeFile(reqDto); // ê²°ê³¼ ì—†ìŒ

// ê°œì„ 
ScanResult scanResult = scanCodeFile(reqDto);
switch(scanResult.getReturnCode()) {
    case 0 -> ì •ìƒ íŒŒì¼ ì´ë™ ë° COMPLETE ì„¤ì •
    case 1 -> ì„ì‹œ íŒŒì¼ ì‚­ì œ ë° ERROR_MALWARE ì„¤ì •
    default -> ì„ì‹œ íŒŒì¼ ì‚­ì œ ë° message ë¡œê·¸ + ERROR_SCAN ì„¤ì •
}


---

ğŸ”¥ ì¶”ê°€ ê°œì„  íŒ

ScanResult í´ë˜ìŠ¤ë¥¼ ì™¸ë¶€ DTOë¡œ ë¶„ë¦¬í•´ë‘ë©´ ì¬ì‚¬ìš©ì„±ì´ ë†’ì•„ì§

FileUtils.forceDelete() ëŒ€ì‹  Files.deleteIfExists()ë¥¼ ì‚¬ìš©í•˜ë©´ IOException ì˜ˆì™¸ ëœ ë°œìƒ

ë§Œì•½ ê²€ì‚¬ ì‹¤íŒ¨ ì‚¬ìœ ê°€ ì‚¬ìš©ìì—ê²Œ í•„ìš”í•œ ì •ë³´ë¼ë©´ respDto.setErrorMessage(message) ê°™ì€ í•„ë“œë¥¼ ì¶”ê°€í•´ ì „ë‹¬ ê°€ëŠ¥



---

ğŸ“Œ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆëŠ” ê²ƒë“¤

Q1: scanCodeFile ê²°ê³¼ë¥¼ ìºì‹±í•´ì„œ ë™ì¼í•œ íŒŒì¼ì€ ì¬ê²€ì‚¬í•˜ì§€ ì•Šë„ë¡ í•˜ë ¤ë©´ ì–´ë–»ê²Œ êµ¬ì„±í•´ì•¼ í• ê¹Œ?

Q2: ìŠ¤ìº” ì‹¤íŒ¨ ì‹œ CVC APIì˜ ì „ì²´ ì‘ë‹µ ë¡œê·¸ë¥¼ ì•ˆì „í•˜ê²Œ ë‚¨ê¸°ê³  ì‹¶ë‹¤ë©´ ì–´ë–¤ ë°©ì‹ì´ ì ì ˆí• ê¹Œ?

Q3: ì•…ì„±ì½”ë“œ ê²€ì‚¬ ê²°ê³¼ë¥¼ DBì— ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œì„ í™•ì¥í•˜ë ¤ë©´ ì–´ë–¤ í…Œì´ë¸” ì„¤ê³„ê°€ ì ì ˆí• ê¹Œ?

