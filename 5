package com.cvc.scanner.controller;

import com.cvc.scanner.dto.FileDto;
import com.cvc.scanner.service.V3ScannerService;
import jakarta.servlet.http.HttpServletRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.InputStream;
import java.util.Random;

import org.springframework.http.HttpStatus;
import jakarta.validation.Valid;
import org.springframework.web.multipart.MultipartFile;

import java.util.Map;

@RestController
@RequestMapping("/api/v1/scanner")
public class V3ScannerController {

    private static final Logger logger = LoggerFactory.getLogger(V3ScannerController.class);

    @Autowired
    private V3ScannerService v3ScannerService;

    @GetMapping("/simple")
    public ResponseEntity<Map<String, Object>> simpleScan(@RequestHeader("X-CVC-API-KEY") String apiKey, @RequestParam String fileName) {
        logger.info("Simple scan requested. Filename: {}, API Key: {}", fileName, apiKey);
        if (v3ScannerService.validateApiKey(apiKey)) {
            logger.warn("Unauthorized access attempt with API Key: {}", apiKey);
            return ResponseEntity.status(401).body(Map.of("error", "Unauthorized", "message", "Invalid API Key"));
        }
        return ResponseEntity.ok(v3ScannerService.simpleScan(fileName));
    }

    @GetMapping("/remote")
    public ResponseEntity<Map<String, Object>> remoteScan(@RequestHeader("X-CVC-API-KEY") String apiKey, @RequestParam String fileName) {
        logger.info("Remote scan requested. Filename: {}, API Key: {}", fileName, apiKey);
        if (v3ScannerService.validateApiKey(apiKey)) {
            logger.warn("Unauthorized access attempt with API Key: {}", apiKey);
            return ResponseEntity.status(401).body(Map.of("error", "Unauthorized", "message", "Invalid API Key"));
        }
        return ResponseEntity.ok(v3ScannerService.remoteScan(fileName));
    }

    @GetMapping("/detail")
    public ResponseEntity<Map<String, Object>> detailScan(@RequestHeader("X-CVC-API-KEY") String apiKey, @RequestParam String fileName) {
        logger.info("Detail scan requested. Filename: {}, API Key: {}", fileName, apiKey);
        if (v3ScannerService.validateApiKey(apiKey)) {
            logger.warn("Unauthorized access attempt with API Key: {}", apiKey);
            return ResponseEntity.status(401).body(Map.of("error", "Unauthorized", "message", "Invalid API Key"));
        }
        return ResponseEntity.ok(v3ScannerService.detailScan(fileName));
    }


    @PostMapping("/base64-scan")
    public ResponseEntity<FileDto.Response> scanFile(
            @RequestHeader("X-CVC-API-KEY") String apiKey,
            @Valid @RequestBody FileDto.Request fileDtoRequest) {
        logger.info("File scan requested. Filename: {}, API Key: {}", fileDtoRequest.getFileName(), apiKey);
        if (v3ScannerService.validateApiKey(apiKey)) {
            logger.warn("Unauthorized access attempt with API Key: {}", apiKey);
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                    FileDto.Response.builder()
                            .fileName(fileDtoRequest.getFileName())
                            .returnCode(HttpStatus.UNAUTHORIZED.value())
                            .message("Unauthorized: Invalid API Key")
                            .build()
            );
        }
        FileDto.Response response = v3ScannerService.scanBase64File(fileDtoRequest);
        return ResponseEntity.status(HttpStatus.OK).body(response);
    }

    @PostMapping(value = "/multipart-scan", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<FileDto.Response> scanMultipartFile(
            @RequestHeader("X-CVC-API-KEY") String apiKey,
            @RequestPart("file") MultipartFile file) {

        logger.info("Multipart file scan requested. Filename: {}, API Key: {}", file.getOriginalFilename(), apiKey);
        if (v3ScannerService.validateApiKey(apiKey)) {
            logger.warn("Unauthorized access attempt with API Key: {}", apiKey);
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                    FileDto.Response.builder()
                            .fileName(file.getOriginalFilename())
                            .returnCode(HttpStatus.UNAUTHORIZED.value())
                            .message("Unauthorized: Invalid API Key")
                            .build()
            );
        }
        FileDto.Response response = v3ScannerService.scanMultipartFile(file);
        return ResponseEntity.status(HttpStatus.OK).body(response);
    }

    @PostMapping(value = "/binary-scan", consumes = MediaType.APPLICATION_OCTET_STREAM_VALUE)
    public ResponseEntity<FileDto.Response> scanBinaryFile(
            @RequestHeader("X-CVC-API-KEY") String apiKey,
            @RequestHeader("File-Name") String fileName,
            HttpServletRequest request) {

        if (v3ScannerService.validateApiKey(apiKey)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                    FileDto.Response.builder()
                            .fileName(fileName)
                            .returnCode(HttpStatus.UNAUTHORIZED.value())
                            .message("Unauthorized: Invalid API Key")
                            .build()
            );
        }

        try (InputStream inputStream = request.getInputStream()) {
            FileDto.Response response = v3ScannerService.scanBinaryFile(fileName, inputStream);
            return ResponseEntity.status(HttpStatus.OK).body(response);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    FileDto.Response.builder()
                            .fileName(fileName)
                            .returnCode(-1)
                            .message("Error processing file: " + e.getMessage())
                            .build()
            );
        }
    }

    @PostMapping(value = "/upload-chunk", consumes = MediaType.APPLICATION_OCTET_STREAM_VALUE)
    public ResponseEntity<String> uploadChunk(
            @RequestHeader("File-Id") String fileId,  // 파일 ID
            @RequestHeader("Chunk-Index") int chunkIndex,  // 청크 인덱스
            @RequestHeader("Total-Chunks") int totalChunks,  // 전체 청크 개수
            @RequestBody byte[] chunkData) {  // 청크 데이터

        try {
            v3ScannerService.saveChunk(fileId, chunkIndex, chunkData);
            return ResponseEntity.ok("Chunk uploaded successfully.");
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Chunk upload failed: " + e.getMessage());
        }
    }

    /**
     * 병합 및 스캔 엔드포인트
     */
    @PostMapping("/merge-chunks")
    public ResponseEntity<FileDto.Response> mergeChunksAndScan(
            @RequestHeader("File-Id") String fileId,  // 파일 ID
            @RequestHeader("File-Name") String fileName) {  // 원래 파일 이름

        try {
            FileDto.Response response = v3ScannerService.mergeChunksAndScan(fileId, fileName);
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    FileDto.Response.builder()
                            .fileName(fileName)
                            .returnCode(-1)
                            .message("Failed to merge and scan chunks: " + e.getMessage())
                            .build()
            );
        }
    }

    @GetMapping("/status")
    public ResponseEntity<FileDto.Response> getStatus() {
        logger.info("API status requested.");
        String[] fileNames = {"TestFile", "TestFolder","TestZip","Wow","Hello"};
        Random random = new Random();
        String fileName=fileNames[random.nextInt(fileNames.length)];
        return ResponseEntity.status(HttpStatus.OK).body(
                FileDto.Response.builder()
                        .fileName(fileName)
                        .returnCode(0)
                        .message("API is running")
                        .build()
        );
    }

    @PostMapping("/status")
    public ResponseEntity<FileDto.Response> modifyStatus(
            @RequestHeader("File-Id") String fileId,  // 파일 ID
            @RequestHeader("File-Name") String fileName) {
        logger.info("Post메소드가 호출되었습니다.");
        String[] numbers = {"0","1"};
        Random random = new Random();
        String number=numbers[random.nextInt(numbers.length)];
        return ResponseEntity.status(HttpStatus.OK).body(
                FileDto.Response.builder()
                        .fileName(fileName)
                        .returnCode(Integer.parseInt(number))
                        .message("File ID is : " + fileId)
                        .build()
        );
    }

    @GetMapping("/test")
    public ResponseEntity<FileDto.Response> callTest(
            @RequestHeader("File-Id") String fileId,  // 파일 ID
            @RequestHeader("File-Name") String fileName) {
        logger.info("TEST API is Called. 파일ID는 " + fileId +" 이고, 파일이름은 " + fileName + " 입니다.");
        return ResponseEntity.status(HttpStatus.OK).body(
                FileDto.Response.builder()
                        .fileName(fileName)
                        .returnCode(-1)
                        .message("마지막으로 파일ID는 " + fileId)
                        .build()
        );
    }
}
