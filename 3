PR 1: ë¦¬íŒ©í† ë§ - ì„œë¹„ìŠ¤ ê³„ì¸µ ê°œì„  ë° ì¤‘ë³µ ì½”ë“œ ì œê±°
í•µì‹¬ ë³€ê²½ ì‚¬í•­
ë©”ì†Œë“œ ë¶„ë¦¬ ë° SRP(ë‹¨ì¼ ì±…ì„ ì›ì¹™) ì ìš©
ì¤‘ë³µ ì½”ë“œ ì œê±°
ìœ íš¨ì„± ê²€ì‚¬ ë©”ì†Œë“œ ê°œì„ 
ë¶ˆí•„ìš”í•œ Optional ì²˜ë¦¬ ì œê±°
ê¸°ë³¸ ì½”ë“œ ìƒì„± ë©”ì†Œë“œ ê°œì„ 
1. registerFunction ë©”ì†Œë“œ ê°œì„ 
ê°œì„  ì „ ë¬¸ì œì :

registerFunctionì—ì„œ ì—¬ëŸ¬ ì—­í• ì„ ìˆ˜í–‰ (ìœ íš¨ì„± ê²€ì‚¬, ì¤‘ë³µ í™•ì¸, ì €ì¥, ì´ˆê¸°í™” ë“±)
validationCheckFunctionName, validationCheckFunctionArgs ë“±ì—ì„œ ì¤‘ë³µ ê²€ì‚¬
í•¨ìˆ˜ ìƒì„± í›„ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ëŠ” setEnvironmentê°€ í•¨ìˆ˜ ë‚´ì—ì„œ ì§ì ‘ í˜¸ì¶œë¨ â†’ ì„œë¹„ìŠ¤ì˜ ì—­í• ê³¼ ë§ì§€ ì•ŠìŒ
ê°œì„  í›„ ì ìš© ë‚´ìš©:

ìœ íš¨ì„± ê²€ì‚¬ ë©”ì†Œë“œ ë¶„ë¦¬ (validateFunctionRequest)
ì¤‘ë³µ ì²´í¬ ë¶„ë¦¬ (isFunctionExists)
í™˜ê²½ ì„¤ì • ë¡œì§ì„ ë³„ë„ ë©”ì†Œë“œë¡œ ì´ë™ (initializeFunction)
ì¤‘ë³µëœ ë¡œì§ ì œê±°
java
ë³µì‚¬
í¸ì§‘
@Transactional
public FunctionDTO.Response registerFunction(FunctionDTO.Register reqDto) throws IOException, ParseException {
    validateFunctionRequest(reqDto);

    if (isFunctionExists(reqDto.getFunctionKey(), reqDto.getDisplayName(), reqDto.getProjectId())) {
        throw new RuntimeException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‘ì…˜ í‚¤ ë˜ëŠ” í‘ì…˜ëª…ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }

    reqDto.setName(generateFunctionName());
    reqDto.setFunctionStatus(TypeEnums.FunctionStatus.NOT_READY.getKey());

    if (!reqDto.getRuntime().startsWith("Java")) {
        reqDto.setContent(generateBaseCode(reqDto));
    }

    Function function = functionRepository.save(Function.register(reqDto));
    initializeFunction(function, reqDto);

    return function.toDto();
}

private void validateFunctionRequest(FunctionDTO.Register reqDto) {
    if (StringUtils.isEmpty(reqDto.getFunctionKey()) || StringUtils.isEmpty(reqDto.getProjectId()) 
        || StringUtils.isEmpty(reqDto.getUserId()) || StringUtils.isEmpty(reqDto.getEndPointType()) 
        || StringUtils.isEmpty(reqDto.getRuntime())) {
        throw new RuntimeException("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

private boolean isFunctionExists(String functionKey, String displayName, String projectId) {
    return functionRepository.findByFunctionKeyAndDelYn(functionKey, "N").isPresent() ||
           functionRepository.existsByDisplayNameAndProjectIdAndDelYn(displayName, projectId, "N");
}

private String generateFunctionName() {
    return "scf-" + UUID.randomUUID() + "-api";
}

private void initializeFunction(Function function, FunctionDTO.Register reqDto) {
    setEnvironment(function);

    if (!CollectionUtils.isEmpty(reqDto.getAllowIps())) {
        reqDto.getAllowIps().forEach(allowIp -> allowIpService.registerAllowIp(allowIp, function.getFunctionSeq()));
    }

    triggerService.createDefaultTrigger(function);

    if (function.getRuntime().startsWith("Java")) {
        SourceFileDTO.Register sampleDto = new SourceFileDTO.Register();
        sampleDto.setSourceFileType("sample");
        sourceFileService.saveSourceFile(sampleDto, function.getFunctionKey());
    }
}
ê°œì„ ëœ ì 
âœ… SRP(ë‹¨ì¼ ì±…ì„ ì›ì¹™) ì ìš©:

í•¨ìˆ˜ì˜ ì—­í• ì„ ì„¸ë¶„í™”í•˜ì—¬ ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„±ì„ í–¥ìƒ
âœ… ì¤‘ë³µ ì½”ë“œ ì œê±°:
ê¸°ì¡´ì˜ validationCheckFunctionArgs ë° validationCheckFunctionNameë¥¼ ë‹¨ìˆœí™”
âœ… ë©”ì†Œë“œ í¬ê¸° ì¶•ì†Œ:
registerFunctionì˜ ê¸¸ì´ê°€ ì§§ì•„ì§€ê³ , ê°€ë…ì„±ì´ í–¥ìƒë¨
2. registerFunctionCode ë©”ì†Œë“œ ê°œì„ 
ê°œì„  ì „ ë¬¸ì œì :

function.isReady() ê²€ì‚¬ í›„, ì§ì ‘ ì €ì¥í•˜ëŠ” ë¡œì§ì´ ì¤‘ë³µë˜ì–´ ìˆìŒ
í•¨ìˆ˜ê°€ ë°°í¬ ê°€ëŠ¥í•  ë•Œë§Œ knativeService.callIstioAndKnativeë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ì§€ë§Œ, ë³„ë„ ì²˜ë¦¬ ì—†ì´ í•­ìƒ í˜¸ì¶œë¨
ê°œì„  í›„ ì ìš© ë‚´ìš©:

ë°°í¬ ê°€ëŠ¥ ìƒíƒœ í™•ì¸ ë©”ì†Œë“œ ì¶”ê°€ (shouldDeployFunction)
ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¶„ë¦¬ (updateFunctionStatus)
ë°°í¬ ë¡œì§ì„ ë³„ë„ ë©”ì†Œë“œë¡œ ì´ë™ (deployFunction)
java
ë³µì‚¬
í¸ì§‘
@Transactional
public FunctionDTO.Response registerFunctionCode(FunctionDTO.Register reqDto, String functionKey) throws IOException, ParseException {
    Function function = functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new ResourceNotFoundException("í‘ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    function.updateContent(reqDto.getContent());

    if (shouldDeployFunction(function)) {
        deployFunction(function);
    }

    return function.toDto();
}

private boolean shouldDeployFunction(Function function) {
    return function.isReady();
}

private void deployFunction(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
    knativeService.callIstioAndKnative(function);
}
ê°œì„ ëœ ì 
âœ… ë°°í¬ ì—¬ë¶€ íŒë‹¨ì„ ë³„ë„ ë©”ì†Œë“œë¡œ ë¶„ë¦¬:

shouldDeployFunctionë¥¼ ì‚¬ìš©í•´ ë…¼ë¦¬ ëª…í™•í™”
âœ… ë°°í¬ ë¡œì§ì„ deployFunctionìœ¼ë¡œ ë¶„ë¦¬:
ì¤‘ë³µ ì œê±° ë° í•¨ìˆ˜ í¬ê¸° ì¶•ì†Œ
3. generateBaseCode ë©”ì†Œë“œ ê°œì„ 
ê°œì„  ì „ ë¬¸ì œì :

codeNameì´ ë¹„ì–´ ìˆëŠ” ê²½ìš° default ê°’ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ë¶ˆí•„ìš”í•œ if-else ì¤‘ì²©ì´ ìˆìŒ
findByRuntimeAndVersionAndDefaultYnì™€ findByRuntimeAndVersionAndCodeNameì„ í•˜ë‚˜ì˜ ë¡œì§ìœ¼ë¡œ í•©ì¹  ìˆ˜ ìˆìŒ
ê°œì„  í›„ ì ìš© ë‚´ìš©:

ê¸°ë³¸ ê°’ ì„¤ì • ë¡œì§ ê°œì„ 
ì¤‘ë³µëœ if-else êµ¬ì¡° ì œê±°
java
ë³µì‚¬
í¸ì§‘
private String generateBaseCode(FunctionDTO.Register reqDto) {
    String[] array = reqDto.getRuntime().split(":");
    String runtime = array[0];
    String version = array[1];
    String codeName = StringUtils.defaultIfEmpty(reqDto.getCodeName(), "default");

    FunctionCode functionCode = functionCodeRepository.findByRuntimeAndVersionAndCodeName(runtime, version, codeName)
            .orElseThrow(() -> new ResourceNotFoundException("ìš”ì²­ëœ ì½”ë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    return functionCode.getCodeContent();
}
ê°œì„ ëœ ì 
âœ… ì¤‘ë³µëœ ë¡œì§ ì œê±°:

findByRuntimeAndVersionAndDefaultYnì™€ findByRuntimeAndVersionAndCodeNameì„ í•˜ë‚˜ë¡œ í†µí•©
âœ… StringUtils.defaultIfEmpty í™œìš©:
codeNameì´ ë¹„ì–´ ìˆì„ ë•Œ ê¸°ë³¸ê°’ì„ ì„¤ì •í•˜ëŠ” ë¡œì§ì„ ê°„ê²°í•˜ê²Œ ê°œì„ 
PR 1 ìš”ì•½
âœ… ë©”ì†Œë“œ ì—­í•  ë¶„ë¦¬ë¡œ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
âœ… ì¤‘ë³µ ì½”ë“œ ì œê±°ë¡œ ì½”ë“œ ê°„ê²°í™”
âœ… ë©”ì†Œë“œ í¬ê¸° ì¶•ì†Œ ë° ê°€ë…ì„± ê°œì„ 
âœ… ì˜ë¯¸ê°€ ëª…í™•í•œ ë©”ì†Œë“œ ëª…ëª…ìœ¼ë¡œ ì½”ë“œ ì´í•´ë„ ìƒìŠ¹








PR 1: ì„œë¹„ìŠ¤ ê³„ì¸µ ê°œì„  ë° ì¤‘ë³µ ì½”ë“œ ì œê±°
ğŸ”¹ ì£¼ìš” ë³€ê²½ ì‚¬í•­ ìš”ì•½
registerFunction ë©”ì†Œë“œ ë¦¬íŒ©í† ë§
ì—­í• ì„ ì„¸ë¶„í™”í•˜ì—¬ ìœ íš¨ì„± ê²€ì‚¬, ì¤‘ë³µ í™•ì¸, ì´ˆê¸°í™” ë¡œì§ ë¶„ë¦¬
ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ê°€ë…ì„± ê°œì„ 
registerFunctionCode ë©”ì†Œë“œ ë¦¬íŒ©í† ë§
ë°°í¬ ì—¬ë¶€ íŒë‹¨ì„ shouldDeployFunction ë©”ì†Œë“œë¡œ ë¶„ë¦¬
ë°°í¬ ë¡œì§ì„ deployFunction ë©”ì†Œë“œë¡œ ì´ë™í•˜ì—¬ ì¤‘ë³µ ì œê±°
generateBaseCode ë©”ì†Œë“œ ê°œì„ 
ê¸°ë³¸ ì½”ë“œ ì¡°íšŒ ë¡œì§ì„ ê°„ê²°í™” (defaultIfEmpty í™œìš©)
findByRuntimeAndVersionAndDefaultYnì™€ findByRuntimeAndVersionAndCodeNameì„ í•˜ë‚˜ì˜ ë¡œì§ìœ¼ë¡œ í†µí•©
ğŸ“Œ ë³€ê²½ëœ ë©”ì†Œë“œ ìƒì„¸ ì„¤ëª…
1ï¸âƒ£ registerFunction ë©”ì†Œë“œ ë¦¬íŒ©í† ë§
ğŸ”¹ ë³€ê²½ ì „ ë¬¸ì œì 
registerFunction ë©”ì†Œë“œê°€ ë„ˆë¬´ ë§ì€ ì—­í• ì„ ìˆ˜í–‰
ìœ íš¨ì„± ê²€ì‚¬
ì¤‘ë³µ í™•ì¸
í•¨ìˆ˜ ìƒì„± ë° ì €ì¥
í™˜ê²½ ì„¤ì • ë° Allow IP ë“±ë¡
ê¸°ë³¸ íŠ¸ë¦¬ê±° ìƒì„±
Java Runtime ì´ˆê¸° ì½”ë“œ ë“±ë¡
ì´ëŸ¬í•œ ê³¼ë„í•œ ì±…ì„ì€ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ìœ„ë°°
ì¤‘ë³µëœ ë¡œì§ì´ ë§ì•„ ê°€ë…ì„±ì´ ë–¨ì–´ì§
âœ… ë³€ê²½ í›„ ê°œì„ ì 
ìœ íš¨ì„± ê²€ì‚¬ ë¶„ë¦¬ â†’ validateFunctionRequest
ì¤‘ë³µ ê²€ì‚¬ ë¶„ë¦¬ â†’ isFunctionExists
í•¨ìˆ˜ ì´ˆê¸°í™” ë¡œì§ ë¶„ë¦¬ â†’ initializeFunction
í•¨ìˆ˜ëª… ìƒì„± ë¡œì§ ë¶„ë¦¬ â†’ generateFunctionName
í™˜ê²½ ì„¤ì • ë¡œì§ì„ ë³„ë„ ë©”ì†Œë“œë¡œ ì´ë™
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public FunctionDTO.Response registerFunction(FunctionDTO.Register reqDto) throws IOException, ParseException {
    validateFunctionRequest(reqDto);

    if (isFunctionExists(reqDto.getFunctionKey(), reqDto.getDisplayName(), reqDto.getProjectId())) {
        throw new RuntimeException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‘ì…˜ í‚¤ ë˜ëŠ” í‘ì…˜ëª…ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }

    reqDto.setName(generateFunctionName());
    reqDto.setFunctionStatus(TypeEnums.FunctionStatus.NOT_READY.getKey());

    if (!reqDto.getRuntime().startsWith("Java")) {
        reqDto.setContent(generateBaseCode(reqDto));
    }

    Function function = functionRepository.save(Function.register(reqDto));
    initializeFunction(function, reqDto);

    return function.toDto();
}

// ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ì„ ë³„ë„ ë©”ì†Œë“œë¡œ ì´ë™
private void validateFunctionRequest(FunctionDTO.Register reqDto) {
    if (StringUtils.isEmpty(reqDto.getFunctionKey()) || StringUtils.isEmpty(reqDto.getProjectId()) 
        || StringUtils.isEmpty(reqDto.getUserId()) || StringUtils.isEmpty(reqDto.getEndPointType()) 
        || StringUtils.isEmpty(reqDto.getRuntime())) {
        throw new RuntimeException("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

// ì¤‘ë³µ ê²€ì‚¬ ë¡œì§ ë¶„ë¦¬
private boolean isFunctionExists(String functionKey, String displayName, String projectId) {
    return functionRepository.findByFunctionKeyAndDelYn(functionKey, "N").isPresent() ||
           functionRepository.existsByDisplayNameAndProjectIdAndDelYn(displayName, projectId, "N");
}

// í•¨ìˆ˜ëª… ìƒì„± ë¡œì§ ë¶„ë¦¬
private String generateFunctionName() {
    return "scf-" + UUID.randomUUID() + "-api";
}

// í™˜ê²½ ë³€ìˆ˜ ì„¤ì •, Allow IP ë“±ë¡ ë“± ì´ˆê¸°í™” ë¡œì§ ë¶„ë¦¬
private void initializeFunction(Function function, FunctionDTO.Register reqDto) {
    setEnvironment(function);

    if (!CollectionUtils.isEmpty(reqDto.getAllowIps())) {
        reqDto.getAllowIps().forEach(allowIp -> allowIpService.registerAllowIp(allowIp, function.getFunctionSeq()));
    }

    triggerService.createDefaultTrigger(function);

    if (function.getRuntime().startsWith("Java")) {
        SourceFileDTO.Register sampleDto = new SourceFileDTO.Register();
        sampleDto.setSourceFileType("sample");
        sourceFileService.saveSourceFile(sampleDto, function.getFunctionKey());
    }
}
2ï¸âƒ£ registerFunctionCode ë©”ì†Œë“œ ë¦¬íŒ©í† ë§
ğŸ”¹ ë³€ê²½ ì „ ë¬¸ì œì 
function.isReady() ê²€ì‚¬ í›„ ì§ì ‘ ì €ì¥í•˜ëŠ” ë¡œì§ì´ ì¤‘ë³µë¨
knativeService.callIstioAndKnative í˜¸ì¶œ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” ì½”ë“œê°€ ì§ê´€ì ì´ì§€ ì•ŠìŒ
function.setFunctionStatus ë¡œì§ì´ ì—¬ëŸ¬ ê³³ì—ì„œ ì‚¬ìš©ë¨ â†’ ë³„ë„ ë©”ì†Œë“œë¡œ ë¶„ë¦¬ í•„ìš”
âœ… ë³€ê²½ í›„ ê°œì„ ì 
ë°°í¬ ì—¬ë¶€ íŒë‹¨ì„ shouldDeployFunction ë©”ì†Œë“œë¡œ ë¶„ë¦¬
ë°°í¬ ë¡œì§ì„ deployFunction ë©”ì†Œë“œë¡œ ì´ë™í•˜ì—¬ ì¤‘ë³µ ì œê±°
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
@Transactional
public FunctionDTO.Response registerFunctionCode(FunctionDTO.Register reqDto, String functionKey) throws IOException, ParseException {
    Function function = functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new ResourceNotFoundException("í‘ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    function.updateContent(reqDto.getContent());

    if (shouldDeployFunction(function)) {
        deployFunction(function);
    }

    return function.toDto();
}

// ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨ ë©”ì†Œë“œ
private boolean shouldDeployFunction(Function function) {
    return function.isReady();
}

// ë°°í¬ ì²˜ë¦¬ ë©”ì†Œë“œ
private void deployFunction(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
    knativeService.callIstioAndKnative(function);
}
3ï¸âƒ£ generateBaseCode ë©”ì†Œë“œ ê°œì„ 
ğŸ”¹ ë³€ê²½ ì „ ë¬¸ì œì 
codeNameì´ ë¹„ì–´ ìˆëŠ” ê²½ìš° "default" ê°’ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ë¶ˆí•„ìš”í•œ if-else ì¤‘ì²©ì´ ìˆìŒ
findByRuntimeAndVersionAndDefaultYnì™€ findByRuntimeAndVersionAndCodeNameì„ í•˜ë‚˜ì˜ ë¡œì§ìœ¼ë¡œ í•©ì¹  ìˆ˜ ìˆìŒ
âœ… ë³€ê²½ í›„ ê°œì„ ì 
ê¸°ë³¸ ì½”ë“œ ì¡°íšŒ ë¡œì§ì„ ê°„ê²°í™” (defaultIfEmpty í™œìš©)
findByRuntimeAndVersionAndDefaultYnì™€ findByRuntimeAndVersionAndCodeNameì„ í•˜ë‚˜ì˜ ë¡œì§ìœ¼ë¡œ í†µí•©
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
private String generateBaseCode(FunctionDTO.Register reqDto) {
    String[] array = reqDto.getRuntime().split(":");
    String runtime = array[0];
    String version = array[1];
    String codeName = StringUtils.defaultIfEmpty(reqDto.getCodeName(), "default");

    FunctionCode functionCode = functionCodeRepository.findByRuntimeAndVersionAndCodeName(runtime, version, codeName)
            .orElseThrow(() -> new ResourceNotFoundException("ìš”ì²­ëœ ì½”ë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    return functionCode.getCodeContent();
}
ğŸ“Œ PR 1 - ì „ì²´ ë³€ê²½ ì½”ë“œ
ì•„ë˜ëŠ” PR1ì„ ì ìš©í•œ ì „ì²´ ë¦¬íŒ©í† ë§ ì½”ë“œì…ë‹ˆë‹¤.

Refactored Function Service

ëŒ€ì‹  ì±„íŒ…ì—ì„œ ë‹µí•©ë‹ˆë‹¤
ğŸ”¹ PR 1 ìš”ì•½
âœ… ë©”ì†Œë“œ ì—­í•  ë¶„ë¦¬ë¡œ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
âœ… ì¤‘ë³µ ì½”ë“œ ì œê±°ë¡œ ì½”ë“œ ê°„ê²°í™”
âœ… ë©”ì†Œë“œ í¬ê¸° ì¶•ì†Œ ë° ê°€ë…ì„± ê°œì„ 
âœ… ì˜ë¯¸ê°€ ëª…í™•í•œ ë©”ì†Œë“œ ëª…ëª…ìœ¼ë¡œ ì½”ë“œ ì´í•´ë„ ìƒìŠ¹

ì´ì œ PR 2ì—ì„œëŠ” í´ë¦° ì½”ë“œ ì›ì¹™ì„ ì ìš©í•˜ì—¬ ì˜ˆì™¸ ì²˜ë¦¬ì™€ ì„œë¹„ìŠ¤ ê³„ì¸µì„ ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤. ğŸš€
PR 2ë¥¼ ì§„í–‰í• ê¹Œìš”?



@Transactional
public FunctionDTO.Response registerFunction(FunctionDTO.Register reqDto) throws IOException, ParseException {
    validateFunctionRequest(reqDto);

    if (isFunctionExists(reqDto.getFunctionKey(), reqDto.getDisplayName(), reqDto.getProjectId())) {
        throw new RuntimeException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‘ì…˜ í‚¤ ë˜ëŠ” í‘ì…˜ëª…ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }

    reqDto.setName(generateFunctionName());
    reqDto.setFunctionStatus(TypeEnums.FunctionStatus.NOT_READY.getKey());

    if (!reqDto.getRuntime().startsWith("Java")) {
        reqDto.setContent(generateBaseCode(reqDto));
    }

    Function function = functionRepository.save(Function.register(reqDto));
    initializeFunction(function, reqDto);

    return function.toDto();
}

private void validateFunctionRequest(FunctionDTO.Register reqDto) {
    if (StringUtils.isEmpty(reqDto.getFunctionKey()) || StringUtils.isEmpty(reqDto.getProjectId()) 
        || StringUtils.isEmpty(reqDto.getUserId()) || StringUtils.isEmpty(reqDto.getEndPointType()) 
        || StringUtils.isEmpty(reqDto.getRuntime())) {
        throw new RuntimeException("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

private boolean isFunctionExists(String functionKey, String displayName, String projectId) {
    return functionRepository.findByFunctionKeyAndDelYn(functionKey, "N").isPresent() ||
           functionRepository.existsByDisplayNameAndProjectIdAndDelYn(displayName, projectId, "N");
}

private String generateFunctionName() {
    return "scf-" + UUID.randomUUID() + "-api";
}

private void initializeFunction(Function function, FunctionDTO.Register reqDto) {
    setEnvironment(function);

    if (!CollectionUtils.isEmpty(reqDto.getAllowIps())) {
        reqDto.getAllowIps().forEach(allowIp -> allowIpService.registerAllowIp(allowIp, function.getFunctionSeq()));
    }

    triggerService.createDefaultTrigger(function);

    if (function.getRuntime().startsWith("Java")) {
        SourceFileDTO.Register sampleDto = new SourceFileDTO.Register();
        sampleDto.setSourceFileType("sample");
        sourceFileService.saveSourceFile(sampleDto, function.getFunctionKey());
    }
}

@Transactional
public FunctionDTO.Response registerFunctionCode(FunctionDTO.Register reqDto, String functionKey) throws IOException, ParseException {
    Function function = functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new ResourceNotFoundException("í‘ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    function.updateContent(reqDto.getContent());

    if (shouldDeployFunction(function)) {
        deployFunction(function);
    }

    return function.toDto();
}

private boolean shouldDeployFunction(Function function) {
    return function.isReady();
}

private void deployFunction(Function function) {
    function.setFunctionStatus(TypeEnums.FunctionStatus.DEPLOYING);
    functionRepository.save(function);
    knativeService.callIstioAndKnative(function);
}

private String generateBaseCode(FunctionDTO.Register reqDto) {
    String[] array = reqDto.getRuntime().split(":");
    String runtime = array[0];
    String version = array[1];
    String codeName = StringUtils.defaultIfEmpty(reqDto.getCodeName(), "default");

    FunctionCode functionCode = functionCodeRepository.findByRuntimeAndVersionAndCodeName(runtime, version, codeName)
            .orElseThrow(() -> new ResourceNotFoundException("ìš”ì²­ëœ ì½”ë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    return functionCode.getCodeContent();
}


