ğŸ”¹ ê°œì„ ëœ ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
package com.scf.manager.mvc.service;

import com.scf.manager.common.crd.*;
import io.fabric8.kubernetes.api.model.KubernetesResourceList;
import io.fabric8.kubernetes.client.KubernetesClient;
import io.fabric8.kubernetes.client.KubernetesClientBuilder;
import io.fabric8.kubernetes.client.dsl.MixedOperation;
import io.fabric8.kubernetes.client.dsl.Resource;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Slf4j
@Service
@RequiredArgsConstructor
public class FunctionRabbitMQService {

    private static final String NAMESPACE = "rabbitmq";
    private static final String CONNECTION_SECRET_NAME = "rabbitmq-cluster-secret-credentials";

    private MixedOperation<RabbitMQSource, KubernetesResourceList<RabbitMQSource>, Resource<RabbitMQSource>> getRabbitMQSourceClient(KubernetesClient client) {
        return client.resources(RabbitMQSource.class);
    }

    public void registerRabbitMQSource(String rabbitMQSourceName) {
        try (KubernetesClient client = new KubernetesClientBuilder().build()) {
            MixedOperation<RabbitMQSource, KubernetesResourceList<RabbitMQSource>, Resource<RabbitMQSource>> rabbitMQSourceClient = getRabbitMQSourceClient(client);

            RabbitMQSource rabbitMQSource = createRabbitMQSource(rabbitMQSourceName);

            // ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì‚­ì œ í›„ ìƒì„±
            rabbitMQSourceClient.inNamespace(NAMESPACE).withName(rabbitMQSourceName).delete();
            rabbitMQSourceClient.inNamespace(NAMESPACE).create(rabbitMQSource);
        } catch (Exception e) {
            log.error("Exception occurred in registerRabbitMQSource: {}", e.getMessage(), e);
            throw new RuntimeException(e);
        }
    }

    public void deleteRabbitMQSource(String rabbitMQSourceName) {
        try (KubernetesClient client = new KubernetesClientBuilder().build()) {
            MixedOperation<RabbitMQSource, KubernetesResourceList<RabbitMQSource>, Resource<RabbitMQSource>> rabbitMQSourceClient = getRabbitMQSourceClient(client);

            rabbitMQSourceClient.inNamespace(NAMESPACE).withName(rabbitMQSourceName).delete();
        } catch (Exception e) {
            log.error("Exception occurred in deleteRabbitMQSource: {}", e.getMessage(), e);
            throw new RuntimeException(e);
        }
    }

    private RabbitMQSource createRabbitMQSource(String rabbitMQSourceName) {
        RabbitMQSourceSpec rabbitMQSourceSpec = RabbitMQSourceSpec.builder()
                .rabbitmqClusterReference(
                        RabbitMQClusterReferenceSpec.builder()
                                .connectionSecret(
                                        ConnectionSecretSpec.builder()
                                                .name(CONNECTION_SECRET_NAME)
                                                .build()
                                )
                                .namespace(NAMESPACE)
                                .build()
                )
                .rabbitMQResourcesConfig(
                        RabbitMQResourcesConfigSpec.builder()
                                .exchangeName(rabbitMQSourceName)
                                .parallelism(1)
                                .queueName(rabbitMQSourceName)
                                .predeclared(false)
                                .build()
                )
                .sink(
                        SinkSpec.builder()
                                .ref(
                                        RefSpec.builder()
                                                .apiVersion("serving.knative.dev/v1")
                                                .kind("Service")
                                                .name("scf-d79013ae-bb79-445d-be77-f0c9b4a78e8f-api")
                                                .namespace("scf-d79013ae-bb79-445d-be77-f0c9b4a78e8f-api")
                                                .build()
                                )
                                .build()
                )
                .build();

        RabbitMQSource rabbitMQSource = new RabbitMQSource();
        rabbitMQSource.getMetadata().setName(rabbitMQSourceName);
        rabbitMQSource.getMetadata().setNamespace(NAMESPACE);
        rabbitMQSource.setSpec(rabbitMQSourceSpec);

        return rabbitMQSource;
    }
}
ğŸ“Œ ê°œì„  ì‚¬í•­ ë° ì´ìœ 
ê° ë©”ì†Œë“œ ë‹¨ìœ„ë¡œ ì–´ë–¤ ì ì„ ê°œì„ í–ˆëŠ”ì§€ ìì„¸íˆ ì„¤ëª…í•˜ê² ë‹¤.

1ï¸âƒ£ registerRabbitMQSource() ë©”ì†Œë“œ ê°œì„ 
ğŸ”º ê¸°ì¡´ ì½”ë“œ ë¬¸ì œì 
RabbitMQSourceSpec ìƒì„± ë¡œì§ì´ registerRabbitMQSource() ë‚´ì— í¬í•¨ë˜ì–´ ìˆì–´, ë©”ì†Œë“œê°€ ë„ˆë¬´ ê¸¸ì–´ì§ â†’ SRP(Single Responsibility Principle) ìœ„ë°˜
NAMESPACEì™€ CONNECTION_SECRET_NAME ê°™ì€ ê°’ì´ í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŒ â†’ Magic String ì‚¬ìš©
ì˜ˆì™¸ ì²˜ë¦¬ ì‹œ e.getStackTrace()[0]ì„ ì‚¬ìš©í•˜ì—¬ ì˜ˆì™¸ ìœ„ì¹˜ë¥¼ ë¡œê¹…í•˜ëŠ”ë°, ìŠ¤íƒì˜ ì²« ë²ˆì§¸ ìš”ì†Œë§Œ ì¶œë ¥í•˜ëŠ” ê²ƒì€ ë¶€ì ì ˆí•˜ë©° ì „ì²´ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ ë¡œê¹…í•˜ëŠ” ê²ƒì´ ë” íš¨ê³¼ì ì„
KubernetesClientë¥¼ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ëŠ” ê²ƒì´ ë°˜ë³µë¨
ğŸ›  ê°œì„  ì‘ì—…
createRabbitMQSource() ë©”ì†Œë“œë¥¼ ë¶„ë¦¬í•˜ì—¬, RabbitMQSourceSpecì„ ìƒì„±í•˜ëŠ” ì±…ì„ì„ ë³„ë„ë¡œ ë¶„ë¦¬ â†’ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì¤€ìˆ˜
NAMESPACEì™€ CONNECTION_SECRET_NAMEì„ static final ìƒìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ Magic String ì œê±°
e.getStackTrace()[0] ëŒ€ì‹  e.getMessage()ì™€ Throwableì„ ë¡œê·¸ë¡œ ë‚¨ê²¨ ì „ì²´ ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ê°œì„ 
getRabbitMQSourceClient() ë©”ì†Œë“œë¥¼ ì¶”ê°€í•˜ì—¬ MixedOperation ê°ì²´ë¥¼ ì¬ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
2ï¸âƒ£ deleteRabbitMQSource() ë©”ì†Œë“œ ê°œì„ 
ğŸ”º ê¸°ì¡´ ì½”ë“œ ë¬¸ì œì 
KubernetesClientë¥¼ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ëŠ” ê²ƒì´ ì¤‘ë³µë¨
e.getStackTrace()[0]ì„ í†µí•œ ì˜ˆì™¸ ì²˜ë¦¬ ë°©ì‹ì´ ì ì ˆí•˜ì§€ ì•ŠìŒ
ğŸ›  ê°œì„  ì‘ì—…
getRabbitMQSourceClient() ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ì½”ë“œ ì œê±°
ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ë³´ë‹¤ ëª…í™•í•˜ê²Œ ì¶œë ¥í•˜ê³ , Throwableì„ í•¨ê»˜ ë¡œê¹…í•˜ì—¬ ì „ì²´ì ì¸ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½
3ï¸âƒ£ createRabbitMQSource() ë©”ì†Œë“œ ì¶”ê°€
ğŸ”º ê¸°ì¡´ ì½”ë“œ ë¬¸ì œì 
RabbitMQSourceSpecì„ ìƒì„±í•˜ëŠ” ì½”ë“œê°€ registerRabbitMQSource() ë‚´ì— ìˆì–´, ë©”ì†Œë“œê°€ ë„ˆë¬´ ë³µì¡í•˜ê³  ê¸¸ì–´ì§
RabbitMQSource ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì´ ì¤‘ë³µì ìœ¼ë¡œ í¬í•¨ë¨
ğŸ›  ê°œì„  ì‘ì—…
createRabbitMQSource() ë©”ì†Œë“œë¥¼ ë³„ë„ë¡œ ì •ì˜í•˜ì—¬ ê°ì²´ ìƒì„±ì˜ ì±…ì„ì„ ë¶„ë¦¬í•˜ê³ , registerRabbitMQSource()ì—ì„œì˜ ì—­í• ì„ ë‹¨ìˆœí™”í•¨
4ï¸âƒ£ getRabbitMQSourceClient() ë©”ì†Œë“œ ì¶”ê°€
ğŸ”º ê¸°ì¡´ ì½”ë“œ ë¬¸ì œì 
KubernetesClientë¥¼ ìƒì„±í•œ í›„, MixedOperation<RabbitMQSource, KubernetesResourceList<RabbitMQSource>, Resource<RabbitMQSource>> ê°ì²´ë¥¼ ë§¤ë²ˆ ìƒì„±í•´ì•¼ í–ˆìŒ
ğŸ›  ê°œì„  ì‘ì—…
getRabbitMQSourceClient() ë©”ì†Œë“œë¥¼ ì¶”ê°€í•˜ì—¬ MixedOperationì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ë¶„ë¦¬í•˜ì—¬ ì¤‘ë³µ ì½”ë“œ ì œê±°
ğŸ“Œ ë¦¬íŒ©í† ë§ ê²°ê³¼ ìš”ì•½
ë³€ê²½ ë‚´ìš©	ê°œì„  ì „	ê°œì„  í›„
Magic String ì œê±°	"rabbitmq" ë“±ì˜ í•˜ë“œì½”ë”©ëœ ë¬¸ìì—´ ì¡´ì¬	static final ìƒìˆ˜ ì‚¬ìš©
ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì¤€ìˆ˜	registerRabbitMQSource()ì—ì„œ ëª¨ë“  ì²˜ë¦¬ë¥¼ ìˆ˜í–‰	createRabbitMQSource()ë¡œ RabbitMQSource ìƒì„± ë¡œì§ ë¶„ë¦¬
ì¤‘ë³µ ì½”ë“œ ì œê±°	MixedOperationì„ ìƒì„±í•˜ëŠ” ì½”ë“œê°€ ì—¬ëŸ¬ ê³³ì— ì¡´ì¬	getRabbitMQSourceClient() ë©”ì†Œë“œ ì¶”ê°€
ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ 	e.getStackTrace()[0]ìœ¼ë¡œ ë¡œê¹…	e.getMessage()ì™€ ì „ì²´ Throwable ë¡œê¹…
ë©”ì†Œë“œ ê°€ë…ì„± í–¥ìƒ	ê¸´ ì½”ë“œ ë¸”ë¡ ì¡´ì¬	ë©”ì†Œë“œ ë¶„ë¦¬ë¡œ ì—­í•  ëª…í™•í™”
âœ… ê¸°ëŒ€ë˜ëŠ” íš¨ê³¼
ì½”ë“œê°€ ë³´ë‹¤ ê°€ë…ì„±ì´ ì¢‹ì•„ì§€ê³  ìœ ì§€ë³´ìˆ˜ì„±ì´ í–¥ìƒë¨
registerRabbitMQSource() ë©”ì†Œë“œê°€ ë³´ë‹¤ ëª…í™•í•œ ì±…ì„ì„ ê°€ì§€ê²Œ ë¨
ì¤‘ë³µ ì½”ë“œ ì œê±°ë¡œ ì¸í•´ ì½”ë“œ ì¬ì‚¬ìš©ì„± ì¦ê°€
ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ë³´ë‹¤ ì•ˆì „í•˜ê³  ëª…í™•í•˜ê²Œ ìˆ˜í–‰í•˜ì—¬, ë””ë²„ê¹…ì´ ìš©ì´í•´ì§
ì´ì œ ì½”ë“œê°€ ë³´ë‹¤ í´ë¦°í•˜ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì¢‹ì€ í˜•íƒœê°€ ë˜ì—ˆë‹¤. ì¶”ê°€ì ì¸ ê°œì„ ì´ í•„ìš”í•˜ë©´ ë” ë§í•´ì¤˜!
