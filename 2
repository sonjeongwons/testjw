ë„¤, handleInvalidLatencyValues ë©”ì†Œë“œë¥¼ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ê¸°ì¡´ ì½”ë“œì—ì„œ RequestLatencyMetricInvalidValueHandling ë©”ì†Œë“œëŠ” NaN, Inf ê°™ì€ ê°’ì„ "0"ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ì„ í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì˜ë¯¸ê°€ ëª…í™•í•œ ë©”ì†Œë“œëª…ìœ¼ë¡œ ë³€ê²½í•˜ê³ , ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤.


---

âœ… handleInvalidLatencyValues ë©”ì†Œë“œ ì •ì˜

1ï¸âƒ£ ê¸°ì¡´ RequestLatencyMetricInvalidValueHandling ë¬¸ì œì 

private void RequestLatencyMetricInvalidValueHandling(FunctionMetricElementsListDTO element){
    if(element.getData().getResult().size() > 0){
        if("NaN".equals(element.getData().getResult().get(0).getValue().get(1)) || "Inf".equals(element.getData().getResult().get(0).getValue().get(1))
                || "-Inf".equals(element.getData().getResult().get(0).getValue().get(1)) || "+Inf".equals(element.getData().getResult().get(0).getValue().get(1))){
            element.getData().getResult().get(0).getValue().set(1, "0");
        }
    }
}

âš ï¸ ê¸°ì¡´ ì½”ë“œì˜ ë¬¸ì œì 

1. ë©”ì†Œë“œëª…ì´ PascalCase (RequestLatencyMetricInvalidValueHandling)
â†’ Javaì˜ ì¼ë°˜ì ì¸ camelCase ìŠ¤íƒ€ì¼ì„ ë”°ë¥´ì§€ ì•ŠìŒ


2. if(element.getData().getResult().size() > 0) â†’ isEmpty()ë¥¼ ì‚¬ìš© ê°€ëŠ¥
â†’ ë” ì§ê´€ì ì´ê³  ê°„ê²°í•œ ì½”ë“œ ì‘ì„± ê°€ëŠ¥


3. ê°’ ê²€ì¦ì„ ë” ê°„ê²°í•œ ë°©ì‹ìœ¼ë¡œ ë¦¬íŒ©í† ë§ ê°€ëŠ¥
â†’ "NaN", "Inf", "-Inf", "+Inf"ì„ Set<String>ì— ë„£ê³  contains()ë¡œ ì²´í¬í•˜ë©´ ê°€ë…ì„± í–¥ìƒ


4. ë©”ì†Œë“œëª…ì„ ë” ëª…í™•í•˜ê²Œ ë³€ê²½
â†’ handleInvalidLatencyValues




---

âœ… ê°œì„ ëœ handleInvalidLatencyValues ë©”ì†Œë“œ

private void handleInvalidLatencyValues(FunctionMetricElementsListDTO element) {
    if (element.getData().getResult().isEmpty()) {
        return;
    }

    List<String> invalidValues = List.of("NaN", "Inf", "-Inf", "+Inf");
    String currentValue = element.getData().getResult().get(0).getValue().get(1);

    if (invalidValues.contains(currentValue)) {
        element.getData().getResult().get(0).getValue().set(1, "0");
    }
}


---

âœ¨ ê°œì„ ëœ ì 

1. ë©”ì†Œë“œëª…ì„ handleInvalidLatencyValuesë¡œ ë³€ê²½

"ì˜ëª»ëœ ê°’ì„ ì²˜ë¦¬í•œë‹¤"ëŠ” ì˜ë¯¸ë¥¼ ì§ê´€ì ìœ¼ë¡œ ì „ë‹¬



2. isEmpty()ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ì˜ í¬ê¸° ê²€ì¦

element.getData().getResult().size() > 0 ëŒ€ì‹  isEmpty()ë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ê°€ë…ì„± ë†’ì€ ì½”ë“œ ì‘ì„±



3. ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ì¡°ê±´ë¬¸ì„ ì œê±°

"NaN", "Inf", "-Inf", "+Inf"ì„ List.of()ë¡œ ì •ì˜í•˜ê³  contains()ë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ê°„ê²°í•œ ê²€ì¦ ì½”ë“œ ì‘ì„±



4. returnì„ ì¡°ê¸°ì— ì‹¤í–‰ (Early Return)

ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì¦‰ì‹œ ë°˜í™˜í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì—°ì‚°ì„ ë°©ì§€





---

ğŸ“Œ ê²°ë¡ 

ì´ì œ handleInvalidLatencyValuesëŠ” í´ë¦° ì½”ë“œ ì›ì¹™ì„ ì ìš©í•˜ì—¬ ë” ì§ê´€ì ì´ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ ì½”ë“œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ì œ ì´ ë©”ì†Œë“œë¥¼ getMetricListì™€ getCloudMonitoringMetricì—ì„œ í™œìš©í•˜ë©´ ë©ë‹ˆë‹¤.

for (FunctionMetricElementsListDTO element : metricRequest.requestLatencyList) {
    handleInvalidLatencyValues(element);
}

ì´ì œ ì½”ë“œê°€ ë” ì•ˆì •ì ì´ê³  ê°€ë…ì„±ì´ ë›°ì–´ë‚œ í˜•íƒœë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤!



ì½”ë“œ ë¦¬íŒ©í† ë§ì„ ì§„í–‰í•˜ë©° í´ë¦° ì½”ë“œ ì›ì¹™(SOLID, DRY, KISS, YAGNI ë“±)ì„ ì ìš©í•˜ê³ , ì½”ë“œì˜ ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, ì„±ëŠ¥ì„ ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤.
ì£¼ìš” ê°œì„  ì‚¬í•­ì„ ë©”ì†Œë“œ ë‹¨ìœ„ë¡œ ì„¤ëª…í•˜ê³ , ê°ê°ì˜ ë³€ê²½ ì´ìœ ë¥¼ ìƒì„¸íˆ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.


---

1. ê°œì„ ëœ ì½”ë“œ

ë³€ê²½ëœ ì½”ë“œì™€ í•¨ê»˜ ì£¼ìš” ê°œì„  ì‚¬í•­ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

(1) MetricRequest ë‚´ë¶€ í´ë˜ìŠ¤ë¥¼ staticìœ¼ë¡œ ë³€ê²½

private static class MetricRequest {
    URL url;
    String functionName;
    String queryTiming;
    Gson gson = new Gson();
    List<FunctionMetricElementsListDTO> requestCountList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> requestLatencyList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> functionMemoryList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> actualPodsList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> successCountList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> failCountList;
    String timeRange;
}

ê°œì„  ì´ìœ 

MetricRequest ë‚´ë¶€ í•„ë“œ ì´ˆê¸°í™”ë¥¼ ìƒì„±ì ì—†ì´ í•„ë“œì—ì„œ ë°”ë¡œ ìˆ˜í–‰ â†’ ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°

static í´ë˜ìŠ¤í™”í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì™¸ë¶€ í´ë˜ìŠ¤ ì°¸ì¡°ë¥¼ ë°©ì§€

gë¼ëŠ” ì• ë§¤í•œ ë³€ìˆ˜ëª…ì„ gsonìœ¼ë¡œ ëª…í™•íˆ ë³€ê²½

failCountListê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ëª…ì‹œì ìœ¼ë¡œ new ArrayList<>()ë¡œ ì´ˆê¸°í™”



---

(2) replaceNextlineTabBlank ë©”ì†Œë“œ ê°œì„ 

private String sanitizeQuery(String query) {
    return query.replaceAll("[\\n\\t ]", "");
}

ê°œì„  ì´ìœ 

ì •ê·œì‹ replaceAll("[\\n\\t ]", "")ì„ ì‚¬ìš©í•˜ì—¬ ë¶ˆí•„ìš”í•œ ê°œí–‰, ê³µë°±, íƒ­ì„ í•œ ë²ˆì— ì²˜ë¦¬ â†’ ì„±ëŠ¥ í–¥ìƒ

ë©”ì†Œë“œëª…ì„ sanitizeQueryë¡œ ë³€ê²½í•˜ì—¬ ì˜ë¯¸ ëª…í™•í™”



---

(3) PromQL ìƒì„± ë©”ì†Œë“œ ê°œì„ 

ê¸°ì¡´ ë¬¸ì œì 

1. $ë³€ìˆ˜$ ì¹˜í™˜ ë°©ì‹ì´ ìœ ì§€ë³´ìˆ˜ì— ë¶ˆë¦¬í•¨ â†’ String.format ì ìš©


2. replaceNextlineTabBlank() ë©”ì†Œë“œê°€ í•„ìš” ì´ìƒìœ¼ë¡œ í˜¸ì¶œë¨


3. &time=$queryTiming$ê°€ ëª¨ë“  ì¿¼ë¦¬ì— í¬í•¨ë˜ë¯€ë¡œ ì¤‘ë³µ ì œê±° ê°€ëŠ¥



ê°œì„ ëœ ì½”ë“œ

private String buildQuery(String baseQuery, String functionName, String timeRange, String queryTiming) {
    String query = String.format(baseQuery, functionName, timeRange);
    return sanitizeQuery(query) + "&time=" + queryTiming;
}

public String generateQueryForRequestCount(String functionName, String timeRange, String queryTiming) {
    String queryTemplate = "query=sum(rate(activator_request_count{service_name=\"%s\"}[%sm]))*60*%s";
    return buildQuery(queryTemplate, functionName, timeRange, queryTiming);
}

ê°œì„  ì´ìœ 

String.formatì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

ì¤‘ë³µëœ &time=$queryTiming$ì„ ë©”ì†Œë“œì—ì„œ ìë™ìœ¼ë¡œ ì¶”ê°€

ëª¨ë“  ì¿¼ë¦¬ ìƒì„± ë¡œì§ì„ buildQueryë¡œ í†µí•©í•˜ì—¬ ì¤‘ë³µ ì œê±°



---

(4) getPrometheusMetric ë©”ì†Œë“œ ê°œì„ 

ê¸°ì¡´ ë¬¸ì œì 

DataOutputStreamì„ êµ³ì´ ì‚¬ìš©í•  í•„ìš” ì—†ìŒ

BufferedReaderë¥¼ ê°„ê²°í•˜ê²Œ ë³€í™˜ ê°€ëŠ¥


ê°œì„ ëœ ì½”ë“œ

private String getPrometheusMetric(URL url, String query) throws IOException {
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
    connection.setConnectTimeout(timeOutValue);
    connection.setReadTimeout(timeOutValue);
    connection.setRequestMethod("POST");
    connection.setDoOutput(true);

    try (DataOutputStream outputStream = new DataOutputStream(connection.getOutputStream())) {
        outputStream.writeBytes(query);
    }

    if (connection.getResponseCode() == HttpURLConnection.HTTP_OK) {
        try (BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
            return bufferedReader.lines().reduce("", (acc, line) -> acc + line);
        }
    }
    return null;
}

ê°œì„  ì´ìœ 

try-with-resources ì‚¬ìš© â†’ ëª…ì‹œì  close() í˜¸ì¶œ ë¶ˆí•„ìš”

BufferedReader.lines().reduce() ì‚¬ìš© â†’ ê°„ê²°í•œ ì½”ë“œ êµ¬í˜„

DataOutputStreamì˜ flush() í˜¸ì¶œ ë¶ˆí•„ìš” â†’ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨



---

(5) getMetricList ë©”ì†Œë“œ ê°œì„ 

ê¸°ì¡´ ë¬¸ì œì 

MetricRequest ê°ì²´ë¥¼ ë§¤ë²ˆ ìƒì„±í•˜ëŠ”ë° ë¶ˆí•„ìš”í•œ í•„ë“œê°€ ë§ìŒ

Calendarë¥¼ ì‚¬ìš©í•˜ì—¬ Date ë³€í™˜ì„ ë°˜ë³µ â†’ Instantì™€ Durationì„ ì‚¬ìš©í•˜ë©´ ê°„ê²°í™” ê°€ëŠ¥

ì¤‘ë³µëœ ë°˜ë³µë¬¸ì„ ë©”ì†Œë“œë¡œ ë¶„ë¦¬


ê°œì„ ëœ ì½”ë“œ

public FunctionMetricListDTO getMetricList(String functionKey, String time, String start, String end) throws IOException, ParseException {
    URL url = new URL(prometheusHttpApi);
    Function function = functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new RuntimeException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‘ì…˜ì…ë‹ˆë‹¤."));
    
    MetricRequest metricRequest = new MetricRequest();
    metricRequest.url = url;
    metricRequest.functionName = function.getName();
    
    int iterationCount;
    int timeUnit;
    
    if (METRIC_TIME_RANGE_1_HOUR.equals(time)) {
        iterationCount = 3;
        timeUnit = 15;
    } else if (METRIC_TIME_RANGE_3_HOUR.equals(time)) {
        iterationCount = 5;
        timeUnit = 30;
    } else if (METRIC_TIME_RANGE_12_HOUR.equals(time)) {
        iterationCount = 3;
        timeUnit = 180;
    } else {
        iterationCount = (int) Duration.between(parseDate(start), parseDate(end)).toDays();
        timeUnit = 1440;
    }

    fetchMetrics(metricRequest, iterationCount, timeUnit);

    for (FunctionMetricElementsListDTO element : metricRequest.requestLatencyList) {
        handleInvalidLatencyValues(element);
    }

    return createMetricListResponse(metricRequest);
}

private Instant parseDate(String date) throws ParseException {
    return new SimpleDateFormat("yyyyMMdd").parse(date).toInstant();
}

private void fetchMetrics(MetricRequest metricRequest, int iterationCount, int timeUnit) throws IOException {
    metricRequest.timeRange = String.valueOf(timeUnit);
    for (int i = 0; i <= iterationCount; i++) {
        metricRequest.queryTiming = String.valueOf(Instant.now().minus(Duration.ofMinutes(timeUnit * i)).getEpochSecond());
        getEachMetricInstance(metricRequest);
    }
}

private FunctionMetricListDTO createMetricListResponse(MetricRequest metricRequest) {
    return new FunctionMetricListDTO(
            metricRequest.requestCountList,
            metricRequest.requestLatencyList,
            metricRequest.functionMemoryList,
            metricRequest.actualPodsList,
            metricRequest.successCountList,
            metricRequest.failCountList
    );
}

ê°œì„  ì´ìœ 

ë°˜ë³µë¬¸ ë¡œì§ì„ fetchMetrics ë©”ì†Œë“œë¡œ ë¶„ë¦¬ â†’ ì¤‘ë³µ ì œê±°

Calendar ëŒ€ì‹  Instantì™€ Duration ì‚¬ìš© â†’ ê°€ë…ì„± í–¥ìƒ

ì‘ë‹µ ê°ì²´ ìƒì„± ë¡œì§ì„ createMetricListResponseë¡œ ë¶„ë¦¬ â†’ SRP ì ìš©

parseDate ë©”ì†Œë“œ ì¶”ê°€ â†’ ì¤‘ë³µ ì œê±° ë° ì½”ë“œ ê°€ë…ì„± í–¥ìƒ



---

2. ìµœì¢…ì ì¸ ê°œì„  ìš”ì•½


---

ì´ì œ ì½”ë“œê°€ ë” ì§ê´€ì ì´ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ëŸ° ë¦¬íŒ©í† ë§ì´ ì‹¤ì œ ìš´ì˜ ì‹œìŠ¤í…œì—ì„œë„ ì ìš©ë  ìˆ˜ ìˆë„ë¡ ì§€ì†ì ì¸ ì½”ë“œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.

