import boto3

# ì œì™¸í•  ì„œë¹„ìŠ¤ ëª©ë¡
EXCLUDED_SERVICES = [
    "iam", "organizations", "sso", "billing", "cost-explorer", "support",
    "cloudwatch", "cloudtrail"
]

# ëª¨ë“  ë¦¬ì „ ì¡°íšŒ
regions = [region['RegionName'] for region in boto3.client('ec2').describe_regions()['Regions']]

def delete_resources(region):
    session = boto3.session.Session(region_name=region)

    # EC2 ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ
    ec2 = session.client('ec2')
    instances = ec2.describe_instances(Filters=[{'Name': 'instance-state-name', 'Values': ['running', 'stopped']}])
    instance_ids = [i["InstanceId"] for r in instances["Reservations"] for i in r["Instances"]]
    if instance_ids:
        ec2.terminate_instances(InstanceIds=instance_ids)
        print(f"[{region}] EC2 ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ: {instance_ids}")

    # S3 ë²„í‚· ì‚­ì œ
    s3 = session.client('s3')
    buckets = s3.list_buckets().get("Buckets", [])
    for bucket in buckets:
        try:
            s3.delete_bucket(Bucket=bucket["Name"])
            print(f"[{region}] S3 ë²„í‚· ì‚­ì œ: {bucket['Name']}")
        except:
            pass  # ë²„í‚·ì´ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨í•¨

    # RDS ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ
    rds = session.client('rds')
    rds_instances = rds.describe_db_instances().get("DBInstances", [])
    for db in rds_instances:
        try:
            rds.delete_db_instance(DBInstanceIdentifier=db["DBInstanceIdentifier"], SkipFinalSnapshot=True, DeleteAutomatedBackups=True)
            print(f"[{region}] RDS ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ: {db['DBInstanceIdentifier']}")
        except:
            pass

    # Lambda í•¨ìˆ˜ ì‚­ì œ
    lambda_client = session.client('lambda')
    functions = lambda_client.list_functions().get("Functions", [])
    for function in functions:
        try:
            lambda_client.delete_function(FunctionName=function["FunctionName"])
            print(f"[{region}] Lambda ì‚­ì œ: {function['FunctionName']}")
        except:
            pass

    # EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ
    eks = session.client('eks')
    clusters = eks.list_clusters().get("clusters", [])
    for cluster in clusters:
        try:
            eks.delete_cluster(name=cluster)
            print(f"[{region}] EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ: {cluster}")
        except:
            pass

    # DynamoDB í…Œì´ë¸” ì‚­ì œ
    dynamodb = session.client('dynamodb')
    tables = dynamodb.list_tables().get("TableNames", [])
    for table in tables:
        try:
            dynamodb.delete_table(TableName=table)
            print(f"[{region}] DynamoDB í…Œì´ë¸” ì‚­ì œ: {table}")
        except:
            pass

    # Load Balancer ì‚­ì œ
    elb = session.client('elbv2')
    load_balancers = elb.describe_load_balancers().get("LoadBalancers", [])
    for lb in load_balancers:
        try:
            elb.delete_load_balancer(LoadBalancerArn=lb["LoadBalancerArn"])
            print(f"[{region}] Load Balancer ì‚­ì œ: {lb['LoadBalancerName']}")
        except:
            pass

    # SNS í† í”½ ì‚­ì œ
    sns = session.client('sns')
    topics = sns.list_topics().get("Topics", [])
    for topic in topics:
        try:
            sns.delete_topic(TopicArn=topic["TopicArn"])
            print(f"[{region}] SNS í† í”½ ì‚­ì œ: {topic['TopicArn']}")
        except:
            pass

    # SQS í ì‚­ì œ
    sqs = session.client('sqs')
    queues = sqs.list_queues().get("QueueUrls", [])
    for queue in queues:
        try:
            sqs.delete_queue(QueueUrl=queue)
            print(f"[{region}] SQS í ì‚­ì œ: {queue}")
        except:
            pass

    # API Gateway ì‚­ì œ
    apigw = session.client('apigateway')
    apis = apigw.get_rest_apis().get("items", [])
    for api in apis:
        try:
            apigw.delete_rest_api(restApiId=api["id"])
            print(f"[{region}] API Gateway ì‚­ì œ: {api['name']}")
        except:
            pass

    # **ECR ë¦¬í¬ì§€í† ë¦¬ ì‚­ì œ**
    ecr = session.client('ecr')
    repositories = ecr.describe_repositories().get("repositories", [])
    for repo in repositories:
        try:
            ecr.delete_repository(repositoryName=repo["repositoryName"], force=True)
            print(f"[{region}] ECR ë¦¬í¬ì§€í† ë¦¬ ì‚­ì œ: {repo['repositoryName']}")
        except:
            pass

    # **KMS í‚¤ ì‚­ì œ (ì˜ˆì•½ ì‚­ì œ)**
    kms = session.client('kms')
    keys = kms.list_keys().get("Keys", [])
    for key in keys:
        try:
            kms.schedule_key_deletion(KeyId=key["KeyId"], PendingWindowInDays=7)
            print(f"[{region}] KMS í‚¤ ì‚­ì œ ì˜ˆì•½: {key['KeyId']}")
        except:
            pass

    print(f"[{region}] ëª¨ë“  ê³¼ê¸ˆ ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì™„ë£Œ")

# ëª¨ë“  ë¦¬ì „ì— ëŒ€í•´ ì‹¤í–‰
for region in regions:
    delete_resources(region)





ì£¼ìš” ì‘ì—… íë¦„:

ëª¨ë“  ë¦¬ì „ ì¡°íšŒ (describe_regions API ì‚¬ìš©)
ê° ë¦¬ì „ì˜ ëª¨ë“  ê³¼ê¸ˆ ìì› ì¡°íšŒ (list_*, describe_* API ì‚¬ìš©)
ê³¼ê¸ˆ ìì› ì‚­ì œ (delete_*, terminate_*, detach_* API ì‚¬ìš©)
ê²€ì¦ í›„ CloudWatch ë¡œê·¸ ë‚¨ê¸°ê¸°



Lambdaì—ì„œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ IAM, S3, Organizations, SSO, Billing, Cost Explorer, Support, CloudWatch, CloudTrailì„ ì œì™¸í•œ ëª¨ë“  ê³¼ê¸ˆë˜ëŠ” AWS ë¦¬ì†ŒìŠ¤ë¥¼ ì œê±°í•˜ëŠ” ì½”ë“œë¥¼ ìˆ˜ì •í–ˆì–´.

ìˆ˜ì •ëœ ì½”ë“œ
ì œì™¸í•  ì„œë¹„ìŠ¤ ëª©ë¡ í™•ì¥: EXCLUDED_SERVICESì— cloudwatch, cloudtrail ì¶”ê°€
ë¦¬ì†ŒìŠ¤ ì‚­ì œ ê¸°ëŠ¥ í™•ì¥:
EC2, S3 ì™¸ì—ë„ RDS, Lambda, EKS, DynamoDB, Load Balancer, SNS, SQS, API Gateway ë“± ì£¼ìš” ê³¼ê¸ˆ ì„œë¹„ìŠ¤ ì‚­ì œ
ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”: ì¼ë¶€ ì„œë¹„ìŠ¤ëŠ” ì‚­ì œì— ì œì•½ì´ ìˆìœ¼ë¯€ë¡œ ì˜ˆì™¸ ì²˜ë¦¬ ì¶”ê°€




ğŸ“Œ ì£¼ìš” ì—…ë°ì´íŠ¸ ì‚¬í•­
EC2, RDS, Lambda, EKS, DynamoDB, Load Balancer, SNS, SQS, API Gatewayê¹Œì§€ ì‚­ì œí•˜ë„ë¡ í™•ì¥
ë²„í‚·ì´ ë¹„ì–´ ìˆì§€ ì•Šì„ ê²½ìš° S3 ì‚­ì œ ì˜ˆì™¸ ì²˜ë¦¬ ì¶”ê°€
ë¦¬ì†ŒìŠ¤ ì‚­ì œ ë¡œê·¸ ì¶œë ¥
âœ… ECR ë¦¬í¬ì§€í† ë¦¬ ì‚­ì œ ì¶”ê°€
âœ… KMS í‚¤ ì‚­ì œ ì¶”ê°€ (7ì¼ í›„ ì˜ˆì•½ ì‚­ì œ)
âœ… ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì½”ë“œ ìµœì í™”



ğŸš€ Lambda + EventBridge ì„¤ì •
Lambda í•¨ìˆ˜ ìƒì„±
AWS Lambda ì½˜ì†”ì—ì„œ ìƒˆ Python Lambda í•¨ìˆ˜ë¥¼ ë§Œë“¤ê³  ìœ„ ì½”ë“œë¥¼ ì—…ë¡œë“œ

IAM ì—­í•  ì¶”ê°€

AdministratorAccess ë˜ëŠ” í•„ìš”í•œ ì„œë¹„ìŠ¤ ì‚­ì œ ê¶Œí•œì„ í¬í•¨í•œ ì—­í• ì„ ë¶€ì—¬
EventBridge ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • (ë§¤ì¼ ìì • ì‹¤í–‰)






aws events put-rule --name "DailyResourceCleanup" --schedule-expression "cron(0 0 * * ? *)"
aws lambda add-permission --function-name CleanupLambda --statement-id daily-delete --action "lambda:InvokeFunction" --principal events.amazonaws.com
aws events put-targets --rule "DailyResourceCleanup" --targets "Id"="1","Arn"="LAMBDA_ARN"


ğŸ”¥ ìµœì¢… ê¸°ëŒ€ íš¨ê³¼
âœ… ëª¨ë“  AWS ë¦¬ì „ì˜ ê³¼ê¸ˆë˜ëŠ” ì„œë¹„ìŠ¤ ìë™ ì‚­ì œ
âœ… IAM, Organizations, SSO, Billing, Cost Explorer, Support, CloudWatch, CloudTrailì€ ì œì™¸
âœ… ECR, KMSê¹Œì§€ ì‚­ì œí•˜ì—¬ ì™„ë²½í•œ ë¹„ìš© ì ˆê°
âœ… ë§¤ì¼ ìì • ìë™ ì‹¤í–‰í•˜ì—¬ AWS ë¹„ìš© ìµœì†Œí™”
