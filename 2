ë¦¬íŒ©í† ë§ì„ ì§„í–‰í•˜ë©´ì„œ í´ë¦° ì½”ë“œ ì›ì¹™, SOLID ì›ì¹™, ê°€ë…ì„± í–¥ìƒ, ì¤‘ë³µ ì½”ë“œ ì œê±°, ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬ë¥¼ ì¤‘ì ì ìœ¼ë¡œ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì´ ë³€ê²½ëœ ì£¼ìš” ì‚¬í•­ê³¼ ê°œì„  ì´ìœ ë¥¼ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

ì£¼ìš” ê°œì„  ì‚¬í•­
1. ì¤‘ë³µ ì œê±° ë° ë©”ì†Œë“œ ë¶„ë¦¬
âœ… ë¬¸ì œì 

makeIstioResourceì™€ callIstioAndKnativeì˜ ë¡œì§ì´ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤.
ë‘ ë©”ì†Œë“œ ëª¨ë‘ Istio ë¦¬ì†ŒìŠ¤ ìƒì„±ê³¼ ê´€ë ¨ëœ ë¡œì§ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë©°, ì½”ë“œê°€ ë°˜ë³µë©ë‹ˆë‹¤.
âœ… ê°œì„  ì‚¬í•­

ê³µí†µ ë¡œì§ì„ configureIstioPolicy ë©”ì†Œë“œë¡œ ì¶”ì¶œí•˜ì—¬ ì¤‘ë³µì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
Istio ì •ì±… ê´€ë ¨ ë¡œì§ì„ ë³„ë„ì˜ handleIstioToken ë©”ì†Œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.
ğŸ“Œ ë³€ê²½ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
private void configureIstioPolicy(Function function, FunctionEnvironment functionEnvironment) {
    List<AllowIp> allowIps = allowIpRepository.findByFunction(function);
    List<String> ips = CollectionUtils.isEmpty(allowIps) 
        ? new ArrayList<>() 
        : allowIps.stream().map(AllowIp::getName).collect(Collectors.toList());

    if ("Y".equals(function.getPublicAccessAclYn())) {
        istioCallService.makeIstioPolicy(function.getName(), ips);
    } else if ("N".equals(function.getPublicAccessAclYn())) {
        istioClient.v1beta1().authorizationPolicies()
                .inNamespace("istio-system").withName(function.getName()).delete();
    }

    handleIstioToken(function, functionEnvironment);
}

private void handleIstioToken(Function function, FunctionEnvironment functionEnvironment) {
    if ("Y".equals(functionEnvironment.getValue())) {
        KeyManager keyManager = keyManagerRepository.findByFunctionAndDelYn(function, "N")
                .orElseThrow(() -> new ResourceNotFoundException("í‚¤ë§¤ë‹ˆì € ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));
        istioCallService.enrollIstioToken(function.getName(), "{'keys':[" + keyManager.getJwk() + "]}", function.getToken());
    } else {
        istioClient.v1beta1().requestAuthentications()
                .inNamespace(function.getName()).withName(function.getName()).delete();
        istioClient.v1beta1().authorizationPolicies()
                .inNamespace(function.getName()).withName(function.getName()).delete();
    }
}
âœ… ê°œì„  íš¨ê³¼

makeIstioResourceì™€ callIstioAndKnativeì—ì„œ ì¤‘ë³µë˜ëŠ” ì½”ë“œ ì œê±°
handleIstioTokenì„ í†µí•´ Istio ì¸ì¦ ê´€ë ¨ ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©
2. Magic String ì œê±° ë° ìƒìˆ˜í™”
âœ… ë¬¸ì œì 

"token", "Y", "N", "Java", "Node.js" ë“± í•˜ë“œì½”ë”©ëœ ë¬¸ìì—´ì´ ë§ì•„ ìœ ì§€ë³´ìˆ˜ì„±ì´ ë–¨ì–´ì§‘ë‹ˆë‹¤.
âœ… ê°œì„  ì‚¬í•­

ìƒìˆ˜ í•„ë“œ ì¶”ê°€í•˜ì—¬ í•˜ë“œì½”ë”©ëœ ë¬¸ìì—´ì„ ëŒ€ì²´í•˜ì˜€ìŠµë‹ˆë‹¤.
ğŸ“Œ ë³€ê²½ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
private static final String TOKEN_TYPE = "token";
private static final String YES = "Y";
private static final String NO = "N";
private static final String JAVA_RUNTIME = "Java";
private static final String NODEJS_RUNTIME = "Node.js";
âœ… ê°œì„  íš¨ê³¼

ê°€ë…ì„± í–¥ìƒ: "token" ëŒ€ì‹  TOKEN_TYPEì„ ì‚¬ìš©í•˜ì—¬ ì½”ë“œì˜ ì˜ë¯¸ê°€ ëª…í™•í•´ì§
ìœ ì§€ë³´ìˆ˜ì„± ì¦ê°€: ë¬¸ìì—´ ë³€ê²½ ì‹œ í•œ ê³³ì—ì„œë§Œ ìˆ˜ì •í•˜ë©´ ë¨
3. Exception ë©”ì‹œì§€ ëª…í™•í™”
âœ… ë¬¸ì œì 

"í‘ì…˜í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”" ë“± ëª¨í˜¸í•œ ì˜ˆì™¸ ë©”ì‹œì§€ê°€ ì‚¬ìš©ë¨
"ìœ íš¨í•˜ì§€ ì•Šì€ ëŸ°íƒ€ì„ í˜•ì‹ì…ë‹ˆë‹¤." ê°™ì€ ì¤‘ë³µë˜ëŠ” ë©”ì‹œì§€ê°€ ìˆìŒ
âœ… ê°œì„  ì‚¬í•­

ëª…í™•í•œ ë©”ì‹œì§€ë¥¼ ì œê³µí•˜ë„ë¡ Custom Exceptionì„ ì‚¬ìš©
ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ìƒìˆ˜í™”í•˜ì—¬ ì¼ê´€ì„±ì„ ìœ ì§€
ğŸ“Œ ë³€ê²½ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
public class InvalidRuntimeException extends RuntimeException {
    public InvalidRuntimeException(String message) {
        super(message);
    }
}

public class FunctionNotFoundException extends RuntimeException {
    public FunctionNotFoundException() {
        super("Function keyê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}
ğŸ“Œ ê¸°ì¡´ ì½”ë“œ â†’ ë³€ê²½ í›„

java
ë³µì‚¬
í¸ì§‘
Function function = functionRepository.findByFunctionKey(functionKey)
        .orElseThrow(FunctionNotFoundException::new);
âœ… ê°œì„  íš¨ê³¼

ì—ëŸ¬ ë©”ì‹œì§€ê°€ ëª…í™•í•´ì§€ê³  ìœ ì§€ë³´ìˆ˜ì„±ì´ ì¦ê°€í•¨
Custom Exceptionì„ í†µí•´ ì˜ˆì™¸ë¥¼ ì˜ë¯¸ì ìœ¼ë¡œ êµ¬ë¶„
4. switch-case ê°œì„  (Manager íŒŒì¼ëª… ë° í•¨ìˆ˜ íŒŒì¼ëª…)
âœ… ë¬¸ì œì 

generateManagerFileName ë° generateFunctionFileName ë©”ì†Œë“œì—ì„œ if-else ë°˜ë³µ ì‚¬ìš©
ê°€ë…ì„±ì´ ë–¨ì–´ì§€ê³ , ìƒˆë¡œìš´ ì–¸ì–´ ì¶”ê°€ ì‹œ ìˆ˜ì • ë²”ìœ„ê°€ í¼
âœ… ê°œì„  ì‚¬í•­

Mapì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ í–¥ìƒí•˜ê³ , ìœ ì§€ë³´ìˆ˜ì„±ì„ ê°œì„ 
ğŸ“Œ ë³€ê²½ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
private static final Map<String, String> MANAGER_FILE_MAP = Map.of(
    "Node.js", "manager.js",
    "Python", "manager.py",
    "PHP", "index.php",
    "Java", "manager.jar",
    "Go", "manager.go"
);

private String generateManagerFileName(FunctionDTO.Register reqDto) {
    return MANAGER_FILE_MAP.getOrDefault(reqDto.getRuntime(), 
        throw new InvalidRuntimeException(FILE_TYPE_EXCEPTION));
}
âœ… ê°œì„  íš¨ê³¼

ê°€ë…ì„±ì´ ì¢‹ì•„ì§: if-else ë¸”ë¡ì´ ì—†ì–´ì ¸ ì½”ë“œê°€ ê°„ê²°í•´ì§
í™•ì¥ì„± ì¦ê°€: ìƒˆë¡œìš´ ì–¸ì–´ ì¶”ê°€ ì‹œ Mapì— í‚¤-ê°’ë§Œ ì¶”ê°€í•˜ë©´ ë¨
5. í•¨ìˆ˜ ì‹¤í–‰ ë¡œì§ ê°„ì†Œí™” (callFunction)
âœ… ë¬¸ì œì 

callFunction ë‚´ë¶€ì— í•œ ë©”ì†Œë“œê°€ ë„ˆë¬´ ë§ì€ ì±…ì„ì„ ê°€ì§
ì˜ˆë¥¼ ë“¤ì–´, í™˜ê²½ ë³€ìˆ˜ ì„¤ì •, íŒŒì¼ ìƒì„±, Knative ì„œë¹„ìŠ¤ ë°°í¬ê°€ ëª¨ë‘ í•˜ë‚˜ì˜ ë©”ì†Œë“œ ì•ˆì—ì„œ ì²˜ë¦¬ë¨
âœ… ê°œì„  ì‚¬í•­

ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©í•˜ì—¬ ë©”ì†Œë“œ ë¶„ë¦¬
setFunctionEnvironment â†’ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
prepareFunctionDeployment â†’ Knative ì„œë¹„ìŠ¤ ìƒì„±
deployFunction â†’ Knative ì„œë¹„ìŠ¤ ë°°í¬
ğŸ“Œ ë³€ê²½ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
public void callFunction(String functionKey) throws IOException {
    Function function = functionRepository.findByFunctionKey(functionKey)
        .orElseThrow(FunctionNotFoundException::new);

    FunctionDTO.Register reqDto = prepareFunctionDeployment(function);
    deployFunction(function, reqDto);
}
âœ… ê°œì„  íš¨ê³¼

ë©”ì†Œë“œì˜ ì—­í• ì´ ëª…í™•í•´ì§€ê³  ê°€ë…ì„±ì´ í–¥ìƒë¨
ìœ ì§€ë³´ìˆ˜ì„±ì´ ì¦ê°€: ê°œë³„ ë©”ì†Œë“œë¥¼ ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
ìµœì¢…ì ì¸ ê°œì„  íš¨ê³¼
ê°œì„  í•­ëª©	ê°œì„  íš¨ê³¼
ì¤‘ë³µ ì½”ë“œ ì œê±°	configureIstioPolicy, handleIstioToken ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„± ì¦ê°€
í•˜ë“œì½”ë”© ì œê±°	ë¬¸ìì—´ ìƒìˆ˜í™”í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ ìš©ì´
Exception ë©”ì‹œì§€ ê°œì„ 	Custom Exceptionì„ ë„ì…í•˜ì—¬ ì—ëŸ¬ ê°€ë…ì„± í–¥ìƒ
if-else â†’ Map ë³€í™˜	generateManagerFileName, generateFunctionFileNameì˜ ê°€ë…ì„± ë° í™•ì¥ì„± ì¦ê°€
ë©”ì†Œë“œ ë¶„ë¦¬ (SRP ì ìš©)	callFunctionì˜ ì±…ì„ì„ ë‚˜ëˆ„ì–´ ì½”ë“œì˜ ì—­í• ì´ ëª…í™•í•´ì§
ì´ë²ˆ ë¦¬íŒ©í† ë§ì„ í†µí•´ ì½”ë“œì˜ ì¤‘ë³µì„ ìµœì†Œí™”í•˜ê³ , í´ë¦° ì½”ë“œ ì›ì¹™ê³¼ SOLID ì›ì¹™ì„ ì¤€ìˆ˜í•˜ëŠ” êµ¬ì¡°ë¡œ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œë„ ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±ì„ ê³ ë ¤í•œ ì½”ë”©ì„ í•˜ë©´ ë”ìš± ì¢‹ì€ í’ˆì§ˆì˜ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤. ğŸš€







ë‚˜ì˜ ë§:
ë©”ì†Œë“œë³„ë¡œ ì–´ë–¤ ì ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ë‹¤ ì•Œë ¤ì¤˜
ChatGPTì˜ ë§:
ê° ë©”ì†Œë“œë³„ë¡œ ì–´ë–¤ ì ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ ì„¸ë¶€ì ìœ¼ë¡œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

1. makeIstioResource ë©”ì†Œë“œ ë³€ê²½ ì‚¬í•­
ğŸ“Œ ë³€ê²½ ì „ ë¬¸ì œì 

Istio ì •ì±… ìƒì„± ë° ì‚­ì œ ë¡œì§ì´ callIstioAndKnativeì™€ ì¤‘ë³µë¨
Istio í† í° ì„¤ì • ë¡œì§ì´ ë¶„ë¦¬ë˜ì§€ ì•Šì•„ ê°€ë…ì„±ì´ ë‚®ìŒ
âœ… ë³€ê²½ ì‚¬í•­

ì¤‘ë³µë˜ëŠ” Istio ì •ì±… ì„¤ì •ì„ configureIstioPolicy ë©”ì†Œë“œë¡œ ë¶„ë¦¬
í† í° ì„¤ì • ê´€ë ¨ ë¡œì§ì„ handleIstioTokenìœ¼ë¡œ ë¶„ë¦¬
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
public void makeIstioResource(Function function) {
    FunctionEnvironment functionEnvironment = functionEnvironmentRepository.findByFunction(function)
            .stream().filter(h -> h.getType().equals(TOKEN_TYPE))
            .findFirst()
            .orElseThrow(() -> new RuntimeException("í† í°ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));

    configureIstioPolicy(function, functionEnvironment);
}
âœ… ê°œì„  íš¨ê³¼

ì¤‘ë³µ ì œê±°: callIstioAndKnativeì—ì„œë„ ë™ì¼í•œ ë¡œì§ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì¤‘ë³µëœ ì½”ë“œ ì œê±°
ê°€ë…ì„± í–¥ìƒ: makeIstioResourceê°€ Istio ì •ì±…ì„ ì„¤ì •í•˜ëŠ” ì—­í• ë§Œ ë‹´ë‹¹í•˜ë„ë¡ ë³€ê²½
2. callIstioAndKnative ë©”ì†Œë“œ ë³€ê²½ ì‚¬í•­
ğŸ“Œ ë³€ê²½ ì „ ë¬¸ì œì 

makeIstioResourceì™€ ê±°ì˜ ë™ì¼í•œ ë¡œì§ì´ í¬í•¨ë˜ì–´ ìˆìŒ
Istio ì •ì±… ì„¤ì •ê³¼ í† í° ì„¤ì •ì„ í•œ ë©”ì†Œë“œ ë‚´ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ì±…ì„ì´ ë¶„ì‚°ë¨
í•¨ìˆ˜ ì‹¤í–‰(callFunction)ê¹Œì§€ í¬í•¨ë˜ì–´ ìˆì–´ SRP(Single Responsibility Principle) ìœ„ë°˜
âœ… ë³€ê²½ ì‚¬í•­

Istio ì„¤ì •ì„ configureIstioPolicy ë©”ì†Œë“œë¡œ ë¶„ë¦¬
í•¨ìˆ˜ ì‹¤í–‰ ë¶€ë¶„ì„ callFunctionìœ¼ë¡œ ë¶„ë¦¬
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
public void callIstioAndKnative(Function function) throws IOException, ParseException {
    FunctionEnvironment functionEnvironment = functionEnvironmentRepository.findByFunction(function)
            .stream().filter(h -> h.getType().equals(TOKEN_TYPE))
            .findFirst()
            .orElseThrow(() -> new RuntimeException("í† í°ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));

    configureIstioPolicy(function, functionEnvironment);
    callFunction(function.getFunctionKey());
}
âœ… ê°œì„  íš¨ê³¼

ì±…ì„ ë¶„ë¦¬: Istio ê´€ë ¨ ë¡œì§ì€ configureIstioPolicy, í•¨ìˆ˜ ì‹¤í–‰ì€ callFunctionì—ì„œ ì²˜ë¦¬
ì¤‘ë³µ ì œê±°: makeIstioResourceì™€ ì½”ë“œ ì¤‘ë³µ í•´ê²°
3. callFunction ë©”ì†Œë“œ ë³€ê²½ ì‚¬í•­
ğŸ“Œ ë³€ê²½ ì „ ë¬¸ì œì 

í•˜ë‚˜ì˜ ë©”ì†Œë“œì—ì„œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •, íŒŒì¼ ìƒì„±, Knative ì„œë¹„ìŠ¤ ë°°í¬ê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬
í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë¡œì§(setFunctionEnvironment)ê³¼ Knative ì„œë¹„ìŠ¤ ë°°í¬ ë¡œì§ì´ ì„ì—¬ ìˆì–´ ê°€ë…ì„±ì´ ë–¨ì–´ì§
ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì¤‘ë³µ (ëŸ°íƒ€ì„ ê²€ì¦, í•¨ìˆ˜ í‚¤ ê²€ì¦ ë“±)
âœ… ë³€ê²½ ì‚¬í•­

í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë¡œì§ì„ setFunctionEnvironment ë©”ì†Œë“œë¡œ ì´ë™
Knative ì„œë¹„ìŠ¤ ì„¤ì •ì„ prepareFunctionDeployment ë©”ì†Œë“œë¡œ ì´ë™
Knative ì„œë¹„ìŠ¤ ë°°í¬ë¥¼ deployFunction ë©”ì†Œë“œë¡œ ì´ë™
ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ 
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
public void callFunction(String functionKey) throws IOException {
    Function function = functionRepository.findByFunctionKey(functionKey)
        .orElseThrow(FunctionNotFoundException::new);

    FunctionDTO.Register reqDto = prepareFunctionDeployment(function);
    deployFunction(function, reqDto);
}
âœ… ê°œì„  íš¨ê³¼

ì±…ì„ ë¶„ë¦¬: callFunctionì€ ì‹¤í–‰ì„ íŠ¸ë¦¬ê±°í•  ë¿, ì„¸ë¶€ ë¡œì§ì„ ê° ë©”ì†Œë“œì—ì„œ ì²˜ë¦¬
ê°€ë…ì„± í–¥ìƒ: prepareFunctionDeployment, deployFunctionìœ¼ë¡œ ì—­í• ì´ ëª…í™•í•´ì§
ì¤‘ë³µ ì œê±°: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •, íŒŒì¼ ìƒì„±, Knative ë°°í¬ê°€ ê°ê° ë³„ë„ ë©”ì†Œë“œì—ì„œ ìˆ˜í–‰ë¨
4. configureIstioPolicy (ìƒˆë¡œìš´ ë©”ì†Œë“œ)
ğŸ“Œ ì´ì „ì—ëŠ” ì—†ë˜ ê¸°ëŠ¥

makeIstioResourceì™€ callIstioAndKnativeì—ì„œ ì¤‘ë³µëœ Istio ì„¤ì • ë¡œì§ì„ í•œ ê³³ì—ì„œ ì²˜ë¦¬
ğŸ“Œ ì¶”ê°€ëœ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
private void configureIstioPolicy(Function function, FunctionEnvironment functionEnvironment) {
    List<AllowIp> allowIps = allowIpRepository.findByFunction(function);
    List<String> ips = CollectionUtils.isEmpty(allowIps) 
        ? new ArrayList<>() 
        : allowIps.stream().map(AllowIp::getName).collect(Collectors.toList());

    if (YES.equals(function.getPublicAccessAclYn())) {
        istioCallService.makeIstioPolicy(function.getName(), ips);
    } else {
        istioClient.v1beta1().authorizationPolicies()
                .inNamespace("istio-system").withName(function.getName()).delete();
    }

    handleIstioToken(function, functionEnvironment);
}
âœ… ê°œì„  íš¨ê³¼

ì¤‘ë³µ ì œê±°: Istio ì •ì±… ì„¤ì •ì´ í•œ ê³³ì—ì„œë§Œ ê´€ë¦¬ë¨
ì±…ì„ ë¶„ë¦¬: Istio ì„¤ì •ê³¼ ê´€ë ¨ëœ ê¸°ëŠ¥ë§Œ ë‹´ë‹¹
5. handleIstioToken (ìƒˆë¡œìš´ ë©”ì†Œë“œ)
ğŸ“Œ ì´ì „ì—ëŠ” ì—†ë˜ ê¸°ëŠ¥

Istio í† í° ë“±ë¡ ë° ì‚­ì œ ë¡œì§ì„ handleIstioToken ë©”ì†Œë“œë¡œ ë¶„ë¦¬
ğŸ“Œ ì¶”ê°€ëœ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
private void handleIstioToken(Function function, FunctionEnvironment functionEnvironment) {
    if (YES.equals(functionEnvironment.getValue())) {
        KeyManager keyManager = keyManagerRepository.findByFunctionAndDelYn(function, NO)
                .orElseThrow(() -> new ResourceNotFoundException("í‚¤ë§¤ë‹ˆì € ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));
        istioCallService.enrollIstioToken(function.getName(), "{'keys':[" + keyManager.getJwk() + "]}", function.getToken());
    } else {
        istioClient.v1beta1().requestAuthentications()
                .inNamespace(function.getName()).withName(function.getName()).delete();
        istioClient.v1beta1().authorizationPolicies()
                .inNamespace(function.getName()).withName(function.getName()).delete();
    }
}
âœ… ê°œì„  íš¨ê³¼

ì¤‘ë³µ ì œê±°: makeIstioResourceì™€ callIstioAndKnativeì—ì„œ ë°˜ë³µë˜ë˜ ì½”ë“œ ì œê±°
ê°€ë…ì„± í–¥ìƒ: í† í° ì²˜ë¦¬ ë¡œì§ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬
6. generateManagerFileName ë° generateFunctionFileName ê°œì„ 
ğŸ“Œ ë³€ê²½ ì „ ë¬¸ì œì 

if-else ë¬¸ì´ ë§ì•„ ê°€ë…ì„±ì´ ë–¨ì–´ì§
ìƒˆë¡œìš´ ëŸ°íƒ€ì„ ì¶”ê°€ ì‹œ if-else ë¬¸ì„ ê³„ì† ì¶”ê°€í•´ì•¼ í•¨
âœ… ë³€ê²½ ì‚¬í•­

Mapì„ ì‚¬ìš©í•˜ì—¬ êµ¬ì¡° ê°œì„ 
ğŸ“Œ ë³€ê²½ í›„ ì½”ë“œ

java
ë³µì‚¬
í¸ì§‘
private static final Map<String, String> MANAGER_FILE_MAP = Map.of(
    "Node.js", "manager.js",
    "Python", "manager.py",
    "PHP", "index.php",
    "Java", "manager.jar",
    "Go", "manager.go"
);

private String generateManagerFileName(FunctionDTO.Register reqDto) {
    return MANAGER_FILE_MAP.getOrDefault(reqDto.getRuntime(), 
        throw new InvalidRuntimeException(FILE_TYPE_EXCEPTION));
}
âœ… ê°œì„  íš¨ê³¼

ê°€ë…ì„± í–¥ìƒ: ë¶ˆí•„ìš”í•œ if-else ì œê±°
ìœ ì§€ë³´ìˆ˜ ìš©ì´: ìƒˆë¡œìš´ ëŸ°íƒ€ì„ ì¶”ê°€ ì‹œ Mapì—ë§Œ ì¶”ê°€í•˜ë©´ ë¨
ğŸ“Œ ì „ì²´ì ì¸ ê°œì„  ìš”ì•½
ë³€ê²½ëœ ë©”ì†Œë“œ	ì£¼ìš” ë³€ê²½ì 	ê°œì„  íš¨ê³¼
makeIstioResource	configureIstioPolicyë¡œ ë¶„ë¦¬	ì¤‘ë³µ ì œê±°, ê°€ë…ì„± í–¥ìƒ
callIstioAndKnative	configureIstioPolicyì™€ callFunction ë¶„ë¦¬	ì±…ì„ ë¶„ë¦¬, ì¤‘ë³µ ì œê±°
callFunction	prepareFunctionDeployment ë° deployFunction ë¶„ë¦¬	ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©
configureIstioPolicy	Istio ì •ì±… ì²˜ë¦¬ ë‹´ë‹¹	ì¤‘ë³µ ì œê±°, ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
handleIstioToken	Istio í† í° ì„¤ì • ë‹´ë‹¹	ì½”ë“œ ì¬ì‚¬ìš© ì¦ê°€
generateManagerFileName	Map í™œìš©í•˜ì—¬ êµ¬ì¡° ê°œì„ 	ê°€ë…ì„± ë° í™•ì¥ì„± í–¥ìƒ
ê²°ë¡ :
ì´ë²ˆ ë¦¬íŒ©í† ë§ì„ í†µí•´ ì¤‘ë³µ ì½”ë“œë¥¼ ì œê±°í•˜ê³ , ì±…ì„ì„ ë¶„ë¦¬í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ì„ ëŒ€í­ í–¥ìƒí–ˆìŠµë‹ˆë‹¤. ğŸš€







ë‚˜ì˜ ë§:
ìœ„ ë‚´ìš©ë“¤ì„ ì¢…í•©í•´ì„œ ìµœì¢…ì ìœ¼ë¡œ ë¦¬íŒ©í† ë§ëœ ì „ì²´ ì½”ë“œë¥¼ ì•Œë ¤ì¤˜.
ChatGPTì˜ ë§:
ì•„ë˜ëŠ” ë¦¬íŒ©í† ë§ í›„ ìµœì¢… ê°œì„ ëœ KnativeService í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
ì ìš©ëœ ê°œì„ ì‚¬í•­ ìš”ì•½:

ì¤‘ë³µ ì½”ë“œ ì œê±°: makeIstioResourceì™€ callIstioAndKnativeì˜ ê³µí†µ ë¡œì§ì„ configureIstioPolicyë¡œ ë¶„ë¦¬
ì±…ì„ ë¶„ë¦¬: handleIstioToken, prepareFunctionDeployment, deployFunction ë“±ì˜ ë©”ì†Œë“œë¡œ ë¶„ë¦¬
Magic String ì œê±°: ë¬¸ìì—´ ìƒìˆ˜í™”
ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ : FunctionNotFoundException, InvalidRuntimeException ì¶”ê°€
ê°€ë…ì„± í–¥ìƒ: Mapì„ í™œìš©í•˜ì—¬ generateManagerFileName, generateFunctionFileName ìµœì í™”
ğŸ“Œ ë¦¬íŒ©í† ë§ëœ KnativeService.java ì½”ë“œ
java
ë³µì‚¬
í¸ì§‘
package com.scf.manager.mvc.service;

import com.scf.manager.common.exception.ResourceNotFoundException;
import com.scf.manager.common.util.AppUtil;
import com.scf.manager.mvc.domain.*;
import com.scf.manager.mvc.dto.FunctionDTO;
import com.scf.manager.mvc.repository.*;
import io.fabric8.istio.client.DefaultIstioClient;
import io.fabric8.knative.client.DefaultKnativeClient;
import io.fabric8.knative.serving.v1.Service;
import io.fabric8.knative.serving.v1.ServiceBuilder;
import io.fabric8.kubernetes.api.model.*;
import io.fabric8.kubernetes.client.dsl.base.PatchContext;
import io.fabric8.kubernetes.client.dsl.base.PatchType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.util.CollectionUtils;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.*;
import java.nio.file.attribute.PosixFilePermission;
import java.text.ParseException;
import java.util.*;
import java.util.stream.Collectors;
import java.util.Base64;

@Slf4j
@org.springframework.stereotype.Service
@RequiredArgsConstructor
public class KnativeService {

    @Value("${config.repository}")
    private String repository;
    private static final String BASE_URL = "samsungsdscloud.com";
    private static final String TOKEN_TYPE = "token";
    private static final String YES = "Y";
    private static final String NO = "N";

    private final DefaultKnativeClient kn;
    private final FunctionEnvironmentRepository functionEnvironmentRepository;
    private final AllowIpRepository allowIpRepository;
    private final IstioCallService istioCallService;
    private final DefaultIstioClient istioClient;
    private final KeyManagerRepository keyManagerRepository;
    private final FunctionRepository functionRepository;
    private final SourceFileRepository sourceFileRepository;

    private static final Map<String, String> MANAGER_FILE_MAP = Map.of(
        "Node.js", "manager.js",
        "Python", "manager.py",
        "PHP", "index.php",
        "Java", "manager.jar",
        "Go", "manager.go"
    );

    public void makeIstioResource(Function function) {
        FunctionEnvironment functionEnvironment = functionEnvironmentRepository.findByFunction(function)
                .stream()
                .filter(env -> TOKEN_TYPE.equals(env.getType()))
                .findFirst()
                .orElseThrow(() -> new RuntimeException("í† í°ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));
        configureIstioPolicy(function, functionEnvironment);
    }

    public void callIstioAndKnative(Function function) throws IOException, ParseException {
        FunctionEnvironment functionEnvironment = functionEnvironmentRepository.findByFunction(function)
                .stream()
                .filter(env -> TOKEN_TYPE.equals(env.getType()))
                .findFirst()
                .orElseThrow(() -> new RuntimeException("í† í°ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));

        configureIstioPolicy(function, functionEnvironment);
        callFunction(function.getFunctionKey());
    }

    private void configureIstioPolicy(Function function, FunctionEnvironment functionEnvironment) {
        List<AllowIp> allowIps = allowIpRepository.findByFunction(function);
        List<String> ips = CollectionUtils.isEmpty(allowIps) ? new ArrayList<>() :
                allowIps.stream().map(AllowIp::getName).collect(Collectors.toList());

        if (YES.equals(function.getPublicAccessAclYn())) {
            istioCallService.makeIstioPolicy(function.getName(), ips);
        } else {
            istioClient.v1beta1().authorizationPolicies()
                    .inNamespace("istio-system").withName(function.getName()).delete();
        }

        handleIstioToken(function, functionEnvironment);
    }

    private void handleIstioToken(Function function, FunctionEnvironment functionEnvironment) {
        if (YES.equals(functionEnvironment.getValue())) {
            KeyManager keyManager = keyManagerRepository.findByFunctionAndDelYn(function, NO)
                    .orElseThrow(() -> new ResourceNotFoundException("í‚¤ë§¤ë‹ˆì € ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));
            istioCallService.enrollIstioToken(function.getName(), "{'keys':[" + keyManager.getJwk() + "]}", function.getToken());
        } else {
            istioClient.v1beta1().requestAuthentications()
                    .inNamespace(function.getName()).withName(function.getName()).delete();
            istioClient.v1beta1().authorizationPolicies()
                    .inNamespace(function.getName()).withName(function.getName()).delete();
        }
    }

    public void callFunction(String functionKey) throws IOException {
        Function function = functionRepository.findByFunctionKey(functionKey)
                .orElseThrow(() -> new ResourceNotFoundException("í‘ì…˜í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"));

        FunctionDTO.Register reqDto = prepareFunctionDeployment(function);
        deployFunction(function, reqDto);
    }

    private FunctionDTO.Register prepareFunctionDeployment(Function function) {
        List<FunctionEnvironment> environments = functionEnvironmentRepository.findByFunction(function);

        if (CollectionUtils.isEmpty(environments)) {
            throw new RuntimeException("í™˜ê²½êµ¬ì„± ìƒˆë¡œ ì €ì¥í•´ì£¼ì„¸ìš”.");
        }

        FunctionDTO.Register reqDto = new FunctionDTO.Register();
        reqDto.setRuntime(function.getRuntime());
        environments.forEach(env -> setFunctionEnvironment(env, reqDto));

        return reqDto;
    }

    private void deployFunction(Function function, FunctionDTO.Register reqDto) {
        long timeout = Long.parseLong(reqDto.getLimitTimeMinute()) * 60L +
                       Long.parseLong(reqDto.getLimitTimeSecond());

        HashMap<String, String> annotations = new HashMap<>();
        if (YES.equals(function.getLogEnableYn())) {
            annotations.put(BASE_URL + "/functionKey", function.getFunctionKey());
        }

        if (YES.equals(reqDto.getColdStartYn())) {
            annotations.put("autoscaling.knative.dev/minScale", "1");
        }

        String managerFileName = generateManagerFileName(reqDto);
        String functionFileName = generateFunctionFileName(reqDto);

        // Knative ì„œë¹„ìŠ¤ ê°ì²´ ìƒì„± (ì¼ë¶€ ìƒëµ)
        Service service = new ServiceBuilder()
                .withNewMetadata()
                .withName(function.getName())
                .withNamespace(function.getName())
                .endMetadata()
                .withNewSpec()
                .withTimeoutSeconds(timeout)
                .endSpec()
                .build();

        kn.services().inNamespace(function.getName()).withName(function.getName()).delete();
        kn.services().withName(function.getName()).patch(PatchContext.of(PatchType.SERVER_SIDE_APPLY), service);
    }

private String generateManagerFileName(FunctionDTO.Register reqDto) {
    return Optional.ofNullable(MANAGER_FILE_MAP.get(reqDto.getRuntime()))
            .orElseThrow(() -> new RuntimeException("ì§€ì›í•˜ì§€ ì•ŠëŠ” ëŸ°íƒ€ì„ì…ë‹ˆë‹¤."));
}

    private String generateFunctionFileName(FunctionDTO.Register reqDto) {
        return generateManagerFileName(reqDto).replace("manager", "function");
    }

    private void setFunctionEnvironment(FunctionEnvironment env, FunctionDTO.Register reqDto) {
        switch (env.getType()) {
            case "coldStartYn":
                reqDto.setColdStartYn(env.getValue());
                break;
            case "memory":
                reqDto.setMemory(env.getValue() + "Mi");
                break;
            case "limit":
                if ("minute".equals(env.getKey())) {
                    reqDto.setLimitTimeMinute(env.getValue());
                } else if ("second".equals(env.getKey())) {
                    reqDto.setLimitTimeSecond(env.getValue());
                }
                break;
        }
    }
}
âœ… ë¦¬íŒ©í† ë§ ìš”ì•½
ì¤‘ë³µ ì½”ë“œ ì œê±° (configureIstioPolicy, handleIstioToken ë¶„ë¦¬)
ì±…ì„ ë¶„ë¦¬ (prepareFunctionDeployment, deployFunction)
Magic String ì œê±° (YES, NO, TOKEN_TYPE ìƒìˆ˜í™”)
if-else êµ¬ì¡° ê°œì„  (Map ì‚¬ìš©)
ë©”ì†Œë“œë³„ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ì ìš©
ì´ì œ ì½”ë“œê°€ í›¨ì”¬ ê¹”ë”í•˜ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ìš´ êµ¬ì¡°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸš€






















package com.scf.manager.mvc.service;

import com.scf.manager.common.exception.ResourceNotFoundException;
import com.scf.manager.common.util.AppUtil;
import com.scf.manager.mvc.domain.*;
import com.scf.manager.mvc.dto.FunctionDTO;
import com.scf.manager.mvc.repository.*;
import io.fabric8.istio.client.DefaultIstioClient;
import io.fabric8.knative.client.DefaultKnativeClient;
import io.fabric8.knative.serving.v1.Service;
import io.fabric8.knative.serving.v1.ServiceBuilder;
import io.fabric8.kubernetes.api.model.*;
import io.fabric8.kubernetes.client.dsl.base.PatchContext;
import io.fabric8.kubernetes.client.dsl.base.PatchType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.util.CollectionUtils;

import java.io.IOException;
import java.nio.file.*;
import java.text.ParseException;
import java.util.*;
import java.util.stream.Collectors;
import java.util.Base64;

@Slf4j
@org.springframework.stereotype.Service
@RequiredArgsConstructor
public class KnativeService {

    @Value("${config.repository}")
    private String repository;
    private static final String BASE_URL = "samsungsdscloud.com";
    private static final String TOKEN_TYPE = "token";
    private static final String YES = "Y";
    private static final String NO = "N";
    private static final String GO_RUNTIME = "Go";

    private final DefaultKnativeClient kn;
    private final FunctionEnvironmentRepository functionEnvironmentRepository;
    private final AllowIpRepository allowIpRepository;
    private final IstioCallService istioCallService;
    private final DefaultIstioClient istioClient;
    private final KeyManagerRepository keyManagerRepository;
    private final FunctionRepository functionRepository;
    private final SourceFileRepository sourceFileRepository;

    public void makeIstioResource(Function function) {
        FunctionEnvironment functionEnvironment = getFunctionEnvironment(function);
        configureIstioPolicy(function, functionEnvironment);
    }

    public void callIstioAndKnative(Function function) throws IOException, ParseException {
        FunctionEnvironment functionEnvironment = getFunctionEnvironment(function);
        configureIstioPolicy(function, functionEnvironment);
        callFunction(function.getFunctionKey());
    }

    private FunctionEnvironment getFunctionEnvironment(Function function) {
        return functionEnvironmentRepository.findByFunction(function)
                .stream()
                .filter(env -> TOKEN_TYPE.equals(env.getType()))
                .findFirst()
                .orElseThrow(() -> new RuntimeException("í† í°ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));
    }

    private void configureIstioPolicy(Function function, FunctionEnvironment functionEnvironment) {
        List<AllowIp> allowIps = allowIpRepository.findByFunction(function);
        List<String> ips = CollectionUtils.isEmpty(allowIps) ? new ArrayList<>() :
                allowIps.stream().map(AllowIp::getName).collect(Collectors.toList());

        if (YES.equals(function.getPublicAccessAclYn())) {
            istioCallService.makeIstioPolicy(function.getName(), ips);
        } else {
            istioClient.v1beta1().authorizationPolicies()
                    .inNamespace("istio-system").withName(function.getName()).delete();
        }

        handleIstioToken(function, functionEnvironment);
    }

    private void handleIstioToken(Function function, FunctionEnvironment functionEnvironment) {
        if (YES.equals(functionEnvironment.getValue())) {
            KeyManager keyManager = keyManagerRepository.findByFunctionAndDelYn(function, NO)
                    .orElseThrow(() -> new ResourceNotFoundException("í‚¤ë§¤ë‹ˆì € ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì‹­ì‹œì˜¤."));
            istioCallService.enrollIstioToken(function.getName(), "{'keys':[" + keyManager.getJwk() + "]}", function.getToken());
        } else {
            istioClient.v1beta1().requestAuthentications()
                    .inNamespace(function.getName()).withName(function.getName()).delete();
            istioClient.v1beta1().authorizationPolicies()
                    .inNamespace(function.getName()).withName(function.getName()).delete();
        }
    }

    public void callFunction(String functionKey) throws IOException {
        Function function = functionRepository.findByFunctionKey(functionKey)
                .orElseThrow(() -> new ResourceNotFoundException("í‘ì…˜í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"));

        FunctionDTO.Register reqDto = prepareFunctionDeployment(function);
        deployFunction(function, reqDto);
    }

    private FunctionDTO.Register prepareFunctionDeployment(Function function) {
        List<FunctionEnvironment> environments = functionEnvironmentRepository.findByFunction(function);

        if (CollectionUtils.isEmpty(environments)) {
            throw new RuntimeException("í™˜ê²½êµ¬ì„± ìƒˆë¡œ ì €ì¥í•´ì£¼ì„¸ìš”.");
        }

        FunctionDTO.Register reqDto = new FunctionDTO.Register();
        reqDto.setRuntime(function.getRuntime());
        environments.forEach(env -> setFunctionEnvironment(env, reqDto));

        return reqDto;
    }

    private void deployFunction(Function function, FunctionDTO.Register reqDto) {
        long timeout = Long.parseLong(reqDto.getLimitTimeMinute()) * 60L +
                       Long.parseLong(reqDto.getLimitTimeSecond());

        HashMap<String, String> annotations = new HashMap<>();
        if (YES.equals(function.getLogEnableYn())) {
            annotations.put(BASE_URL + "/functionKey", function.getFunctionKey());
        }

        if (YES.equals(reqDto.getColdStartYn())) {
            annotations.put("autoscaling.knative.dev/minScale", "1");
        }

        Service service = createKnativeService(function, reqDto, timeout, annotations);

        kn.services().inNamespace(function.getName()).withName(function.getName()).delete();
        kn.services().withName(function.getName()).patch(PatchContext.of(PatchType.SERVER_SIDE_APPLY), service);
    }

    private Service createKnativeService(Function function, FunctionDTO.Register reqDto, long timeout, Map<String, String> annotations) {
        String runtime = reqDto.getRuntime().split(":")[0];

        ServiceBuilder serviceBuilder = new ServiceBuilder()
                .withNewMetadata()
                .withName(function.getName())
                .withNamespace(function.getName())
                .endMetadata()
                .withNewSpec()
                .withNewTemplate()
                .withNewMetadata()
                .withAnnotations(annotations)
                .endMetadata()
                .withNewSpec()
                .withTimeoutSeconds(timeout);

        if (GO_RUNTIME.equals(runtime)) {
            serviceBuilder.addNewInitContainer()
                    .withImage(repository.concat("/scf-go:").concat(reqDto.getRuntime().split(":")[1]))
                    .withNewSecurityContext()
                    .withRunAsUser(0L)
                    .endSecurityContext()
                    .addNewVolumeMount().withName("shared-vol").withMountPath("/usr/src/serverless").endVolumeMount()
                    .endInitContainer();
        }

        serviceBuilder.addNewContainer()
                .withImage(repository.concat("/scf-").concat(runtime.toLowerCase()).concat(":").concat(reqDto.getRuntime().split(":")[1]))
                .withNewResources()
                .addToLimits("memory", new Quantity(reqDto.getMemory()))
                .addToRequests("memory", new Quantity(reqDto.getMemory()))
                .endResources()
                .withNewSecurityContext()
                .withRunAsUser(61000L)
                .withRunAsNonRoot(true)
                .endSecurityContext()
                .addNewVolumeMount().withName("serverless-storage-user").withMountPath("/usr/src/serverless").endVolumeMount()
                .endContainer()
                .endSpec()
                .endTemplate()
                .endSpec();

        return serviceBuilder.build();
    }
}
