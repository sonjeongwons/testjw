ë¦¬íŒ©í† ë§ê³¼ í´ë¦°ì½”ë“œ ê´€ì ì—ì„œì˜ ë¦¬ë·° ì½”ë©˜íŠ¸


---

1. initializeApiConfig ë©”ì„œë“œ

private void initializeApiConfig(String endpointUrl, String accessKey, String secretKey, String projectId, String masterKey) {
    this.kmsApiBaseUri = endpointUrl;
    this.accessKey = accessKey;
    this.accessSecretKey = secretKey;
    this.method = "POST";
    this.headerProjectId = projectId;
    this.headerClientType = "OpenApi";
    this.keyName = masterKey; // masterKeyëŠ” nullì¼ ìˆ˜ ìˆìŒ.
}

ì½”ë©˜íŠ¸:

ì´ ë©”ì„œë“œëŠ” API ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ëŠ” ì—­í• ì„ ì˜ ìˆ˜í–‰í•˜ê³  ìˆë„¤ìš”! ğŸ‘ ë‹¨, masterKeyê°€ nullì¼ ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ëª…í™•íˆ í•˜ê¸° ìœ„í•´ JavaDoc ì£¼ì„ì„ ì¶”ê°€í•˜ë©´ ë” ì¢‹ì„ ê²ƒ ê°™ì•„ìš”.

ë˜í•œ, String ëŒ€ì‹  Optional<String>ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ null ì²˜ë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë‹¤ë£° ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì˜ˆì‹œ ì½”ë“œ:

private void initializeApiConfig(String endpointUrl, String accessKey, String secretKey, String projectId, Optional<String> masterKey) {
    this.kmsApiBaseUri = endpointUrl;
    this.accessKey = accessKey;
    this.accessSecretKey = secretKey;
    this.method = "POST";
    this.headerProjectId = projectId;
    this.headerClientType = "OpenApi";
    this.keyName = masterKey.orElse(null); // masterKeyê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ ì²˜ë¦¬
}


---

2. callKmsApi ë©”ì„œë“œ

private JSONObject callKmsApi(String endpointTemplate, JSONObject payload) throws Exception {
    String endpoint = String.format(endpointTemplate, keyName);
    String url = kmsApiBaseUri + endpoint;
    String timestamp = String.valueOf(System.currentTimeMillis());
    String signature = generateHmacSignature(url, timestamp);

    return performHttpPost(url, payload.toJSONString(), buildHeaders(timestamp, signature));
}

ì½”ë©˜íŠ¸:

API í˜¸ì¶œ ë¡œì§ì´ ê¹”ë”í•˜ê²Œ ë¶„ë¦¬ë˜ì–´ ìˆì–´ ì¢‹ìŠµë‹ˆë‹¤! ğŸ‘

ê·¸ëŸ¬ë‚˜ String.formatê³¼ keyName ì˜ì¡´ì„±ì„ ì¤„ì´ê¸° ìœ„í•´ URI ë¹Œë”ë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë“œì˜ ê°€ë…ì„±ê³¼ í™•ì¥ì„±ì´ ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì˜ˆì‹œ ì½”ë“œ:

private JSONObject callKmsApi(String endpointTemplate, JSONObject payload) throws Exception {
    String url = UriComponentsBuilder.fromUriString(kmsApiBaseUri)
        .path(endpointTemplate)
        .buildAndExpand(keyName)
        .toUriString();

    String timestamp = String.valueOf(System.currentTimeMillis());
    String signature = generateHmacSignature(url, timestamp);

    return performHttpPost(url, payload.toJSONString(), buildHeaders(timestamp, signature));
}


---

3. generateHmacSignature ë©”ì„œë“œ

private String generateHmacSignature(String url, String timestamp) {
    try {
        String body = method + url + timestamp + accessKey + headerProjectId + headerClientType;
        byte[] message = body.getBytes(StandardCharsets.UTF_8);
        byte[] secretKey = accessSecretKey.getBytes(StandardCharsets.UTF_8);

        Mac mac = Mac.getInstance("HmacSHA256");
        mac.init(new SecretKeySpec(secretKey, "HmacSHA256"));
        return encodeBase64(mac.doFinal(message));
    } catch (Exception e) {
        throw new RuntimeException("Failed to calculate HMAC-SHA256 signature", e);
    }
}

ì½”ë©˜íŠ¸:

HMAC ìƒì„± ë¡œì§ì´ ëª…í™•í•˜ê³  ê°„ê²°í•©ë‹ˆë‹¤. ğŸ‘Œ ë‹¤ë§Œ, generateHmacSignatureê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë¥¼ ë‹¤ë£¨ëŠ”ì§€ ì•Œê¸° ì–´ë µê¸° ë•Œë¬¸ì— ë©”ì„œë“œ ì´ë¦„ì„ ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, createHmacSha256Signatureì²˜ëŸ¼ìš”.

ë˜í•œ, Exceptionì„ RuntimeExceptionìœ¼ë¡œ ë˜í•‘í•˜ëŠ” ëŒ€ì‹ , ë” êµ¬ì²´ì ì¸ ì‚¬ìš©ì ì •ì˜ ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´ ë””ë²„ê¹…ì— ë” ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



---

4. transferEnvEncrypt ë©”ì„œë“œ

public String transferEnvEncrypt(DataKeyDTO.envEncrpyt reqDto, String functionKey) throws Exception {
    initializeApiConfig(reqDto.getEndpointUrl(), reqDto.getAccessKey(), reqDto.getSecretKey(), reqDto.getProjectId(), reqDto.getMasterKey());
    Map<String, String> envelope = buildEncryptionEnvelope(reqDto, functionKey);
    return encryptWithKey(convertMapToJson(envelope), scfEncryptKey);
}

ì½”ë©˜íŠ¸:

ê¸°ëŠ¥ì´ ì˜ ë¶„ë¦¬ë˜ì–´ ìˆì–´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±ì´ ë†’ì•„ ë³´ì…ë‹ˆë‹¤! íŠ¹íˆ buildEncryptionEnvelopeì™€ ê°™ì€ ë©”ì„œë“œë¡œ ë¡œì§ì´ ë‚˜ëˆ ì§„ ì ì´ í›Œë¥­í•©ë‹ˆë‹¤. ğŸ‰

í•˜ì§€ë§Œ transferEnvEncryptë¼ëŠ” ì´ë¦„ì€ "ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•œë‹¤"ëŠ” í–‰ìœ„ë¥¼ ì •í™•íˆ ë‚˜íƒ€ë‚´ì§€ ëª»í•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë” ëª…í™•í•œ ì´ë¦„ìœ¼ë¡œ encryptEnvironmentVariablesë¥¼ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.

ë˜, ë§ˆì§€ë§‰ì— encryptWithKey ë©”ì„œë“œê°€ í˜¸ì¶œë˜ëŠ”ë°, ì•”í˜¸í™” ì‹¤íŒ¨ ì‹œì˜ ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì—†ì–´ì„œ ì´ë¥¼ ì²˜ë¦¬í•  ì˜ˆì™¸ í•¸ë“¤ë§ ë¡œì§ì„ ì¶”ê°€í•˜ë©´ ì•ˆì „í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.



---

5. performHttpPost ë©”ì„œë“œ

private JSONObject performHttpPost(String url, String body, Map<String, String> headers) throws Exception {
    HttpsURLConnection connection = null;
    try {
        URL endpoint = new URL(url);
        connection = (HttpsURLConnection) endpoint.openConnection();
        connection.setRequestMethod("POST");
        connection.setDoOutput(true);
        headers.forEach(connection::setRequestProperty);

        try (OutputStream os = connection.getOutputStream()) {
            os.write(body.getBytes(StandardCharsets.UTF_8));
        }

        int responseCode = connection.getResponseCode();
        InputStream responseStream = (responseCode == 200)
                ? connection.getInputStream()
                : connection.getErrorStream();

        return (JSONObject) new JSONParser().parse(new InputStreamReader(responseStream, StandardCharsets.UTF_8));
    } finally {
        if (connection != null) connection.disconnect();
    }
}

ì½”ë©˜íŠ¸:

HTTP ìš”ì²­ ì²˜ë¦¬ë¥¼ ë§¤ìš° ê¹”ë”í•˜ê²Œ êµ¬í˜„í•˜ì…¨ìŠµë‹ˆë‹¤. ğŸŒŸ

ê·¸ëŸ¬ë‚˜, ì‘ë‹µ ì½”ë“œê°€ 200ì´ ì•„ë‹Œ ê²½ìš°ì˜ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ë©”ì„œë“œ ë‚´ë¶€ì—ì„œ í•œ ë²ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´, ìƒìœ„ í˜¸ì¶œ ë©”ì„œë“œì—ì„œ ì˜ˆì™¸ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ì‘ë‹µ ì½”ë“œê°€ 4xx ë˜ëŠ” 5xxì¼ ê²½ìš°, ì‚¬ìš©ì ì •ì˜ ì˜ˆì™¸ë¥¼ ë˜ì§€ëŠ” ë°©ì‹ë„ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì˜ˆì‹œ ì½”ë“œ:

if (responseCode >= 400) {
    throw new HttpClientErrorException(responseCode, "Error response received: " + responseCode);
}


---

ì¹­ì°¬ ë° ì œì•ˆ

1. ì¹­ì°¬: ë©”ì„œë“œê°€ ëª…í™•í•˜ê²Œ ë¶„ë¦¬ë˜ì–´ ìˆì–´ì„œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì´ ë§¤ìš° ë›°ì–´ë‚©ë‹ˆë‹¤. ğŸ‘


2. ì œì•ˆ: ì£¼ìš” ë¡œì§ì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë©”ì„œë“œ(initializeApiConfig, buildHeaders)ëŠ” ìƒìœ„ í´ë˜ìŠ¤ë‚˜ ìœ í‹¸ í´ë˜ìŠ¤ë¡œ ì¶”ì¶œí•˜ë©´ ì¬ì‚¬ìš©ì„±ì„ ë”ìš± ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


3. ë§ˆì§€ë§‰ìœ¼ë¡œ: ì´ë²ˆ ë¦¬íŒ©í† ë§ì´ ì½”ë“œì˜ ì•ˆì „ì„±ê³¼ ê°€ë…ì„±ì„ ëª¨ë‘ í–¥ìƒì‹œí‚¬ ê²ƒìœ¼ë¡œ í™•ì‹ í•©ë‹ˆë‹¤. ë©‹ì§„ ì‘ì—…ì´ì—ìš”! ğŸ˜Š




---

Q1. generateHmacSignature ë©”ì„œë“œì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ë” ì„¸ë¶„í™”í•˜ë ¤ë©´ ì–´ë–¤ ë°©ë²•ì´ ìˆì„ê¹Œ?

Q2. performHttpPost ë©”ì„œë“œì— íƒ€ì„ì•„ì›ƒ ì„¤ì •ì„ ì¶”ê°€í•˜ë©´ ì–´ë–¤ ì¥ì ì´ ìˆì„ê¹Œ?

Q3. ê³µí†µ ì„¤ì • ë©”ì„œë“œë¥¼ ìƒìœ„ í´ë˜ìŠ¤ë¡œ ì¶”ì¶œí•˜ë©´ ì–´ë–¤ êµ¬ì¡°ì ì¸ ì´ì ì´ ìˆì„ê¹Œ?

