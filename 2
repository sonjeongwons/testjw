Pull Request: FunctionMetricService ë¦¬íŒ©í† ë§ ë° ì½”ë“œ í’ˆì§ˆ ê°œì„ 

ğŸ“Œ PR ê°œìš”

ì´ë²ˆ PRì—ì„œëŠ” FunctionMetricService í´ë˜ìŠ¤ì˜ ì½”ë“œ í’ˆì§ˆì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ ë¦¬íŒ©í† ë§ì„ ìˆ˜í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.
í´ë¦° ì½”ë“œ ì›ì¹™ (SOLID, DRY, KISS, YAGNI) ì„ ì ìš©í•˜ì—¬ ì¤‘ë³µ ì œê±°, ê°€ë…ì„± í–¥ìƒ, ì„±ëŠ¥ ê°œì„ , ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒì„ ëª©í‘œë¡œ ê°œì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

ğŸ›  ê°œë°œ ë‚´ìš©

1. ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ê³µí†µ ë¡œì§ ë¶„ë¦¬

PromQLì„ ìƒì„±í•˜ëŠ” ì½”ë“œì—ì„œ ê³µí†µ íŒ¨í„´ì„ ì¶”ì¶œí•˜ì—¬ buildQuery ë©”ì†Œë“œë¥¼ ë„ì…

Prometheus API í˜¸ì¶œ ì½”ë“œì—ì„œ ë¶ˆí•„ìš”í•œ ìì› ê´€ë¦¬ ë° ì¤‘ë³µ ì½”ë“œ ì œê±°



2. ë¶ˆí•„ìš”í•œ ê°ì²´ ë° ë³€ìˆ˜ ì œê±°

MetricRequest ë‚´ë¶€ í´ë˜ìŠ¤ì—ì„œ ë¶ˆí•„ìš”í•œ í•„ë“œ ë° ì´ˆê¸°í™” ì½”ë“œ ì •ë¦¬



3. ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

ë¶ˆí•„ìš”í•œ replaceNextlineTabBlank ë©”ì†Œë“œ ì œê±° ë° ì •ê·œì‹ ì ìš©

RequestLatencyMetricInvalidValueHandlingì„ handleInvalidLatencyValuesë¡œ ë³€ê²½í•˜ì—¬ ì´ë¦„ì„ ëª…í™•í™”



4. ì„±ëŠ¥ ìµœì í™”

BufferedReader.lines()ë¥¼ í™œìš©í•˜ì—¬ ì‘ë‹µ ì²˜ë¦¬ ì†ë„ ê°œì„ 

Calendar ëŒ€ì‹  Instantì™€ Durationì„ ì‚¬ìš©í•˜ì—¬ ì‹œê°„ ê³„ì‚° ë¡œì§ ë‹¨ìˆœí™”





---

ğŸ” ë©”ì†Œë“œë³„ ë³€ê²½ì ê³¼ ê°œì„ ì‚¬í•­

1ï¸âƒ£ MetricRequest í´ë˜ìŠ¤ ë¦¬íŒ©í† ë§

ë³€ê²½ ë‚´ìš©

private static class MetricRequest {
    URL url;
    String functionName;
    String queryTiming;
    Gson gson = new Gson();
    List<FunctionMetricElementsListDTO> requestCountList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> requestLatencyList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> functionMemoryList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> actualPodsList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> successCountList = new ArrayList<>();
    List<FunctionMetricElementsListDTO> failCountList = new ArrayList<>();
    String timeRange;
}

ê°œì„  ì‚¬í•­

ë‚´ë¶€ í´ë˜ìŠ¤ë¥¼ staticìœ¼ë¡œ ì„ ì–¸í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì™¸ë¶€ ì°¸ì¡° ë°©ì§€

failCountList ì´ˆê¸°í™” ì¶”ê°€ (new ArrayList<>())

Gson ê°ì²´ë¥¼ í•„ë“œ ì´ˆê¸°í™”ì—ì„œ ë°”ë¡œ ìƒì„± (gson ë³€ìˆ˜ëª… ëª…í™•í™”)



---

2ï¸âƒ£ replaceNextlineTabBlank â†’ sanitizeQueryë¡œ ë³€ê²½

ë³€ê²½ ë‚´ìš©

private String sanitizeQuery(String query) {
    return query.replaceAll("[\\n\\t ]", "");
}

ê°œì„  ì‚¬í•­

ê¸°ì¡´ ë°©ì‹ (replace("\n", "").replace("\t", "").replace(" ", "")) ëŒ€ì‹  ì •ê·œì‹ replaceAll("[\\n\\t ]", "") ì ìš©

ì½”ë“œ ê°€ë…ì„±ê³¼ ì„±ëŠ¥ ê°œì„ 

ë©”ì†Œë“œëª…ì„ sanitizeQueryë¡œ ë³€ê²½í•˜ì—¬ ëª…í™•í•œ ì˜ë¯¸ ì „ë‹¬



---

3ï¸âƒ£ PromQL ì¿¼ë¦¬ ìƒì„± ë¡œì§ ê°œì„  (buildQuery ì¶”ê°€)

ë³€ê²½ ë‚´ìš©

private String buildQuery(String baseQuery, String functionName, String timeRange, String queryTiming) {
    String query = String.format(baseQuery, functionName, timeRange);
    return sanitizeQuery(query) + "&time=" + queryTiming;
}

public String generateQueryForRequestCount(String functionName, String timeRange, String queryTiming) {
    String queryTemplate = "query=sum(rate(activator_request_count{service_name=\"%s\"}[%sm]))*60*%s";
    return buildQuery(queryTemplate, functionName, timeRange, queryTiming);
}

ê°œì„  ì‚¬í•­

String.formatì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

ê³µí†µ íŒ¨í„´ì„ buildQueryë¡œ ë¶„ë¦¬í•˜ì—¬ ì½”ë“œ ì¤‘ë³µ ì œê±°

ëª¨ë“  ì¿¼ë¦¬ì— ë°˜ë³µì ìœ¼ë¡œ ë¶™ë˜ &time=$queryTiming$ì„ ë©”ì†Œë“œ ë‚´ë¶€ì—ì„œ ìë™ ì¶”ê°€



---

4ï¸âƒ£ Prometheus API í˜¸ì¶œ ìµœì í™” (getPrometheusMetric ê°œì„ )

ë³€ê²½ ë‚´ìš©

private String getPrometheusMetric(URL url, String query) throws IOException {
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
    connection.setConnectTimeout(timeOutValue);
    connection.setReadTimeout(timeOutValue);
    connection.setRequestMethod("POST");
    connection.setDoOutput(true);

    try (DataOutputStream outputStream = new DataOutputStream(connection.getOutputStream())) {
        outputStream.writeBytes(query);
    }

    if (connection.getResponseCode() == HttpURLConnection.HTTP_OK) {
        try (BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
            return bufferedReader.lines().reduce("", (acc, line) -> acc + line);
        }
    }
    return null;
}

ê°œì„  ì‚¬í•­

try-with-resources ì ìš© â†’ ëª…ì‹œì  close() í˜¸ì¶œ ë¶ˆí•„ìš”

BufferedReader.lines().reduce()ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°„ê²°í•œ ì½”ë“œ êµ¬í˜„

ë¶ˆí•„ìš”í•œ flush() í˜¸ì¶œ ì œê±° â†’ try-with-resourcesì—ì„œ ìë™ ì²˜ë¦¬



---

5ï¸âƒ£ getMetricList ë¦¬íŒ©í† ë§

ë³€ê²½ ë‚´ìš©

public FunctionMetricListDTO getMetricList(String functionKey, String time, String start, String end) throws IOException, ParseException {
    URL url = new URL(prometheusHttpApi);
    Function function = functionRepository.findByFunctionKey(functionKey)
            .orElseThrow(() -> new RuntimeException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‘ì…˜ì…ë‹ˆë‹¤."));
    
    MetricRequest metricRequest = new MetricRequest();
    metricRequest.url = url;
    metricRequest.functionName = function.getName();
    
    int iterationCount;
    int timeUnit;
    
    if (METRIC_TIME_RANGE_1_HOUR.equals(time)) {
        iterationCount = 3;
        timeUnit = 15;
    } else if (METRIC_TIME_RANGE_3_HOUR.equals(time)) {
        iterationCount = 5;
        timeUnit = 30;
    } else if (METRIC_TIME_RANGE_12_HOUR.equals(time)) {
        iterationCount = 3;
        timeUnit = 180;
    } else {
        iterationCount = (int) Duration.between(parseDate(start), parseDate(end)).toDays();
        timeUnit = 1440;
    }

    fetchMetrics(metricRequest, iterationCount, timeUnit);

    for (FunctionMetricElementsListDTO element : metricRequest.requestLatencyList) {
        handleInvalidLatencyValues(element);
    }

    return createMetricListResponse(metricRequest);
}

ê°œì„  ì‚¬í•­

ë°˜ë³µë¬¸ ë¡œì§ì„ fetchMetrics ë©”ì†Œë“œë¡œ ë¶„ë¦¬ â†’ ì¤‘ë³µ ì œê±°

Calendar ëŒ€ì‹  Instantì™€ Duration ì‚¬ìš© â†’ ê°€ë…ì„± í–¥ìƒ

ì‘ë‹µ ê°ì²´ ìƒì„± ë¡œì§ì„ createMetricListResponseë¡œ ë¶„ë¦¬ â†’ SRP ì ìš©

parseDate ë©”ì†Œë“œ ì¶”ê°€ â†’ ì¤‘ë³µ ì œê±° ë° ì½”ë“œ ê°€ë…ì„± í–¥ìƒ



---

6ï¸âƒ£ handleInvalidLatencyValues ì¶”ê°€

ë³€ê²½ ë‚´ìš©

private void handleInvalidLatencyValues(FunctionMetricElementsListDTO element) {
    if (element.getData().getResult().isEmpty()) {
        return;
    }

    List<String> invalidValues = List.of("NaN", "Inf", "-Inf", "+Inf");
    String currentValue = element.getData().getResult().get(0).getValue().get(1);

    if (invalidValues.contains(currentValue)) {
        element.getData().getResult().get(0).getValue().set(1, "0");
    }
}

ê°œì„  ì‚¬í•­

isEmpty()ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ì˜ í¬ê¸° ê²€ì¦ â†’ ê°€ë…ì„± í–¥ìƒ

"NaN", "Inf", "-Inf", "+Inf" ê°’ì„ List.of()ë¡œ ë³€í™˜í•˜ì—¬ contains() ì²´í¬ â†’ ë” ê°„ê²°í•œ ì½”ë“œ ì‘ì„±

Early Return ì ìš© â†’ ë¶ˆí•„ìš”í•œ ì—°ì‚° ë°©ì§€



---

ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

âœ… ì¤‘ë³µ ì½”ë“œ ì œê±°
âœ… ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
âœ… API í˜¸ì¶œ ìµœì í™”ë¡œ ì„±ëŠ¥ ê°œì„ 
âœ… ë¦¬íŒ©í† ë§ì„ í†µí•´ ë” ì•ˆì •ì ì¸ ì½”ë“œ êµ¬í˜„

ì´ë²ˆ PRì„ í†µí•´ FunctionMetricServiceì˜ í’ˆì§ˆì„ ê°œì„ í•˜ì˜€ìœ¼ë©°, ì´í›„ ìœ ì§€ë³´ìˆ˜ ë¹„ìš©ì´ ì ˆê°ë  ê²ƒìœ¼ë¡œ ê¸°ëŒ€ë©ë‹ˆë‹¤. ğŸš€

